"use strict";angular.module("main.glsl.cache",[]).run(["$templateCache",function(a){a.put("glsl/WmoShader.glsl","//https://www.khronos.org/registry/webgl/extensions/WEBGL_draw_buffers/\n//For drawbuffers in glsl of webgl you need to use GL_EXT_draw_buffers instead of WEBGL_draw_buffers\n\n#ifdef ENABLE_DEFERRED\n#ifdef GL_EXT_draw_buffers\n    #extension GL_EXT_draw_buffers: require\n    #extension OES_texture_float_linear : enable\n    #define drawBuffersIsSupported 1\n#endif\n#endif\n\n#ifdef COMPILING_VS\n/* vertex shader code */\nattribute vec3 aPosition;\nattribute vec3 aNormal;\nattribute vec2 aTexCoord;\nattribute vec4 aColor;\n\nuniform mat4 uLookAtMat;\nuniform mat4 uPMatrix;\nuniform mat4 uPlacementMat;\n\nvarying vec2 vTexCoord;\nvarying vec4 vColor;\n\n#ifdef drawBuffersIsSupported\nvarying vec3 vNormal;\nvarying vec3 vPosition;\n#endif\n\nvoid main() {\n    vec4 worldPoint = vec4(normalize(aNormal),0);\n    worldPoint = uPlacementMat * vec4(aPosition, 1);\n\n    vTexCoord = aTexCoord;\n    vColor = aColor;\n\n#ifndef drawBuffersIsSupported\n    gl_Position = uPMatrix * uLookAtMat * worldPoint;\n#else\n    gl_Position = worldPoint;\n\n    vNormal = normalize((uPlacementMat * vec4(aNormal, 0)).xyz);\n    vPosition = worldPoint.xyz;\n#endif //drawBuffersIsSupported\n\n}\n#endif //COMPILING_VS\n\n#ifdef COMPILING_FS\n\nprecision lowp float;\nvarying vec3 vNormal;\nvarying vec2 vTexCoord;\nvarying vec4 vColor;\nvarying vec3 vPosition;\n\n//uniform vec4  uGlobalLighting;\nuniform float uAlphaTest;\nuniform sampler2D uTexture;\n\nvoid main() {\n    vec4 tex = texture2D(uTexture, vTexCoord).rgba;\n\n    vec4 finalColor = vec4(\n        (tex.r * vColor.b) ,\n        (tex.g * vColor.g) ,\n        (tex.b * vColor.r) ,\n        tex.a);\n\n    if(finalColor.a < uAlphaTest)\n        discard;\n\n    //Apply global lighting\n/*\n    finalColor = vec4(\n        (finalColor.r + uGlobalLighting.r) ,\n        (finalColor.g + uGlobalLighting.g) ,\n        (finalColor.b + uGlobalLighting.b) ,\n        finalColor.a);\n  */\n    finalColor.a = 1.0; //do I really need it now?\n\n#ifndef drawBuffersIsSupported\n    //Forward rendering without lights\n    gl_FragColor = finalColor;\n#else\n    //Deferred rendering\n    gl_FragData[0] = finalColor;\n    gl_FragData[1] = vec4(vPosition.xyz,0);\n    gl_FragData[2] = vec4(vNormal.xyz,0);\n#endif //drawBuffersIsSupported\n}\n\n#endif //COMPILING_FS\n"),a.put("glsl/adtShader.glsl",'#ifdef COMPILING_VS\n/* vertex shader code */\nattribute float aHeight;\nattribute float aIndex;\nattribute vec2 aTexCoord;\n\nuniform vec3 aPos;\nuniform mat4 uLookAtMat;\nuniform mat4 uPMatrix;\n\nvarying vec2 vChunkCoords;\n\nconst float UNITSIZE = 533.333333333 / 16.0 / 8.0;\n\nvoid main() {\n\n/*\n     Y\n  X  0    1    2    3    4    5    6    7    8\n        9   10   11   12   13   14   15   16\n*/\n    float iX = mod(aIndex, 17.0);\n    float iY = floor(aIndex/17.0);\n\n    vec4 worldPoint = vec4(\n        aPos.x - iY * UNITSIZE,\n        aPos.y - iX * UNITSIZE,\n        aPos.z + aHeight,\n        1);\n\n    vChunkCoords = vec2(iX, iY);\n\n    //On Intel Graphics ">" is equal to ">="\n    if (iX > 8.1) {\n        worldPoint.y = aPos.y - (iX - 8.5) * UNITSIZE;\n        worldPoint.y = aPos.x - (iY + 0.5) * UNITSIZE;\n        vChunkCoords.x = (iX-8.5);\n    }\n\n    gl_Position = uPMatrix * uLookAtMat * worldPoint;\n}\n#endif //COMPILING_VS\n\n#ifdef COMPILING_FS\nprecision lowp float;\n\nvarying vec2 vChunkCoords;\n\nuniform int uNewFormula;\n\nuniform sampler2D layer0;\nuniform sampler2D layer1;\nuniform sampler2D layer2;\nuniform sampler2D layer3;\nuniform sampler2D alphaTexture;\n\n\nvoid main() {\n    vec2 vTexCoord = vChunkCoords;\n\n    vec2 a4Coords = vec2(3.0/4.0+ vChunkCoords.x/4.0/8.0, vChunkCoords.y/8.0 );\n    vec2 a3Coords = vec2(2.0/4.0+ vChunkCoords.x/4.0/8.0, vChunkCoords.y/8.0 );\n    vec2 a2Coords = vec2(1.0/4.0+ vChunkCoords.x/4.0/8.0, vChunkCoords.y/8.0 );\n\n    vec3 tex4 = texture2D(layer3, vTexCoord).rgb;\n    float a4 = texture2D(alphaTexture, a4Coords).a;\n\n    vec3 tex3 = texture2D(layer2, vTexCoord).rgb;\n    float a3 = texture2D(alphaTexture, a3Coords).a;\n\n    vec3 tex2 = texture2D(layer1, vTexCoord).rgb;\n    float a2 = texture2D(alphaTexture, a2Coords).a;\n    //float a2 = 0.3;\n\n    vec3 tex1 = texture2D(layer0, vTexCoord).rgb;\n    //vec4 a1 = texture2D(uTexture, vTexCoord).rgba;\n\n    //Mix formula for 4 texture mixing\n    vec4 finalColor;\n    if (uNewFormula >= 1) {\n        finalColor = vec4(tex1 * (1.0 - (a2 + a3 + a4)) + tex2 * a2 + tex3 * a3 + tex4* a4, 1);\n    } else {\n        finalColor = vec4(a4 * tex4 - (a4  - 1.0) * ( (a3 - 1.0)*( tex1 * (a2 - 1.0) - a2*tex2) + a3*tex3), 1);\n    }\n\n    finalColor.a = 1.0;\n    gl_FragColor = finalColor;\n}\n\n#endif //COMPILING_FS'),a.put("glsl/drawBBShader.glsl","#ifdef COMPILING_VS\n/* vertex shader code */\nattribute vec3 aPosition;\n\nuniform vec3 uBBScale;\nuniform vec3 uBBCenter;\n\nuniform mat4 uLookAtMat;\nuniform mat4 uPMatrix;\n\nvoid main() {\n    vec4 worldPoint = vec4(\n        aPosition.x*uBBScale.x + uBBCenter.x,\n        aPosition.y*uBBScale.y + uBBCenter.y,\n        aPosition.z*uBBScale.z + uBBCenter.z,\n    1);\n\n    gl_Position = uPMatrix * uLookAtMat * worldPoint;\n}\n#endif //COMPILING_VS\n\n#ifdef COMPILING_FS\n\nprecision lowp float;\nvoid main() {\n    vec4 finalColor = vec4(0.027, 0.643, 0.075, 1.0);\n\n    finalColor.a = 1.0; //do I really need it now?\n    gl_FragColor = finalColor;\n}\n\n#endif //COMPILING_FS\n")}]),function(a,b,c){var d=angular.module("main.app",["main.services.config","main.services.dbc.map","main.services.map.adtLoader","main.services.map.wdtLoader","main.services.map.wmoLoader","main.services.map.blpLoader","main.services.map.mdxLoader","main.services.map.skinLoader","main.glsl.cache","main.directives.wowJsRender"]);d.controller("UrlChooserCtrl",["$scope","configService",function(a,b){a.isReadyForStart=!1,a.params={},a.params.urlForLoading=b.getUrlToLoadWoWFile(),a.startApplication=function(){b.setUrlToLoadWoWFile(a.params.urlForLoading),a.isReadyForStart=!0}}]),d.config(["$provide","$httpProvider",function(a,b){a.factory("myHttpInterceptor",["$window","$q","$templateCache",function(a,b,c){return{request:function(a){if(a.url){var b=a.url.indexOf(".glsl"),d=b>-1;d?a.cache=c:a.params||(a.params={})}return a}}}]),b.interceptors.push("myHttpInterceptor")}]),d.run(["mapDBC","adtLoader","wdtLoader","wmoLoader","wmoGroupLoader","mdxLoader","skinLoader","blpLoader","$log",function(a,b,c,d,e,f,g,h,i){}])}(window,jQuery),function(a,b,c){var d=angular.module("main.directives.wowJsRender",["js.wow.render.scene"]);d.directive("wowJsRender",["$log","$timeout","$interval","$window","scene","adtLoader",function(a,b,d,e,f,g){return{restrict:"E",template:'<div class=""><canvas width = "1024" height = "768" ></canvas><div>camera = ( {{cameraVecs.cameraVec3[0]}}, {{cameraVecs.cameraVec3[1]}}, {{cameraVecs.cameraVec3[2]}} )</div><div>lookAt = ( {{cameraVecs.lookAtVec3[0]}}, {{cameraVecs.lookAtVec3[1]}}, {{cameraVecs.lookAtVec3[2]}} )</div></div>',link:function(a,b,d){var g=b.find("canvas")[0],h=new f(g),i=c,j=function(){var b=(new Date).getTime(),d=0;i!==c&&(d=b-i),i=b;var f=h.draw(d);a.cameraVecs=f,e.requestAnimationFrame(j)};e.requestAnimationFrame(j),e.setInterval(function(){a.$digest()},200),h.loadMap("Expansion01",22,35),h.setCameraPos(-1663,5098,27)}}}])}(window,jQuery),function(a,b,c){var d=angular.module("main.services.chunkedLoader",["main.services.fileReadHelper"]);d.factory("chunkedLoader",["configService","fileReadHelper","$http","$q","$log",function(a,b,d,e,f){return function(f){var g=e.defer(),h=a.getUrlToLoadWoWFile()+f;return d.get(h,{responseType:"arraybuffer"}).success(function(a){var d=b(a),e=null,f={getFileSize:function(){return d.getLength()},setSectionReaders:function(a){e=a},processChunkAtOffsWithSize:function(a,b,c){var d=this.loadChunkAtOffset(a,b);this.processChunk(d,c)},processChunkAtOffs:function(a,b){var c=this.loadChunkAtOffset(a);this.processChunk(c,b)},processChunk:function(a,b){var c=e.getHandler(a.chunkIdent);if(c)if("function"==typeof c)c(b,a,this);else for(var d=c[a.chunkIdent](b,a),f=this.loadChunkAtOffset(a.chunkOffset+d.offs);""!=f.chunkIdent;){var g=c.subChunks[f.chunkIdent];g&&g(b,f,this),f=this.loadChunkAtOffset(f.nextChunkOffset)}},processFile:function(a){for(var b=this.loadChunkAtOffset(0);""!=b.chunkIdent;)this.processChunk(b,a,e),b=this.loadChunkAtOffset(b.nextChunkOffset)},loadChunkAtOffset:function(e,f){var g={offs:e},h="",i=0,j=-1;g.offs+8<d.getLength()&&(h=d.reverseStr(d.readString(g,4)),i=d.readInt32(g),f!=c&&(i=f),j=g.offs);var k=null;i>0&&(k=b(a,g.offs,i));var l={chunkIdent:h,chunkLen:i,chunkOffset:e,chunkDataOffset:j,nextChunkOffset:e+8+i};return l.__proto__=k,l}};g.resolve(f)}).error(function(){g.reject()}),g.promise}}])}(jQuery,window),function(a,b,c){var d=angular.module("main.services.config",[]);d.factory("configService",[function(){var a="/get/",b=localStorage.getItem("urlForLoading");return b&&(a=b),{getUrlToLoadWoWFile:function(){return a},setUrlToLoadWoWFile:function(b){a=b,localStorage.setItem("urlForLoading",b)}}}])}(jQuery,window),function(a,b,c){var d=angular.module("main.services.dbc.map",["main.services.dbcLoader"]);d.factory("mapDBC",["loadDBC","$q",function(a,b){var d;return function(){var e=b.defer();if(d===c){var f=a("DBFilesClient/Map.dbc");f.then(function(a){d={};for(var b=0;b<a.getRowCount();b++){var c={};c.id=a.readInt32(b,0),c.mapName=a.readText(b,1),c.wdtName=a.readText(b,5),d[c.id]=c}e.resolve(d)},function(a){e.reject()})}else e.resolve(d);return e.promise}}])}(window,jQuery),function(a,b,c){var d=angular.module("main.services.dbcLoader",["main.services.config"]);d.factory("loadDBC",["configService","fileReadHelper","$http","$q",function(a,b,c,d){return function(e){var f=d.defer(),g=a.getUrlToLoadWoWFile()+e,h=20;return c.get(g,{responseType:"arraybuffer"}).success(function(a){function c(a,b){var c=h+a*(4*j)+4*b;return{offs:c}}function d(a,b){var d=c(a,b),f=e.readUint32(d),g=m+f;return g}var e=b(a),g={offs:0},i=(e.readString(g,4),e.readInt32(g)),j=e.readInt32(g),k=e.readInt32(g),l=e.readInt32(g),m=h+i*(4*j),n={fileSize:a.byteLength,getRowCount:function(){return i},getColCount:function(){return j},getRowSize:function(){return k},readInt32:function(a,b){var d=c(a,b);return e.readInt32(d,!0)},readUInt32:function(a,b){var d=c(a,b);return e.readUint32(d,!0)},readText:function(a,b){var c=d(a,b);return e.readString(c,l)}};f.resolve(n)}).error(function(){f.reject(null)}),f.promise}}])}(jQuery,window),function(a,b,c){var d=angular.module("main.services.fileReadHelper",["main.services.config"]);d.factory("fileReadHelper",["$log",function(a){function b(a){var b,c="";for(b=a.length-1;b>=0;b--)c+=a.charAt(b);return c}var c=!0,d=new TextDecoder("utf-8");return function(a,e,f){var g;g=e&&f?new DataView(a,e,f):new DataView(a);var h;return h=e&&f?new Uint8Array(a,e,f):new Uint8Array(a),{getLength:function(){return h.length},readInt8:function(a){var b=g.getInt8(a.offs);return a.offs+=1,b},readInt16:function(a){var b=g.getInt16(a.offs,c);return a.offs+=2,b},readInt32:function(a){var b=g.getInt32(a.offs,c);return a.offs+=4,b},readUint8:function(a){var b=g.getUint8(a.offs);return a.offs+=1,b},readUint16:function(a){var b=g.getUint16(a.offs,c);return a.offs+=2,b},readUint32:function(a){var b=g.getUint32(a.offs,c);return a.offs+=4,b},readFloat32:function(a){var b=g.getFloat32(a.offs,c);return a.offs+=4,b},readFloat64:function(a){var b=g.getFloat64(a.offs,c);return a.offs+=8,b},readVector3f:function(a){var b={};return b.x=this.readFloat32(a),b.y=this.readFloat32(a),b.z=this.readFloat32(a),b},readVector2f:function(a){var b={};return b.x=this.readFloat32(a),b.y=this.readFloat32(a),b},readQuaternion:function(a){var b={};return b.imag=this.readVector3f(a),b.real=this.readFloat32(a),b},readUint8Array:function(a,b){for(var c=new Uint8Array(b),d=0;b>d;d++)c[d]=this.readUint8(a);return c},readInt8Array:function(a,b){for(var c=new Int8Array(b),d=0;b>d;d++)c[d]=this.readInt8(a);return c},readUint16Array:function(a,b){for(var c=[],d=0;b>d;d++)c[d]=this.readUint16(a);return c},readInt32Array:function(a,b){for(var c=[],d=0;b>d;d++)c[d]=this.readInt32(a);return c},readFloat32Array:function(a,b){for(var c=[],d=0;b>d;d++)c[d]=this.readFloat32(a);return c},readString:function(a,b){function c(a,b,c,d){for(var e=c;d>e;e++)if(a[e]==b)return e;return d}var e=a.offs,f=c(h,0,e,e+b),g=d.decode(h.subarray(e,f));return a.offs=f,g},readNZTString:function(a,b){var c=a.offs,e=c+b,f=d.decode(h.subarray(c,e));return a.offs=e,f},reverseStr:function(a){return b(a)}}}}])}(window,jQuery),function(a,b,c){var d=angular.module("main.services.linedFileLoader",["main.services.fileReadHelper"]);d.factory("linedFileLoader",["configService","fileReadHelper","$http","$q","$log",function(a,b,d,e,f){return function(g){var h=e.defer(),i=a.getUrlToLoadWoWFile()+g;return d.get(i,{responseType:"arraybuffer"}).success(function(a){function d(){this.loadDataAtOffset=function(c,d){return b(a,c,d)},this.readType=function(a,b,d,e){var g,h=this,i=b.type;switch(i){case"int8":g=a.readInt8(d);break;case"int16":g=a.readInt16(d);break;case"int32":g=a.readInt32(d);break;case"uint8":g=a.readUint8(d);break;case"uint16":g=a.readUint16(d);break;case"uint32":g=a.readUint32(d);break;case"int32Array":g=a.readInt32Array(d,e);break;case"uint8Array":g=a.readUint8Array(d,e);break;case"uint16Array":g=a.readUint16Array(d,e);break;case"vector3f":g=a.readVector3f(d);break;case"float32":g=a.readFloat32(d);break;case"string":g=e!=c?a.readNZTString(d,e):a.readString(d,9999);break;case"ablock":g={},g.interpolation_type=a.readUint16(d),g.global_sequence=a.readUint16(d);var j=a.readUint32(d),k=a.readInt32Array(d,j);g.timestampsPerAnimation=[],g.timestampsPerAnimation.length=j;for(var l=0;j>l;l++){g.timestampsPerAnimation[l]=[];var m={offs:k[l]},n=a.readUint32(m);g.timestampsPerAnimation[l].length=n;for(var o=0;n>o;o++){var p=a.readUint32(m);g.timestampsPerAnimation[l][o]=a.readUint32({offs:p})}}var q=a.readUint32(d),r=a.readInt32Array(d,q);g.valuesPerAnimation=[],g.valuesPerAnimation.length=q;for(var l=0;q>l;l++){g.valuesPerAnimation[l]=[];var m={offs:r[l]},s=a.readUint32(m);g.valuesPerAnimation[l].length=s;for(var o=0;s>o;o++){var t=a.readUint32(m);g.valuesPerAnimation[l][o]=h.readType(a,{type:b.valType},{offs:t})}}break;case"layout":var u=b.layout,v={};if(!u instanceof Array)throw"layout is not array";for(var l=0;l<u.length;l++){var w=u[l].name;v[w]=this.parseSectionDefinition(v,u[l],a,d)}return v;default:f.info("Unknown type in layout. type = ",i)}return g},this.parseSectionDefinition=function(a,b,d,e){var f;f="string"==typeof b.offset?a[b.offset]:b.offset;var g=b.len;"string"==typeof b.len?g=a[g]:"function"==typeof b.len&&(g=b.len(a)),e&&f?e={offs:f}:f?e={offs:f}:e||(e={offs:0});var h,i=[],j=1,k=b.count!==c;k&&(j=a[b.count]);for(var l=0;j>l;l++)h=this.readType(d,b,e,g),i.push(h);var m;return m=k?i:i[0]}}var e=b(a);d.prototype=e;var g=new d;h.resolve(g)}).error(function(){h.reject()}),h.promise}}])}(window,jQuery),function(a,b,c){var d=angular.module("main.services.map.adtLoader",["main.services.linedFileLoader"]);d.factory("adtLoader",["chunkedLoader","fileReadHelper","$log","$q",function(a,b,c,d){return function(c){function e(){var a={MVER:function(a,b){if("MVER"!==b.chunkIdent)throw"Got bad group ADT file "+c;b.readInt32({offs:0})},MHDR:function(a,b,c){var d={offs:0},e=(b.readUint32(d),b.readUint32(d)),f=b.readUint32(d),g=b.readUint32(d),h=b.readUint32(d),i=b.readUint32(d),j=b.readUint32(d),k=b.readUint32(d),l=b.readUint32(d);b.readUint32(d),b.readUint32(d),b.readUint32(d),b.readUint32(d),b.readUint32(d),b.readUint32(d),b.readUint32(d);c.processChunkAtOffs(b.chunkDataOffset+e,a),c.processChunkAtOffs(b.chunkDataOffset+f,a),c.processChunkAtOffs(b.chunkDataOffset+g,a),c.processChunkAtOffs(b.chunkDataOffset+h,a),c.processChunkAtOffs(b.chunkDataOffset+i,a),c.processChunkAtOffs(b.chunkDataOffset+j,a),c.processChunkAtOffs(b.chunkDataOffset+k,a),c.processChunkAtOffs(b.chunkDataOffset+l,a),b.nextChunkOffset=c.getFileSize()},MCIN:function(a,b,c){for(var d={offs:0},e=[],f=0;256>f;f++){var g={};g.offsetMCNK=b.readUint32(d),g.size=b.readUint32(d),g.flags=b.readUint32(d),g.asyncId=b.readUint32(d);var h={};c.processChunkAtOffs(g.offsetMCNK,h),e.push(h)}a.mcnkObjs=e},MCNK:function(a,b,c){var d={offs:0};a.flags=b.readUint32(d),a.ix=b.readUint32(d),a.iy=b.readUint32(d),a.nLayers=b.readUint32(d),a.nDoodadRefs=b.readUint32(d);var e=b.readUint32(d),f=b.readUint32(d),g=b.readUint32(d),h=(b.readUint32(d),b.readUint32(d));a.sizeAlpha=b.readUint32(d);b.readUint32(d);a.sizeShadow=b.readUint32(d),a.areaid=b.readUint32(d),a.nMapObjRefs=b.readUint32(d),a.holes=b.readUint32(d),a.s1=b.readUint16(d),a.s2=b.readUint16(d),a.d1=b.readUint32(d),a.d2=b.readUint32(d),a.d3=b.readUint32(d),a.predTex=b.readUint32(d);b.readUint32(d),b.readUint32(d),b.readUint32(d),b.readUint32(d),b.readUint32(d);a.pos=b.readVector3f(d),a.textureId=b.readUint32(d),a.props=b.readUint32(d),a.effectId=b.readUint32(d),c.processChunkAtOffs(b.chunkOffset+e,a),c.processChunkAtOffs(b.chunkOffset+f,a),c.processChunkAtOffs(b.chunkOffset+g,a),c.processChunkAtOffsWithSize(b.chunkOffset+h,a.sizeAlpha,a)},MCVT:function(a,b,c){var d={offs:0},e=b.readFloat32Array(d,145);a.heights=e},MCNR:function(a,b,c){for(var d={offs:0},e=[],f=0;145>f;f++){var g=b.readInt8(d)/127,h=b.readInt8(d)/127,i=b.readInt8(d)/127;e.push(g),e.push(h),e.push(i)}a.normales=e},MCLY:function(a,b,c){for(var d={offs:0},e=b.chunkLen>>4,f=[],g=0;e>g;g++){var h={};h.textureID=b.readInt32(d),h.flags=b.readInt32(d),h.alphaMap=b.readInt32(d),h.detailTex=b.readInt32(d),f.push(h)}a.textureLayers=f},MCAL:function(a,b,c){var d={offs:0},e=b.readUint8Array(d,b.chunkLen);a.alphaArray=e},MTEX:function(a,b){for(var c={offs:0},d=[];c.offs<b.chunkLen;){var e=b.readString(c,b.chunkLen-c.offs);c.offs+=1,d.push(e)}a.mtex=d},MMDX:function(a,b){var c={offs:0},d=null;b.chunkLen>0&&(d=b.readUint8Array(c,b.chunkLen)),a.mmdx=d},MMID:function(a,b){var c={offs:0},d=null;b.chunkLen>0&&(d=b.readInt32Array(c,b.chunkLen>>2)),a.mmid=d},MWMO:function(a,b){var c={offs:0},d=null;b.chunkLen>0&&(d=b.readUint8Array(c,b.chunkLen)),a.mwmo=d},MWID:function(a,b){var c={offs:0},d=null;b.chunkLen>0&&(d=b.readInt32Array(c,b.chunkLen>>2)),a.mwid=d},MDDF:function(a,c){var d=[],e={offs:0},f=c.chunkLen/36;if(f>0)var g=b(a.mmdx.buffer);for(var h=0;f>h;h++){var i={};i.nameID=c.readInt32(e),i.uniqueId=c.readInt32(e),i.pos=c.readVector3f(e),i.rotation=c.readVector3f(e),i.scale=c.readInt32(e);var j=a.mmid[i.nameID];i.fileName=g.readString({offs:j},g.getLength()-j),d.push(i)}a.mddf=d},MODF:function(a,c){var d={offs:0},e=[],f=c.chunkLen/64;if(f>0)var g=b(a.mwmo.buffer);for(var h=0;f>h;h++){var i={};i.nameId=c.readInt32(d),i.uniqueId=c.readInt32(d),i.pos=c.readVector3f(d),i.rotation=c.readVector3f(d),i.bb1=c.readVector3f(d),i.bb2=c.readVector3f(d),i.doodadSet=c.readUint16(d),i.nameSet=c.readUint16(d),i.flags=c.readInt32(d);var j=a.mwid[i.nameId];i.fileName=g.readString({offs:j},g.getLength()-j),e.push(i)}a.wmoObjs=e}};this.getHandler=function(b){return a[b]}}function f(a){for(var b=0;b<a.mcnkObjs.length;b++)for(var c=a.mcnkObjs[b],d=a.mtex,e=0;e<c.textureLayers.length;e++){var f=c.textureLayers[e].textureID,g=d[f];c.textureLayers[e].textureName=g}}var g=d.defer(),h=a(c);return h.then(function(a){var b={};a.setSectionReaders(new e),a.processFile(b),f(b),console.log(b),g.resolve(b)},function(){g.reject()}),g.promise}}])}(window,jQuery),function(a,b,c){var d=angular.module("main.services.map.blpLoader",["main.services.linedFileLoader"]);d.factory("blpLoader",["linedFileLoader","$log","$q",function(a,b,c){var d={name:"header",type:"layout",layout:[{name:"type",type:"int32"},{name:"encoding",type:"uint8"},{name:"alphaDepth",type:"uint8"},{name:"alphaEncoding",type:"uint8"},{name:"hasMips",type:"uint8"},{name:"width",type:"int32"},{name:"height",type:"int32"},{name:"offsets",type:"int32Array",len:16},{name:"lengths",type:"int32Array",len:16},{name:"palette",type:"uint8Array",len:256}]};return function(e){var f=c.defer(),g=a(e);return g.then(function(a){var c={offs:0},g=a.readNZTString(c,4);"BLP2"!=g&&(b.error("Unknown BLP file ident = ",g,", filepath = ",e),f.reject());var h={header:{}},h=a.parseSectionDefinition(h,d,a,c);h.fileName=e;var i=h.width,j=h.height;if(1==h.type){if(2==h.encoding)switch(h.alphaDepth){case 0:h.textureFormat="S3TC_RGB_DXT1";break;case 1:h.textureFormat="S3TC_RGB_DXT1";break;case 4:h.textureFormat="S3TC_RGBA_DXT3";break;case 8:1==h.alphaEncoding?h.textureFormat="S3TC_RGBA_DXT3":h.textureFormat="S3TC_RGBA_DXT5";break;default:h.textureFormat="S3TC_RGBA_DXT3"}else 1==h.encoding&&(h.textureFormat="BGRA");for(var k=[],l=0;15>l&&(0!=h.lengths[l]&&0!=h.offsets[l]);l++){var m=a.readUint8Array({offs:h.offsets[l]},h.lengths[l]);k.push({texture:m,width:i,height:j}),j=Math.floor(j/2),i=Math.floor(i/2),j=0==j?1:j,i=0==i?1:i}}h.mipmaps=k,f.resolve(h)},function(a){f.reject()}),f.promise}}])}(window,jQuery),function(a,b,c){var d=angular.module("main.services.map.mdxLoader",["main.services.linedFileLoader"]);d.factory("mdxLoader",["linedFileLoader","$log","$q",function(a,b,d){var e={name:"header",type:"layout",layout:[{name:"MNameLen",type:"int32"},{name:"MNameOffs",type:"int32"},{name:"ModelType",type:"int32"},{name:"nGlobalSequences",type:"int32"},{name:"ofsGlobalSequences",type:"int32"},{name:"nAnimations",type:"int32"},{name:"ofsAnimations",type:"int32"},{name:"nC",type:"int32"},{name:"ofsC",type:"int32"},{name:"nBones",type:"int32"},{name:"ofsBones",type:"int32"},{name:"nF",type:"int32"},{name:"ofsF",type:"int32"},{name:"nVertexes",type:"int32"},{name:"ofsVertexes",type:"int32"},{name:"nViews",type:"int32"},{name:"nColors",type:"int32"},{name:"ofsColors",type:"int32"},{name:"nTextures",type:"int32"},{name:"ofsTextures",type:"int32"},{name:"nTransparency",type:"int32"},{name:"ofsTransparency",type:"int32"},{name:"nTexAnims",type:"int32"},{name:"ofsTexAnims",type:"int32"},{name:"nTexReplace",type:"int32"},{name:"ofsTexReplace",type:"int32"},{name:"nRenderFlags",type:"int32"},{name:"ofsRenderFlags",type:"int32"},{name:"nGroupBoneIDs",type:"int32"},{name:"ofsGroupBoneIDs",type:"int32"},{name:"nTexLookup",type:"int32"},{name:"ofsTexLookup",type:"int32"},{name:"nTexUnits",type:"int32"},{name:"ofsTexUnits",type:"int32"},{name:"nTransLookup",type:"int32"},{name:"ofsTransLookup",type:"int32"},{name:"nTexAnimLookup",type:"int32"},{name:"ofsTexAnimLookup",type:"int32"},{name:"BoundingCorner1",type:"vector3f"},{name:"BoundingCorner2",type:"vector3f"},{name:"BoundingRadius",type:"float32"},{name:"Corner1",type:"vector3f"},{name:"Corner2",type:"vector3f"},{name:"Radius",type:"float32"},{name:"nBoundingTriangles",type:"int32"},{name:"ofsBoundingTriangles",type:"int32"},{name:"nBoundingVertices",type:"int32"},{name:"ofsBoundingVertices",type:"int32"},{name:"nBoundingNormals",type:"int32"},{name:"ofsBoundingNormals",type:"int32"},{name:"nAttachments",type:"int32"},{name:"ofsAttachments",type:"int32"},{name:"nP",type:"int32"},{name:"ofsP",type:"int32"},{name:"nNumEvents",type:"int32"},{name:"ofsNumEvents",type:"int32"},{name:"nLights",type:"int32"},{name:"ofsLights",type:"int32"},{name:"nCameras",type:"int32"},{name:"ofsCameras",type:"int32"},{name:"nCameraLookup",type:"int32"},{name:"ofsCameraLookup",type:"int32"},{name:"nRibbonEmitters",type:"int32"},{name:"ofsRibbonEmitters",type:"int32"},{name:"nParticleEmitters",type:"int32"},{name:"ofsParticleEmitters",type:"int32"},{name:"vertexes",offset:"ofsVertexes",type:"uint8Array",len:function(a){return 48*a.nVertexes}},{name:"textureDefinition",offset:"ofsTextures",count:"nTextures",type:"layout",layout:[{name:"texType",type:"uint32"},{name:"flags",type:"uint32"},{name:"filenameLen",type:"uint32"},{name:"ofsFilename",type:"uint32"},{name:"textureName",offset:"ofsFilename",len:"filenameLen",type:"string"}]},{name:"texLookup",offset:"ofsTexLookup",count:"nTexLookup",type:"uint16"},{name:"colors",offset:"ofsColors",count:"nColors",type:"layout",layout:[{name:"color",type:"ablock",valType:"vector3f"},{name:"alpha",type:"ablock",valType:"int16"}]},{name:"transparencies",offset:"ofsTransparency",count:"nTransparency",type:"layout",layout:[{name:"values",type:"ablock",valType:"int16"}]},{name:"transLookup",offset:"ofsTransLookup",count:"nTransLookup",type:"int16"},{name:"texReplace",offset:"ofsTexReplace",count:"nTexReplace",type:"uint16"},{name:"textUnitLookup",offset:"ofsTexUnits",count:"nTexUnits",type:"uint16"},{name:"renderFlags",offset:"ofsRenderFlags",count:"nRenderFlags",type:"layout",layout:[{name:"flags",type:"uint16"},{name:"blend",type:"uint16"}]}]},f={264:e};return function(e){var g=d.defer(),h=a(e);return h.then(function(a){var d={offs:0},i=a.readNZTString(d,4),j=a.readInt32(d);"MD20"!=i&&(b.error("Unknown MDX file ident = ",i,", filepath = ",e),h.reject());var k=f[j];k==c&&(b.error("Unknown MDX file version = ",j,", filepath = ",e),h.reject());var l={};l=a.parseSectionDefinition(l,k,a,d),g.resolve(l)},function(a){g.reject()}),g.promise}}])}(window,jQuery),function(a,b,c){var d=angular.module("main.services.map.skinLoader",["main.services.linedFileLoader"]);d.factory("skinLoader",["linedFileLoader","$log","$q",function(a,b,c){var d={name:"header",type:"layout",layout:[{name:"nIndex",type:"int32"},{name:"ofsIndex",type:"int32"},{name:"nTris",type:"int32"},{name:"ofsTris",type:"int32"},{name:"nProps",type:"int32"},{name:"ofsProps",type:"int32"},{name:"nSub",type:"int32"},{name:"ofsSub",type:"int32"},{name:"nTex",type:"int32"},{name:"ofsTex",type:"int32"},{name:"LOD",type:"int32"},{name:"indexes",offset:"ofsIndex",len:"nIndex",type:"uint16Array"},{name:"triangles",offset:"ofsTris",len:"nTris",type:"uint16Array"},{name:"subMeshes",offset:"ofsSub",count:"nSub",type:"layout",layout:[{name:"meshID",type:"int32"},{name:"vStart",type:"uint16"},{name:"vCount",type:"uint16"},{name:"idxStart",type:"uint16"},{name:"idxCount",type:"uint16"},{name:"idxBone",type:"uint16"},{name:"OfsBoneList",type:"uint16"},{name:"unk1",type:"uint16"},{name:"rootBone",type:"uint16"},{name:"pos",type:"vector3f"},{name:"unkPos",type:"vector3f"},{name:"unkFloat",type:"float32"}]},{name:"texs",offset:"ofsTex",count:"nTex",type:"layout",layout:[{name:"flags",type:"uint16"},{name:"renderOrder",type:"int16"},{name:"submeshIndex",type:"uint16"},{name:"unk1",type:"uint16"},{name:"colorIndex",type:"int16"},{name:"renderFlagIndex",type:"uint16"},{name:"textureUnitNum",type:"uint16"},{name:"unk2",type:"uint16"},{name:"textureIndex",type:"uint16"},{name:"unk3",type:"uint16"},{name:"transpIndex",type:"uint16"},{name:"textureAnim",type:"uint16"}]}]};return function(e){var f=c.defer(),g=a(e);return g.then(function(a){var c={offs:0},h=a.readNZTString(c,4);"SKIN"!=h&&(b.error("Unknown SKIN file ident = ",h,", filepath = ",e),g.reject());var i={header:{}};i.header=a.parseSectionDefinition(i,d,a,c),f.resolve(i)},function(a){f.reject()}),f.promise}}])}(window,jQuery),function(a,b,c){var d=angular.module("main.services.map.wdtLoader",["main.services.chunkedLoader"]);d.factory("wdtLoader",["chunkedLoader","$q","$log",function(a,b,c){return function(d){var e=b.defer(),f=a(d);return f.then(function(a){var b=a.loadChunkAtOffset(0);if("MVER"!==b.chunkIdent)throw"Got bad WDT file "+d;b=a.loadChunkAtOffset(b.nextChunkOffset);for(var f={};""!=b.chunkIdent;){switch(b.chunkIdent){case"MAIN":for(var g={offs:0},h={},i=0;64>i;i++){for(var j={},k=0;64>k;k++)j[k]=b.readInt32(g),g.offs+=4;h[i]=j}f.tileTable=j;break;case"MPHD":var l={offs:0};f.flags=b.readUint8(l),f.isWMOMap=f.flags&!0;break;case"MWMO":var l={offs:0};f.wmoName=b.readString(l);break;case"MODF":var l={offs:0},m={};m.nameId=b.readInt32(l),m.uniqueId=b.readInt32(l),m.pos=b.readVector3f(l),m.rotation=b.readVector3f(l),m.unkVector1=b.readVector3f(l),m.unkVector2=b.readVector3f(l),m.doodadSet=b.readUint16(l),m.nameSet=b.readUint16(l),m.flags=b.readInt32(l),f.modfChunk=m;break;default:c.info("Unknown Chunk. Ident = "+b.chunkIdent+", file = "+d)}b=a.loadChunkAtOffset(b.nextChunkOffset)}e.resolve(f)},function(){e.reject()}),e.promise}}])}(jQuery,window),function(a,b,c){var d=angular.module("main.services.map.wmoLoader",["main.services.chunkedLoader","main.services.fileReadHelper"]);d.factory("wmoGroupLoader",["chunkedLoader","fileReadHelper","$q","$log",function(a,b,c,d){return function(b,d){function e(){var a={MVER:function(c,d){if("MVER"!==d.chunkIdent)throw"Got bad group WMO file "+b;var e=d.readInt32({offs:0});17==e&&(a=g)}};this.getHandler=function(b){return a[b]}}var f=c.defer(),g={MOGP:{MOGP:function(a,b){var c={offs:0},d={};return d.GroupName=b.readInt32(c),d.dGroupName=b.readInt32(c),d.Flags=b.readInt32(c),d.BoundBoxCorner1=b.readVector3f(c),d.BoundBoxCorner2=b.readVector3f(c),d.Index=b.readInt16(c),d.numItems=b.readInt16(c),d.numBatchesA=b.readInt16(c),d.numBatchesB=b.readInt16(c),d.numBatchesC=b.readInt16(c),d.Indeces=b.readUint8Array(c,4),d.Unk1=b.readInt32(c),d.groupID=b.readInt32(c),d.Unk2=b.readInt32(c),d.Unk3=b.readInt32(c),c.offs+=10,a.mogp=d,c},subChunks:{MOPY:function(a,b){b.length/2},MOVI:function(a,b){var c=b.chunkLen/2;a.indicies=b.readUint16Array({offs:0},c)},MOVT:function(a,b){if(d)a.verticles=b.readFloat32Array({offs:0},b.chunkLen/4);else{var c=b.chunkLen/12;a.verticles=b.readVector3f({offs:0},c)}},MONR:function(a,b){var c=b.chunkLen/12;d?a.normals=b.readFloat32Array({offs:0},b.chunkLen/4):a.normals=b.readVector3f({offs:0},c)},MOTV:function(a,b){var c=b.chunkLen/8;d?a.textCoords=b.readFloat32Array({offs:0},b.chunkLen/4):a.textCoords=b.readVector2f({offs:0},c)},MOCV:function(a,b){var c=(b.chunkLen/4,b.readInt8Array({offs:0},b.chunkLen));a.colorVerticles=c},MOBA:function(a,b){for(var c={offs:0},d=b.chunkLen/24,e=[],f=0;f<Math.floor(d);f++){var g={};g.unk=b.readUint8Array(c,12),g.startIndex=b.readUint32(c),g.count=b.readUint16(c),g.minIndex=b.readInt16(c),g.maxIndex=b.readInt16(c),g.flags=b.readInt8(c),g.tex=b.readUint8(c),e.push(g)}a.renderBatches=e}}}},h=a(b);return h.then(function(a){var b={};a.setSectionReaders(new e),a.processFile(b),f.resolve(b)},function(){f.reject()}),f.promise}}]),d.factory("wmoLoader",["chunkedLoader","fileReadHelper","$q","$log",function(a,b,c,d){return function(d){function e(){var a={MVER:function(b,c){if("MVER"!==c.chunkIdent)throw"Got bad WMO file "+d;var e=c.readInt32({offs:0});17==e&&(a=g)}};this.getHandler=function(b){return a[b]}}var f=c.defer(),g={MOHD:function(a,b){var c={offs:0};a.nTextures=b.readInt32(c),a.nGroups=b.readInt32(c),a.nPortals=b.readInt32(c),a.nLights=b.readInt32(c),a.nModels=b.readInt32(c),a.nDoodads=b.readInt32(c),a.nDoodadSets=b.readInt32(c),a.ambColor=b.readInt32(c),a.unk1=b.readInt32(c),a.BoundBoxCorner1=b.readVector3f(c),a.BoundBoxCorner2=b.readVector3f(c),a.WMOId=b.readInt32(c)},MOGI:function(a,b){for(var c={offs:0},d=[],e=0;e<a.nGroups;e++){var f={};f.flags=b.readUint32(c),f.bb1=b.readVector3f(c),f.bb2=b.readVector3f(c),f.nameoffset=b.readInt32(c),d.push(f)}a.groupInfos=d},MOMT:function(a,c){for(var d={offs:0},e=[],f=a.motx,g=0;g<a.nTextures;g++){var h={};h.flags1=c.readInt32(d),h.flags2=c.readInt32(d),h.blendMode=c.readInt32(d),h.namestart1=c.readInt32(d),h.color1=c.readInt32(d),h.flags_1=c.readInt32(d),h.namestart2=c.readInt32(d),h.color2=c.readInt32(d),h.flags_2=c.readInt32(d),h.color_3=c.readInt32(d),h.unk=c.readInt32(d),h.dx=c.readInt32Array(d,5),h.textureName1=b(f.buffer).readString({offs:h.namestart1},f.length),h.textureName2=b(f.buffer).readString({offs:h.namestart2},f.length),e.push(h)}a.momt=e},MOTX:function(a,b){var c={offs:0},d=b.readUint8Array(c,b.chunkLen);a.motx=d},MODN:function(a,b){var c={offs:0},d=b.readUint8Array(c,b.chunkLen);a.modn=d},MODS:function(a,b){for(var c={offs:0},d=[],e=0;e<a.nDoodadSets;e++){var f={};f.name=b.readNZTString(c,20),f.index=b.readInt32(c),f.number=b.readInt32(c),f.unused=b.readInt32(c),d.push(f)}a.mods=d},MODD:function(a,c){for(var d={offs:0},e=[],f=a.modn,g=0;g<a.nDoodadSets;g++){for(var h=a.mods[g],i={
name:h.name,doodads:[]},j=0;j<h.number;j++){var k={};k.nameIndex=c.readInt32(d),k.modelName=b(f.buffer).readString({offs:k.nameIndex},f.length-k.nameIndex),k.pos=c.readVector3f(d),k.rotation=c.readQuaternion(d),k.scale=c.readFloat32(d),k.color=c.readUint32(d),i.doodads.push(k)}e.push(i)}a.modd=e}},h=a(d);return h.then(function(a){var b={};a.setSectionReaders(new e),a.processFile(b),f.resolve(b)},function(){f.reject()}),f.promise}}])}(window,jQuery),function(a,b,c){var d=angular.module("main.world.worldMap",[]);d.factory("worldMap",[function(){return{setMap:function(a){}}}])}(jQuery,window),function(a,b,c){var d=angular.module("js.wow.render.cacheTemplate",[]);d.factory("cacheTemplate",["$q","$timeout",function(a,b){function d(d,e){function f(a){for(var b=l[a],d=0;d<b.length;d++){var e=j(a);b[d].resolve(e)}l[a]=c}function g(a,b){for(var d=l[a],e=0;e<d.length;e++)d[e].reject(b);l[a]=c}function h(a){b(function(){d(a).then(function(b){var c=e(b);i(a,c),f(a)},function(b){g(a)})},1)}function i(a,b){var c={obj:b,counter:1};k[a]=c}function j(a){var b=k[a];return b===c?c:(b.counter+=1,b.obj)}var k={},l={};this.get=function(b){var d=a.defer(),e=j(b);if(e)return d.resolve(e),d.promise;var f=l[b];return f===c&&(f=[],h(b)),f.push(d),l[b]=f,d.promise},this.remove=function(a){var b=k[a];b&&(b.counter-=1,b.counter<=0&&(k[a]=null,b.obj.destroy()))}}return function(a,b){return new d(a,b)}}])}(window,jQuery);var firstPersonCamera=angular.module("js.wow.render.camera.firstPersonCamera",[]);firstPersonCamera.factory("firstPersonCamera",["$log",function(a){return function(a,b){function c(a){var b=String.fromCharCode(a.keyCode||a.charCode);switch(b){case"W":m=1;break;case"S":m=-1;break;case"A":n=-1;break;case"D":n=1;break;case"Q":o=1;break;case"E":o=-1}}function d(a){var b=String.fromCharCode(a.keyCode||a.charCode);switch(b){case"W":m=0;break;case"S":m=0;break;case"A":n=0;break;case"D":n=0;break;case"Q":o=0;break;case"E":o=0}}function e(a){0===a.button&&(p=1,q=a.pageX,r=a.pageY)}function f(a){p=1,q=a.pageX,r=a.pageY}function g(a){var b=a.touches[0].pageX,c=a.touches[0].pageY;1===p&&(s+=(b-q)/4,t+=(c-r)/4,-89>t?t=-89:t>89&&(t=89),q=b,r=c)}function h(a){0===a.button&&(p=0)}function i(a){1===p&&(s+=(a.pageX-q)/4,t+=(a.pageY-r)/4,-89>t?t=-89:t>89&&(t=89),q=a.pageX,r=a.pageY)}function j(a){p=0}function k(a){return a*(Math.PI/180)}var l=[0,0,0],m=0,n=0,o=0,p=0,q=0,r=0,s=0,t=0;a.addEventListener("mousemove",i,!1),a.addEventListener("touchmove",g,!1),a.addEventListener("mousedown",e,!1),a.addEventListener("touchstart",f,!1),a.addEventListener("mouseup",h,!1),a.addEventListener("touchend",h,!1),a.addEventListener("mouseout",j,!1);var u;return b.addEventListener("mousedown",function(a){u=a.target},!1),b.addEventListener("keydown",function(b){u==a&&c(b)},!1),b.addEventListener("keyup",function(b){u==a&&d(b)},!1),{tick:function(a){var b=[1,0,0],c=.5,d=a;b=vec3.rotateY(b,b,[0,0,0],k(t)),b=vec3.rotateZ(b,b,[0,0,0],k(-s));var e=[];if(0!==n){var f=[];vec3.rotateZ(f,b,[0,0,0],k(-90)),f[2]=0,vec3.normalize(f,f),vec3.scale(f,f,d*c*n),vec3.add(l,l,f)}if(0!==m){var g=[];vec3.copy(g,b),vec3.scale(g,g,d*c*m),vec3.add(l,l,g)}return 0!==o&&(l[2]=l[2]+d*c*o),vec3.add(e,l,b),{lookAtVec3:e,cameraVec3:l}},setCameraPos:function(a,b,c){l=[a,b,c]}}}}]);var adtGeomCache=angular.module("js.wow.render.geometry.adtGeomCache",["main.services.map.adtLoader","js.wow.render.cacheTemplate"]);adtGeomCache.factory("adtGeomCache",["adtLoader","cacheTemplate","$q",function(a,b,c){function d(a,b){for(var c=[],d=256,e=0;e<a.mcnkObjs.length;e++){var f=a.mcnkObjs[e],g=f.alphaArray,h=f.textureLayers,i=[];c.push(i),i[16383]=0;for(var j=0;j<h.length;j++){var k=h[j].alphaMap,l=64*j,m=0,n=0;if((512&h[j].flags)>0)for(;4096>n;){var o=128&g[k],p=127&g[k];k++;for(var q=0;p>q&&4096!=n;q++)i[l++]=g[k],m++,n++,m>=64&&(l=l+d-64,m=0,n++),o||k++;o&&k++}else if((4&b.flags)>0||(128&b.flags)>0)for(var r=0;64>r;r++)for(var s=0;64>s;s++)i[l]=g[k],l+=1,m+=1,n+=1,k++,m>=64&&(l=l+d-64,m=0);else for(var r=0;64>r;r++)for(var s=0;32>s;s++)i[l]=Math.floor(((240&g[k])>>4)/15*255),i[l+1]=Math.floor((15&g[k])/15*255),l+=2,m+=2,n+=2,k++,m>=64&&(l=l+d-64,m=0)}}return c}function e(a,b){this.sceneApi=a,this.gl=a.getGlContext(),this.wdtFile=b,this.combinedVBO=null,this.textureArray=new Array(255);for(var c=0;256>c;c++)this.textureArray[c]=[]}function f(c){var d=this,f=b(function(b){return a(b)},function(a){var b=new e(c,c.getCurrentWdt());return b.assign(a),b.createTriangleStrip(),b.createVBO(),b.loadTextures(),b});d.loadAdt=function(a){return f.get(a)},d.unLoadAdt=function(a){f.remove(a)}}return e.prototype={assign:function(a){this.adtFile=a},loadTextures:function(){for(var a=this.gl,b=this.adtFile.mcnkObjs,c=0;c<b.length;c++){var e=b[c];if(e.textureLayers&&e.textureLayers.length>0)for(var f=0;f<e.textureLayers.length;f++)this.loadTexture(c,f,e.textureLayers[f].textureName)}for(var g=(b.length,4),h=64,i=g*h,j=h,k=d(this.adtFile,this.wdtFile),l=[],c=0;c<b.length;c++){var m=a.createTexture();a.bindTexture(a.TEXTURE_2D,m),a.texImage2D(a.TEXTURE_2D,0,a.ALPHA,i,j,0,a.ALPHA,a.UNSIGNED_BYTE,new Uint8Array(k[c])),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),a.generateMipmap(a.TEXTURE_2D),a.bindTexture(a.TEXTURE_2D,null),l.push(m)}this.alphaTextures=l},loadTexture:function(a,b,c){var d=this;this.sceneApi.loadTexture(c).then(function(c){d.textureArray[a][b]=c},function(){})},createTriangleStrip:function(){function a(a,b,c){var d=[4369,8738,17476,34952],e=[15,240,3840,61440];return 0!=(a&d[b]&e[c])}function b(a,b){var c=9*(b+1>>>1)+8*(b>>>1)+a;return c}for(var c=this.adtFile.mcnkObjs,d=[],e=[],f=0;f<c.length;f++){var g=c[f],h=g.holes;e.push(d.length);for(var i=!0,j=0;4>j;j++)for(var k=0;4>k;k++)if(!a(h,j,k))for(var l=2*j,m=4*k,n=0;2>n;n++){i?i=!1:d.push(b(l,m+2*n));for(var o=0;3>o;o++)d.push(b(l+o,m+2*n)),d.push(b(l+o,m+2*n+2));d.push(b(l+2,m+2*n+2))}}e.push(d.length);var p={strips:d,stripOffsets:e};this.triangleStrip=p},createVBO:function(){var a=this.gl,b=(this.adtFile,[]);this.indexOffset=b.length;for(var c=0;145>c;c++)b.push(c);this.heightOffset=b.length;for(var d=this.adtFile.mcnkObjs,c=0;c<d.length;c++)for(var e=0;145>e;e++)b.push(d[c].heights[e]);this.textOffset=b.length;for(var f=this.sceneApi.getAdtTexCoordinates(),c=0;c<f.length;c++)b.push(f[c]);this.combinedVbo=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,this.combinedVbo),a.bufferData(a.ARRAY_BUFFER,new Float32Array(b),a.STATIC_DRAW),this.stripVBO=a.createBuffer(),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.stripVBO),a.bufferData(a.ELEMENT_ARRAY_BUFFER,new Int16Array(this.triangleStrip.strips),a.STATIC_DRAW)},draw:function(){var a=this.gl,b=this.triangleStrip.stripOffsets,c=this.sceneApi.getShaderUniforms(),d=this.sceneApi.getShaderAttributes();a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.stripVBO),a.bindBuffer(a.ARRAY_BUFFER,this.combinedVbo),a.enableVertexAttribArray(d.aHeight),a.enableVertexAttribArray(d.aIndex),a.enableVertexAttribArray(d.aTexCoord),a.vertexAttribPointer(d.aIndex,1,a.FLOAT,!1,0,4*this.indexOffset),a.vertexAttribPointer(d.aTexCoord,2,a.FLOAT,!1,0,4*this.textOffset),a.uniform1i(c.layer0,0),a.uniform1i(c.layer1,2),a.uniform1i(c.layer2,3),a.uniform1i(c.layer3,4),a.uniform1i(c.alphaTexture,1);for(var e=this.adtFile.mcnkObjs,f=0;256>f;f++){var g=e[f];if(a.vertexAttribPointer(d.aHeight,1,a.FLOAT,!1,0,4*(this.heightOffset+145*f)),a.uniform3f(c.aPos,g.pos.x,g.pos.y,g.pos.z),this.textureArray[f]&&this.textureArray[f][0]){a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,this.textureArray[f][0].texture),a.activeTexture(a.TEXTURE1),a.bindTexture(a.TEXTURE_2D,this.alphaTextures[f]);for(var h=1;h<this.textureArray[f].length;h++)a.activeTexture(a.TEXTURE1+h),this.textureArray[f][h]&&this.textureArray[f][h].texture?a.bindTexture(a.TEXTURE_2D,this.textureArray[f][h].texture):a.bindTexture(a.TEXTURE_2D,null);var i=0==f?0:b[f+1]-b[f];a.drawElements(a.TRIANGLE_STRIP,i,a.UNSIGNED_SHORT,2*b[f])}}}},f}]);var m2GeomCache=angular.module("js.wow.render.geometry.m2GeomCache",["main.services.map.mdxLoader","js.wow.render.cacheTemplate"]);m2GeomCache.factory("m2GeomCache",["mdxLoader","cacheTemplate","$q",function(a,b,c){function d(a){this.sceneApi=a,this.gl=a.getGlContext(),this.combinedVBO=null,this.textureArray=[]}function e(c){var e=this,f=b(function(b){return a(b)},function(a){var b=new d(c);return b.assign(a),b.createVBO(),b.loadTextures(),b});e.loadM2=function(a){return f.get(a)},e.unLoadM2=function(a){f.remove(a)}}return d.prototype={assign:function(a){this.m2File=a},loadTextures:function(){for(var a=this.m2File.textureDefinition,b=0;b<a.length;b++)this.loadTexture(b,a[b].textureName)},loadTexture:function(a,b){var c=this;this.sceneApi.loadTexture(b).then(function(b){c.textureArray[a]=b},function(){})},createVBO:function(){var a=this.gl,b=this.m2File;this.vertexVBO=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,this.vertexVBO),a.bufferData(a.ARRAY_BUFFER,b.vertexes,a.STATIC_DRAW)},draw:function(a,b,c,d,e){var f=this.gl,g=this.m2File,h=this.sceneApi.getShaderUniforms(),i=this.sceneApi.getShaderAttributes();if(f.uniformMatrix4fv(h.uPlacementMat,!1,c),f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,a.indexVBO),f.bindBuffer(f.ARRAY_BUFFER,this.vertexVBO),f.enableVertexAttribArray(i.aPosition),f.enableVertexAttribArray(i.aTexCoord),f.disableVertexAttribArray(i.aColor),f.vertexAttribPointer(i.aPosition,3,f.FLOAT,!1,48,0),f.vertexAttribPointer(i.aTexCoord,2,f.FLOAT,!1,48,32),b)for(var j=0;j<b.length;j++)if(b[j].isRendered&&b[j].texUnit1Texture){var k=a.skinFile.header.texs[b[j].texUnit1TexIndex].colorIndex;if(k>0&&e){var l=e[k];f.vertexAttrib4f(i.aColor,l[0],l[1],l[2],l[3])}else f.vertexAttrib4f(i.aColor,d[0],d[1],d[2],d[3]);var m=a.skinFile.header.texs[b[j].texUnit1TexIndex].renderFlagIndex;switch(g.renderFlags[m].blend){case 0:f.disable(f.BLEND),f.uniform1f(h.uAlphaTest,-1);break;case 1:f.disable(f.BLEND),f.uniform1f(h.uAlphaTest,.001);break;case 2:f.uniform1f(h.uAlphaTest,-1),f.enable(f.BLEND),f.blendFunc(f.SRC_ALPHA,f.ONE_MINUS_SRC_ALPHA);break;case 3:f.uniform1f(h.uAlphaTest,-1),f.enable(f.BLEND),f.blendFunc(f.SRC_COLOR,f.ONE);break;case 4:f.uniform1f(h.uAlphaTest,-1),f.enable(f.BLEND),f.blendFunc(f.SRC_ALPHA,f.ONE);break;default:f.uniform1f(h.uAlphaTest,-1),f.enable(f.BLEND),f.blendFunc(f.DST_COLOR,f.SRC_COLOR)}f.bindTexture(f.TEXTURE_2D,b[j].texUnit1Texture.texture),f.drawElements(f.TRIANGLES,a.skinFile.header.subMeshes[j].idxCount,f.UNSIGNED_SHORT,2*a.skinFile.header.subMeshes[j].idxStart)}f.uniform1f(h.uAlphaTest,-1)}},e}]);var m2GeomCache=angular.module("js.wow.render.geometry.skinGeomCache",["main.services.map.skinLoader","js.wow.render.cacheTemplate"]);m2GeomCache.factory("skinGeomCache",["skinLoader","cacheTemplate","$q",function(a,b,c){function d(a){this.gl=a.getGlContext(),this.indexVBO=null,this.assign=function(a){this.skinFile=a},this.createVBO=function(){var a=this.gl,b=(this.skinFile,[]),c=this.skinFile.header;b.length=c.triangles.length;for(var d=0;d<b.length;d++)b[d]=c.indexes[c.triangles[d]];this.indexVBO=a.createBuffer(),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.indexVBO),a.bufferData(a.ELEMENT_ARRAY_BUFFER,new Int16Array(b),a.STATIC_DRAW)}}function e(c){var e=this,f=b(function(b){return a(b,!0)},function(a){var b=new d(c);return b.assign(a),b.createVBO(),b});e.loadSkin=function(a){return f.get(a)},e.unLoadSkin=function(a){f.remove(a)}}return e}]),function(a,b,c){function d(a,b){this.gl=b.getGlContext(),this.sceneApi=b,this.combinedVBO=null,this.indexVBO=null,this.wmoGroupFile=a,this.textureArray=[],this.loadTextures=function(a){this.momt=a,this.textureArray.length=this.wmoGroupFile.renderBatches.length;for(var b=0;b<this.wmoGroupFile.renderBatches.length;b++){var c=this.wmoGroupFile.renderBatches[b].tex;this.loadTexture(b,a[c].textureName1)}},this.loadTexture=function(a,c){var d=this;b.loadTexture(c).then(function(b){d.textureArray[a]=b},function(){})},this.createVBO=function(){var a=this.gl,b=this.wmoGroupFile,c=function(a,b,c,d){var e=4*a.length+4*b.length+4*c.length;d&&(e+=d.length);var f=new Uint8Array(e);return f.set(new Uint8Array(new Float32Array(a).buffer),0),f.set(new Uint8Array(new Float32Array(b).buffer),4*a.length),f.set(new Uint8Array(new Float32Array(c).buffer),4*(a.length+b.length)),d&&f.set(new Uint8Array(d.buffer),4*(a.length+b.length+c.length)),f},d=c(b.verticles,b.normals,b.textCoords,b.colorVerticles);this.combinedVBO=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,this.combinedVBO),a.bufferData(a.ARRAY_BUFFER,d,a.STATIC_DRAW),this.positionOffset=0,this.normalOffset=b.verticles.length,this.textOffset=b.verticles.length+b.normals.length,this.colorOffset=b.verticles.length+b.normals.length+b.textCoords.length,this.indexVBO=a.createBuffer(),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.indexVBO),a.bufferData(a.ELEMENT_ARRAY_BUFFER,new Int16Array(b.indicies),a.STATIC_DRAW)},this.draw=function(){var a=this.gl,b=this.sceneApi.getShaderUniforms(),c=this.sceneApi.getShaderAttributes(),d=this.wmoGroupFile,e=(8192&d.mogp.Flags)>0;a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.indexVBO),a.bindBuffer(a.ARRAY_BUFFER,this.combinedVBO),a.enableVertexAttribArray(c.aPosition),a.enableVertexAttribArray(c.aTexCoord),a.vertexAttribPointer(c.aPosition,3,a.FLOAT,!1,0,0),a.vertexAttribPointer(c.aTexCoord,2,a.FLOAT,!1,0,4*this.textOffset),e&&d.colorVerticles&&d.colorVerticles.length>0?(a.enableVertexAttribArray(c.aColor),a.vertexAttribPointer(c.aColor,4,a.UNSIGNED_BYTE,!0,0,4*this.colorOffset)):(a.disableVertexAttribArray(c.aColor),a.vertexAttrib4f(c.aColor,1,1,1,1)),a.activeTexture(a.TEXTURE0),a.uniform1f(b.uAlphaTest,-1);for(var f=0;f<d.renderBatches.length;f++){var g=d.renderBatches[f],h=g.tex;0!=this.momt[h].blendMode?((128&this.momt[h].flags1)>0&&a.uniform1f(b.uAlphaTest,.3),(1&this.momt[h].flags1)>0&&a.uniform1f(b.uAlphaTest,.1)):a.uniform1f(b.uAlphaTest,-1),(4&this.momt[h].flags1)>0?a.disable(a.CULL_FACE):a.enable(a.CULL_FACE);var i=this.textureArray[f];i&&(a.bindTexture(a.TEXTURE_2D,i.texture),a.drawElements(a.TRIANGLES,g.count,a.UNSIGNED_SHORT,2*g.startIndex))}a.uniform1f(b.uAlphaTest,-1)},this.destroy=function(){var a=this.gl;this.texture&&a.deleteTexture(this.texture),this.texture=null}}var e=angular.module("js.wow.render.geometry.wmoGeomCache",["main.services.map.wmoLoader","js.wow.render.cacheTemplate"]);e.factory("wmoGeomCache",["wmoGroupLoader","cacheTemplate","$q",function(a,b,c){function e(c){var e=this,f=b(function(b){return a(b,!0)},function(a){var b=new d(a,c);return b.createVBO(),b});e.loadWmoGeom=function(a){return f.get(a)},e.unLoadWmoGeom=function(a){f.remove(a)}}return e}])}(window,jQuery),function(a,b,c){var d=angular.module("js.wow.render.geometry.wmoMainCache",["main.services.map.wmoLoader","js.wow.render.cacheTemplate"]);d.factory("wmoMainCache",["wmoLoader","cacheTemplate","$q",function(a,b,c){function d(c){var d=this,e=b(function(b){return a(b)},function(a){return a});d.loadWmoMain=function(a){return e.get(a)},d.unLoadWmoMain=function(a){e.remove(a)}}return d}])}(window,jQuery),function(a,b,c){var d=angular.module("js.wow.render.mdxObject",[]);d.factory("mdxObject",["$q","$timeout",function(a,b){function c(a){this.sceneApi=a}return c.prototype={load:function(b,c,d){var e=this,f=b.split(".")[0],g=f+".m2",h=f+"00.skin",i=this.sceneApi.loadM2Geom(g),j=this.sceneApi.loadSkinGeom(h);a.all([i,j]).then(function(a){var b=a[0],c=a[1];e.m2Geom=b,e.skinGeom=c,e.makeSubmeshArray(b,c,d)})},makeSubmeshArray:function(a,b,c){var d=[],e=this;if(d.length=15,c)c.forEach(function(a,b){d[b]={submeshIndex:0}});else{d.length=b.skinFile.header.subMeshes.length;for(var f=0;f<d.length;f++)d[f]={isRendered:!1,textureTexUnit1:null,textureTexUnit2:null,textureTexUnit3:null};for(var f=0;f<b.skinFile.header.texs.length;f++){var g=b.skinFile.header.texs[f],h=a.m2File.texLookup[g.textureIndex],i=a.m2File.textureDefinition[h],j=d[g.submeshIndex];j.isRendered=!0,0===i.texType&&!function(a,b,c){e.sceneApi.loadTexture(b.textureName).then(function(b){a.texUnit1Texture=b,a.texUnit1TexIndex=c},function(){})}(j,i,f)}}this.submeshArray=d},getSubMeshColor:function(a){var b=this.m2Geom.m2File.colors;if(b.length>0){var c=[];c.length=b.length;for(var d=0;d<b.length;d++){var e=b[d].color.valuesPerAnimation[0][0],f=b[d].alpha.valuesPerAnimation[0][0];c[d]=[e.x,e.y,e.z,f/32767]}return c}return null},draw:function(a,b,c){var d=[255&c,c>>8&255,c>>16&255,c>>24&255];if(d[0]/=255,d[1]/=255,d[2]/=255,d[3]/=255,this.m2Geom&&this.skinGeom){var e=this.getSubMeshColor(a);this.m2Geom.draw(this.skinGeom,this.submeshArray,b,d,e)}}},c}])}(window,jQuery),function(a,b,c){var d=angular.module("js.wow.render.adtM2ObjectFactory",["js.wow.render.mdxObject"]);d.factory("adtM2ObjectFactory",["mdxObject","$q","$timeout",function(a,b,c){function d(b){var c=this;c.sceneApi=b,c.mdxObject=new a(b)}return d.prototype={drawBB:function(){},draw:function(a){this.mdxObject.draw(a,this.placementMatrix,4294967295)},createPlacementMatrix:function(a){var b=533.333333333,c=a.pos.x-32*b,d=a.pos.y,e=a.pos.z-32*b,f=mat4.create();mat4.identity(f),mat4.rotateX(f,f,glMatrix.toRadian(90)),mat4.rotateY(f,f,glMatrix.toRadian(-90)),mat4.translate(f,f,[c,d,e]),mat4.rotateY(f,f,glMatrix.toRadian(a.rotation.y-90)),mat4.rotateZ(f,f,glMatrix.toRadian(-a.rotation.x)),mat4.rotateX(f,f,glMatrix.toRadian(a.rotation.z)),mat4.scale(f,f,[a.scale/1024,a.scale/1024,a.scale/1024]),mat4.rotateX(f,f,glMatrix.toRadian(-90));var g=mat4.create();mat4.invert(g,f),this.placementInvertMatrix=g,this.placementMatrix=f},load:function(a){var b=this;b.mddf=a,b.createPlacementMatrix(a),b.mdxObject.load(a.fileName,0)}},d}])}(window,jQuery),function(a,b,c){var d=angular.module("js.wow.render.adtObjectFactory",["js.wow.render.adtM2ObjectFactory"]);d.factory("adtObjectFactory",["$q","adtM2ObjectFactory",function(a,b){function c(a,b){this.sceneApi=a,this.m2Array=[]}return c.prototype={loadM2s:function(){var a=this.adtGeom.adtFile.mddf;this.m2Array=[];for(var b=0;b<a.length;b++){var c=a[b];this.sceneApi.loadAdtM2Obj(c)}},loadM2:function(a,c){var d=this;d.m2Array[a]=new b(d.sceneApi),d.m2Array[a].load(c,!1)},loadWmos:function(){var a=this,b=this.adtGeom.adtFile.wmoObjs;this.wmoArray=[],b.forEach(function(b){a.sceneApi.loadAdtWmo(b)})},load:function(a){var b=this,c=this.sceneApi.loadAdtGeom(a);c.then(function(a){b.adtGeom=a,b.loadM2s(),b.loadWmos()})},draw:function(a){this.adtGeom&&this.adtGeom.draw()}},c}])}(window,jQuery),function(a,b,c){var d=angular.module("js.wow.render.wmoM2ObjectFactory",["js.wow.render.mdxObject"]);d.factory("wmoM2ObjectFactory",["mdxObject","$q","$timeout",function(a,b,c){function d(b){var c=this;c.sceneApi=b,c.mdxObject=new a(b)}return d.prototype={draw:function(a){this.mdxObject.draw(a,this.placementMatrix,this.diffuseColor)},createPlacementMatrix:function(a,b){var c=mat4.create();mat4.identity(c),mat4.multiply(c,c,b),mat4.translate(c,c,[a.pos.x,a.pos.y,a.pos.z]);var d=mat4.create();mat4.fromQuat(d,[a.rotation.imag.x,a.rotation.imag.y,a.rotation.imag.z,a.rotation.real]),mat4.multiply(c,c,d),mat4.scale(c,c,[a.scale,a.scale,a.scale]);var e=mat4.create();mat4.invert(e,c),this.placementInvertMatrix=e,this.placementMatrix=c},load:function(a,b,c){var d=this;d.doodad=a,c?d.diffuseColor=a.color:d.diffuseColor=4294967295,d.createPlacementMatrix(a,b),d.mdxObject.load(a.modelName,0)}},d}])}(window,jQuery),function(a,b,c){var d=angular.module("js.wow.render.wmoObjectFactory",["js.wow.render.wmoM2ObjectFactory"]);d.factory("wmoObjectFactory",["$q","$timeout","wmoM2ObjectFactory",function(a,b,c){function d(a){var b=this;b.sceneApi=a,b.wmoGroupArray=[],b.doodadsArray=[]}return d.prototype={loadGeom:function(a,b){var c=this;c.sceneApi.loadWmoGeom(b).then(function(b){c.wmoGroupArray[a]=b,b.loadTextures(c.wmoObj.momt)},function(){})},checkIfUseLocalLighting:function(a){for(var b=null,c=0;c<this.wmoObj.nGroups;c++){var d=this.wmoObj.groupInfos[c],e=d.bb1,f=d.bb2;e.x<=a.x&&a.x<=f.x&&e.y<=a.y&&a.y<=f.y&&e.z<=a.z&&a.z<=f.z&&(b=d)}return b&&(8192&b.flags)>0?!0:!1},createPlacementMatrix:function(a){var b=533.333333333,c=a.pos.x-32*b,d=a.pos.y,e=a.pos.z-32*b,f=mat4.create();mat4.identity(f),mat4.rotateX(f,f,glMatrix.toRadian(90)),mat4.rotateY(f,f,glMatrix.toRadian(-90)),mat4.translate(f,f,[c,d,e]),mat4.rotateY(f,f,glMatrix.toRadian(a.rotation.y-90)),mat4.rotateZ(f,f,glMatrix.toRadian(-a.rotation.x)),mat4.rotateX(f,f,glMatrix.toRadian(a.rotation.z)),mat4.rotateX(f,f,glMatrix.toRadian(-90));var g=mat4.create();mat4.invert(g,f),this.placementInvertMatrix=g,this.placementMatrix=f},loadDoodads:function(a){var b=this,c=b.wmoObj.modd[a];this.doodadsArray=[];for(var d=0;d<c.doodads.length;d++){var e=c.doodads[d];this.loadDoodad(d,e)}},loadDoodad:function(a,b){var d=this;d.doodadsArray[a]=new c(d.sceneApi);var e=d.checkIfUseLocalLighting(b.pos);d.doodadsArray[a].load(b,d.placementMatrix,e)},load:function(b){var c=a.defer(),d=this,e=b.fileName,f=b.doodadSet;d.createPlacementMatrix(b);var g=d.sceneApi.loadWmoMain(e);return g.then(function(a){d.wmoObj=a,d.wmoGroupArray=[],d.wmoGroupArray.length=a.nGroups;for(var b=e.substr(0,e.lastIndexOf(".")),g=0;g<a.nGroups;g++){for(var h=g.toString();3!=h.length;)h="0"+h;d.loadGeom(g,b+"_"+h+".wmo")}d.loadDoodads(f),c.resolve(d)},function(){}),c.promise},drawBB:function(){for(var a=this.sceneApi.getGlContext(),b=this.sceneApi.getShaderUniforms(),c=0;c<this.wmoGroupArray.length;c++){var d=this.wmoObj.groupInfos[c],e=d.bb1,f=d.bb2,g=[(e.x+f.x)/2,(e.y+f.y)/2,(e.z+f.z)/2],h=[f.x-g[0],f.y-g[1],f.z-g[2]];a.uniform3fv(b.uBBScale,new Float32Array(h)),a.uniform3fv(b.uBBCenter,new Float32Array(g)),a.drawElements(a.LINES,48,a.UNSIGNED_SHORT,0)}},draw:function(){var a=this.sceneApi.getGlContext(),b=this.sceneApi.getShaderUniforms();this.placementMatrix&&a.uniformMatrix4fv(b.uPlacementMat,!1,this.placementMatrix);for(var c=0;c<this.wmoGroupArray.length;c++)this.wmoGroupArray[c]&&this.wmoGroupArray[c].draw();for(var c=0;c<this.doodadsArray.length;c++)this.doodadsArray[c].draw()}},d}])}(window,jQuery),function(a,b,c){var d=angular.module("js.wow.render.scene",["js.wow.render.geometry.wmoGeomCache","js.wow.render.geometry.wmoMainCache","js.wow.render.geometry.m2GeomCache","js.wow.render.geometry.skinGeomCache","js.wow.render.geometry.adtGeomCache","js.wow.render.wmoObjectFactory","js.wow.render.adtObjectFactory","js.wow.render.texture.textureCache","js.wow.render.camera.firstPersonCamera"]);d.factory("scene",["$q","$timeout","$http","wdtLoader","adtM2ObjectFactory","adtObjectFactory","wmoObjectFactory","wmoMainCache","wmoGeomCache","textureWoWCache","m2GeomCache","skinGeomCache","adtGeomCache","firstPersonCamera",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){function o(a){var b=new Stats;b.setMode(1),b.domElement.style.position="absolute",b.domElement.style.left="0px",b.domElement.style.top="0px",document.body.appendChild(b.domElement),this.stats=b;var c=this;c.enableDeferred=!1,c.sceneObjectList=[],c.sceneAdts=[],c.initGlContext(a),c.initShaders().then(function(){c.isShadersLoaded=!0},function(){}),c.initSceneApi(),c.enableDeferred&&c.initDeferredRendering(),c.initBoxVBO(),c.initAdtTexCoords(),c.initCaches(),c.initCamera(a,document)}return o.prototype={compileShader:function(a,b){var c=this.gl,d=c.createShader(c.VERTEX_SHADER);c.shaderSource(d,"#define COMPILING_VS 1\r\n "+a),c.compileShader(d);var e=c.getShaderParameter(d,c.COMPILE_STATUS);if(!e)throw"could not compile shader:"+c.getShaderInfoLog(d);var f=c.createShader(c.FRAGMENT_SHADER);c.shaderSource(f,"#define COMPILING_FS 1\r\n "+b),c.compileShader(f);var e=c.getShaderParameter(f,c.COMPILE_STATUS);if(!e)throw"could not compile shader:"+c.getShaderInfoLog(f);var g=c.createProgram();c.attachShader(g,d),c.attachShader(g,f),c.linkProgram(g);var e=c.getProgramParameter(g,c.LINK_STATUS);if(!e)throw"program filed to link:"+c.getProgramInfoLog(g);var h={};h.program=g;for(var i={},j=c.getProgramParameter(g,c.ACTIVE_ATTRIBUTES),k=0;j>k;++k){var l=c.getActiveAttrib(g,k);if(!l)break;var m=c.getAttribLocation(g,l.name);i[l.name]=m}h.shaderAttributes=i;for(var n={},o=c.getProgramParameter(g,c.ACTIVE_UNIFORMS),k=0;o>k;++k){var p=c.getActiveUniform(g,k);if(!p)break;var q=p.name;"[0]"===q.substr(-3)&&(q=q.substr(0,q.length-3));var r=c.getUniformLocation(g,q);n[q]=r}return h.shaderUniforms=n,h},initGlContext:function(a){function b(a,b,c){throw WebGLDebugUtils.glEnumToString(a)+" was caused by call to: "+b}try{var c=a.getContext("webgl",{premultipliedAlpha:!1})||a.getContext("experimental-webgl",{premultipliedAlpha:!1});c=WebGLDebugUtils.makeDebugContext(c,b)}catch(d){}c||(alert("Unable to initialize WebGL. Your browser may not support it."),c=null),this.gl=c,this.canvas=a},initDeferredRendering:function(){var a=this.gl,b=a.getExtension("WEBGL_draw_buffers");if(b){a.getExtension("WEBGL_depth_texture"),a.getExtension("OES_texture_float"),a.getExtension("OES_texture_float_linear"),this.deferredRendering=!0;var c=a.createTexture(),d=a.createTexture(),e=a.createTexture(),f=a.createTexture(),g=a.createTexture();a.bindTexture(a.TEXTURE_2D,c),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),a.texImage2D(a.TEXTURE_2D,0,a.DEPTH_COMPONENT,this.canvas.width,this.canvas.height,0,a.DEPTH_COMPONENT,a.UNSIGNED_SHORT,null),a.bindTexture(a.TEXTURE_2D,d),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),a.texImage2D(a.TEXTURE_2D,0,a.RGBA,this.canvas.width,this.canvas.height,0,a.RGBA,a.FLOAT,null),a.bindTexture(a.TEXTURE_2D,e),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),a.texImage2D(a.TEXTURE_2D,0,a.RGBA,this.canvas.width,this.canvas.height,0,a.RGBA,a.FLOAT,null),a.bindTexture(a.TEXTURE_2D,f),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),a.texImage2D(a.TEXTURE_2D,0,a.RGBA,this.canvas.width,this.canvas.height,0,a.RGBA,a.FLOAT,null),a.bindTexture(a.TEXTURE_2D,g),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),a.texImage2D(a.TEXTURE_2D,0,a.RGBA,this.canvas.width,this.canvas.height,0,a.RGBA,a.FLOAT,null);var h=a.createFramebuffer();a.bindFramebuffer(a.FRAMEBUFFER,h);var i=[];i[0]=b.COLOR_ATTACHMENT0_WEBGL,i[1]=b.COLOR_ATTACHMENT1_WEBGL,i[2]=b.COLOR_ATTACHMENT2_WEBGL,i[3]=b.COLOR_ATTACHMENT3_WEBGL,b.drawBuffersWEBGL(i),a.framebufferTexture2D(a.FRAMEBUFFER,a.DEPTH_ATTACHMENT,a.TEXTURE_2D,c,0),a.framebufferTexture2D(a.FRAMEBUFFER,i[0],a.TEXTURE_2D,g,0),a.framebufferTexture2D(a.FRAMEBUFFER,i[1],a.TEXTURE_2D,d,0),a.framebufferTexture2D(a.FRAMEBUFFER,i[2],a.TEXTURE_2D,e,0),a.framebufferTexture2D(a.FRAMEBUFFER,i[3],a.TEXTURE_2D,f,0),a.bindFramebuffer(a.FRAMEBUFFER,null)}},initShaders:function(){var b=this,d=null,e=[];return d=c.get("glsl/WmoShader.glsl").then(function(a){var c=a.data,d=b.compileShader(c,c);b.wmoShader=d},function(){throw"could not load shader"}),e.push(d),d=c.get("glsl/drawBBShader.glsl").then(function(a){var c=a.data,d=b.compileShader(c,c);b.bbShader=d},function(){throw"could not load shader"}),e.push(d),d=c.get("glsl/adtShader.glsl").then(function(a){var c=a.data,d=b.compileShader(c,c);b.adtShader=d},function(){throw"could not load shader"}),e.push(d),a.all(e)},initAdtTexCoords:function(){for(var a=[],b=0,c=0;17>c;c++){var d;d=0==(1&c)?9:8;for(var e=0;d>e;e++){var f=1/8*e,g=1/17*c;0==(2&c)&&(f+=.5/8),a[b]=f,b++,a[b]=g,b++}}this.adtTextureCoords=a},initCaches:function(){this.wmoGeomCache=new i(this.sceneApi),this.wmoMainCache=new h(this.sceneApi),this.textureCache=new j(this.sceneApi),this.m2GeomCache=new k(this.sceneApi),this.skinGeomCache=new l(this.sceneApi),this.adtGeomCache=new m(this.sceneApi)},initSceneApi:function(){var b=this;this.sceneApi={getGlContext:function(){return b.gl},getShaderUniforms:function(){return b.currentShaderProgram.shaderUniforms},getShaderAttributes:function(){return b.currentShaderProgram.shaderAttributes},getAdtTexCoordinates:function(){return b.adtTextureCoords},getCurrentWdt:function(){return b.currentWdt},loadAdtM2Obj:function(c){var d=a.defer(),f=new e(this);return f.load(c,!1),b.sceneObjectList.push(f),d.resolve(f),d.promise},loadAdtWmo:function(a){var c=new g(b.sceneApi);c.load(a),b.sceneObjectList.push(c)},loadTexture:function(a){return b.textureCache.loadTexture(a)},unLoadTexture:function(a){b.textureCache.unLoadTexture(a)},loadWmoMain:function(a){return b.wmoMainCache.loadWmoMain(a)},unloadWmoMain:function(a){b.wmoMainCache.unloadWmoMain(a)},loadWmoGeom:function(a){return b.wmoGeomCache.loadWmoGeom(a)},unloadWmoGeom:function(a){b.wmoGeomCache.unLoadWmoGeom(a)},loadM2Geom:function(a){return b.m2GeomCache.loadM2(a)},unloadM2Geom:function(a){b.m2GeomCache.unLoadM2(a)},loadSkinGeom:function(a){return b.skinGeomCache.loadSkin(a)},unloadSkinGeom:function(a){b.skinGeomCache.unLoadSkin(a)},loadAdtGeom:function(a){return b.adtGeomCache.loadAdt(a)},unloadAdtGeom:function(a){b.adtGeomCache.unLoadAdt(a)}}},initCamera:function(a,b){this.camera=n(a,b)},initBoxVBO:function(){var a=this.gl,b=[-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,-1,1,1,1,1,1,1,1,-1,-1,1,-1],c=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,c),a.bufferData(a.ARRAY_BUFFER,new Float32Array(b),a.STATIC_DRAW),a.bindBuffer(a.ARRAY_BUFFER,null);var d=[0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,7,6,6,1,1,0,0,7,3,2,2,5,5,4,4,3,6,5,5,2,2,1,1,6,0,3,3,4,4,7,7,0],e=a.createBuffer();a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,e),a.bufferData(a.ELEMENT_ARRAY_BUFFER,new Int16Array(d),a.STATIC_DRAW),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,null),this.bbBoxVars={vbo_vertices:c,ibo_elements:e}},glClearScreen:function(a){a.clearDepth(1),a.enable(a.DEPTH_TEST),a.depthFunc(a.LEQUAL),a.disable(a.BLEND),a.clearColor(.6,.95,1,1),a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT),a.disable(a.CULL_FACE)},draw:function(a){var b=this.gl,c=this.camera.tick(a),d=[];mat4.lookAt(d,c.cameraVec3,c.lookAtVec3,[0,0,1]);var e=[];if(mat4.perspective(e,45,this.canvas.width/this.canvas.height,1,1e3),this.isShadersLoaded){if(this.glClearScreen(b),b.activeTexture(b.TEXTURE0),this.stats.begin(),this.currentShaderProgram=this.bbShader,this.currentShaderProgram){b.useProgram(this.currentShaderProgram.program),b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,this.bbBoxVars.ibo_elements),b.bindBuffer(b.ARRAY_BUFFER,this.bbBoxVars.vbo_vertices),b.enableVertexAttribArray(this.currentShaderProgram.shaderAttributes.aPosition),b.vertexAttribPointer(this.currentShaderProgram.shaderAttributes.aPosition,3,b.FLOAT,!1,0,0),b.uniformMatrix4fv(this.currentShaderProgram.shaderUniforms.uLookAtMat,!1,d),b.uniformMatrix4fv(this.currentShaderProgram.shaderUniforms.uPMatrix,!1,e);for(var f=0;f<this.sceneObjectList.length;f++){var g=this.sceneObjectList[f];g.drawBB()}}if(this.currentShaderProgram=this.adtShader,this.currentShaderProgram){b.useProgram(this.currentShaderProgram.program),b.uniformMatrix4fv(this.currentShaderProgram.shaderUniforms.uLookAtMat,!1,d),b.uniformMatrix4fv(this.currentShaderProgram.shaderUniforms.uPMatrix,!1,e),this.currentWdt&&(4&this.currentWdt.flags)>0?b.uniform1i(this.currentShaderProgram.shaderUniforms.uNewFormula,1):b.uniform1i(this.currentShaderProgram.shaderUniforms.uNewFormula,0),b.uniform1i(this.currentShaderProgram.shaderUniforms.layer0,0),
b.uniform1i(this.currentShaderProgram.shaderUniforms.alphaTexture,1),b.uniform1i(this.currentShaderProgram.shaderUniforms.layer1,2),b.uniform1i(this.currentShaderProgram.shaderUniforms.layer2,3),b.uniform1i(this.currentShaderProgram.shaderUniforms.layer3,4);for(var f=0;f<this.sceneAdts.length;f++)this.sceneAdts[f].draw()}if(this.currentShaderProgram=this.wmoShader,this.currentShaderProgram){b.useProgram(this.currentShaderProgram.program),b.uniformMatrix4fv(this.currentShaderProgram.shaderUniforms.uLookAtMat,!1,d),b.uniformMatrix4fv(this.currentShaderProgram.shaderUniforms.uPMatrix,!1,e),b.activeTexture(b.TEXTURE0);var f;for(f=0;f<this.sceneObjectList.length;f++){var g=this.sceneObjectList[f];g.draw(a)}}return this.stats.end(),c}},loadWMOMap:function(a){var b=new g(this.sceneApi);b.load(a,0),this.sceneObjectList=[b]},loadMap:function(a,b,c){var e=this,g="world/maps/"+a+"/"+a+".wdt";d(g).then(function(d){e.currentWdt=d;var g="world/maps/"+a+"/"+a+"_"+b+"_"+c+".adt",h=new f(e.sceneApi);h.load(g),e.sceneAdts=[h]},function(){})},setCameraPos:function(a,b,c){this.camera.setCameraPos(a,b,c)}},o}])}(window,jQuery),function(a,b,c){function d(a){this.gl=a.getGlContext(),this.texture=null,this.loadFromMipmaps=function(a,b){var d=this.gl;this.texture=d.createTexture(),d.bindTexture(d.TEXTURE_2D,this.texture);var e=d.getExtension("WEBGL_compressed_texture_s3tc")||d.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||d.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),f=null;if(e)switch(b){case"S3TC_RGB_DXT1":f=e.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case"S3TC_RGBA_DXT1":f=e.COMPRESSED_RGBA_S3TC_DXT1_EXT;break;case"S3TC_RGBA_DXT3":f=e.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case"S3TC_RGBA_DXT5":f=e.COMPRESSED_RGBA_S3TC_DXT5_EXT}var g=!(e!=c&&e.COMPRESSED_RGB_S3TC_DXT1_EXT!=c&&e!=c&&e.COMPRESSED_RGBA_S3TC_DXT1_EXT!=c),h=!(e!=c&&e.COMPRESSED_RGBA_S3TC_DXT3_EXT!=c),i=!(e!=c&&e.COMPRESSED_RGBA_S3TC_DXT5_EXT!=c);g=g||("S3TC_RGB_DXT1"===b||"S3TC_RGBA_DXT1"===b)&&a[0].width!==a[0].height;switch(b){case"S3TC_RGB_DXT1":case"S3TC_RGBA_DXT1":for(var j=0;j<a.length;j++)if(g){var k=dxtLib.decodeDXT1toBitmap32(a[j].texture,a[j].width,a[j].height);d.texImage2D(d.TEXTURE_2D,j,d.RGBA,a[j].width,a[j].height,0,d.RGBA,d.UNSIGNED_BYTE,k.decData)}else d.compressedTexImage2D(d.TEXTURE_2D,j,f,a[j].width,a[j].height,0,a[j].texture);break;case"S3TC_RGBA_DXT3":for(var j=0;j<a.length;j++)if(h){var k=dxtLib.decodeDXT3toBitmap32(a[j].texture,a[j].width,a[j].height);d.texImage2D(d.TEXTURE_2D,j,d.RGBA,a[j].width,a[j].height,0,d.RGBA,d.UNSIGNED_BYTE,k.decData)}else d.compressedTexImage2D(d.TEXTURE_2D,j,f,a[j].width,a[j].height,0,a[j].texture);break;case"S3TC_RGBA_DXT5":for(var j=0;j<a.length;j++)if(i){var k=dxtLib.decodeDXT5toBitmap32(a[j].texture,a[j].width,a[j].height);d.texImage2D(d.TEXTURE_2D,j,d.RGBA,a[j].width,a[j].height,0,d.RGBA,d.UNSIGNED_BYTE,k.decData)}else d.compressedTexImage2D(d.TEXTURE_2D,j,f,a[j].width,a[j].height,0,a[j].texture);break;case"BGRA":for(var j=0;j<a.length;j++)d.texImage2D(d.TEXTURE_2D,0,d.RGBA,a[j].width,a[j].height,0,d.RGBA,d.UNSIGNED_BYTE,a[j].texture)}d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,d.LINEAR_MIPMAP_LINEAR),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,d.LINEAR),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,d.REPEAT),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,d.REPEAT),d.bindTexture(d.TEXTURE_2D,null)},this.destroy=function(){var a=this.gl;this.texture&&a.deleteTexture(this.texture),this.texture=null}}var e=angular.module("js.wow.render.texture.textureCache",["main.services.map.blpLoader","js.wow.render.cacheTemplate"]);e.factory("textureWoWCache",["blpLoader","cacheTemplate","$q",function(a,b,c){function e(c){var e=this,f=b(function(b){return a(b)},function(a){var b=new d(c);return b.loadFromMipmaps(a.mipmaps,a.textureFormat),b.fileName=a.fileName,b});e.loadTexture=function(a){var b=a.toLowerCase();return f.get(b)},e.unLoadTexture=function(a){f.remove(a)}}return e}])}(window,jQuery);
//# sourceMappingURL=application.min.js.map