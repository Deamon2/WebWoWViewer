"use strict";function MathHelper(){}angular.module("main.glsl.cache",[]).run(["$templateCache",function(a){a.put("glsl/WmoShader.glsl","//https://www.khronos.org/registry/webgl/extensions/WEBGL_draw_buffers/\r\n//For drawbuffers in glsl of webgl you need to use GL_EXT_draw_buffers instead of WEBGL_draw_buffers\r\n\r\n#ifdef ENABLE_DEFERRED\r\n#ifdef GL_EXT_draw_buffers\r\n    #extension GL_EXT_draw_buffers: require\r\n    #extension OES_texture_float_linear : enable\r\n    #define drawBuffersIsSupported 1\r\n#endif\r\n#endif\r\n\r\n#ifdef COMPILING_VS\r\n/* vertex shader code */\r\nattribute vec3 aPosition;\r\nattribute vec3 aNormal;\r\nattribute vec2 aTexCoord;\r\nattribute vec2 aTexCoord2;\r\nattribute vec4 aColor;\r\nattribute vec4 aColor2;\r\n\r\nuniform mat4 uLookAtMat;\r\nuniform mat4 uPMatrix;\r\n\r\n#ifdef INSTANCED\r\nattribute mat4 uPlacementMat;\r\n#else\r\nuniform mat4 uPlacementMat;\r\n#endif\r\n\r\nvarying vec2 vTexCoord;\r\nvarying vec2 vTexCoord2;\r\nvarying vec4 vColor;\r\nvarying vec4 vColor2;\r\n\r\n#ifdef drawBuffersIsSupported\r\nvarying vec3 vNormal;\r\nvarying vec3 vPosition;\r\nvarying float fs_Depth;\r\n#endif\r\n\r\nvoid main() {\r\n    vec4 worldPoint = uPlacementMat * vec4(aPosition, 1);\r\n\r\n    vec4 cameraPoint = uLookAtMat * worldPoint;\r\n\r\n    vTexCoord = aTexCoord;\r\n    vTexCoord2 = aTexCoord2;\r\n    vColor = aColor;\r\n    vColor2 = aColor2;\r\n\r\n#ifndef drawBuffersIsSupported\r\n    gl_Position = uPMatrix * cameraPoint;\r\n#else\r\n    gl_Position = uPMatrix * cameraPoint;\r\n    fs_Depth = gl_Position.z / gl_Position.w;\r\n\r\n    vNormal = normalize((uPlacementMat * vec4(aNormal, 0)).xyz);\r\n    vPosition = cameraPoint.xyz;\r\n#endif //drawBuffersIsSupported\r\n\r\n}\r\n#endif //COMPILING_VS\r\n\r\n#ifdef COMPILING_FS\r\n\r\nprecision lowp float;\r\nvarying vec3 vNormal;\r\nvarying vec2 vTexCoord;\r\nvarying vec2 vTexCoord2;\r\nvarying vec4 vColor;\r\nvarying vec4 vColor2;\r\nvarying vec3 vPosition;\r\n\r\n//uniform vec4  uGlobalLighting;\r\nuniform float uAlphaTest;\r\nuniform sampler2D uTexture;\r\nuniform sampler2D uTexture2;\r\n\r\n#ifdef drawBuffersIsSupported\r\nvarying float fs_Depth;\r\n#endif\r\n\r\nvoid main() {\r\n    vec4 tex = texture2D(uTexture, vTexCoord).rgba;\r\n    vec4 tex2 = texture2D(uTexture2, vTexCoord2).rgba;\r\n\r\n    vec4 finalColor = vec4(\r\n        (tex.r * vColor.b) ,\r\n        (tex.g * vColor.g),\r\n        (tex.b * vColor.r),\r\n        tex.a );\r\n\r\n    if(finalColor.a < uAlphaTest)\r\n        discard;\r\n\r\n    //Apply global lighting\r\n/*\r\n    finalColor = vec4(\r\n        (finalColor.r + uGlobalLighting.r) ,\r\n        (finalColor.g + uGlobalLighting.g) ,\r\n        (finalColor.b + uGlobalLighting.b) ,\r\n        finalColor.a);\r\n  */\r\n    finalColor.a = 1.0; //do I really need it now?\r\n\r\n#ifndef drawBuffersIsSupported\r\n    //Forward rendering without lights\r\n    gl_FragColor = finalColor;\r\n#else\r\n    //Deferred rendering\r\n    //gl_FragColor = finalColor;\r\n    gl_FragData[0] = vec4(vec3(fs_Depth), 1.0);\r\n    gl_FragData[1] = vec4(vPosition.xyz,0);\r\n    gl_FragData[2] = vec4(vNormal.xyz,0);\r\n    gl_FragData[3] = finalColor;\r\n#endif //drawBuffersIsSupported\r\n}\r\n\r\n#endif //COMPILING_FS\r\n"),a.put("glsl/adtShader.glsl",'#ifdef COMPILING_VS\r\n/* vertex shader code */\r\nattribute float aHeight;\r\nattribute float aNormal;\r\nattribute float aIndex;\r\n\r\nuniform vec3 uPos;\r\nuniform mat4 uLookAtMat;\r\nuniform mat4 uPMatrix;\r\n\r\nvarying vec2 vChunkCoords;\r\n\r\nconst float UNITSIZE =  533.3433333 / 16.0 / 8.0;\r\n\r\nvoid main() {\r\n\r\n/*\r\n     Y\r\n  X  0    1    2    3    4    5    6    7    8\r\n        9   10   11   12   13   14   15   16\r\n*/\r\n    float iX = mod(aIndex, 17.0);\r\n    float iY = floor(aIndex/17.0);\r\n\r\n    vec4 worldPoint = vec4(\r\n        uPos.x - iY * UNITSIZE,\r\n        uPos.y - iX * UNITSIZE,\r\n        uPos.z + aHeight,\r\n        1);\r\n\r\n    vChunkCoords = vec2(iX, iY);\r\n\r\n    //On Intel Graphics ">" is equal to ">="\r\n    if (iX > 8.1) {\r\n        worldPoint.x = uPos.x - (iX - 8.5) * UNITSIZE;\r\n        worldPoint.y = uPos.x - (iY + 0.5) * UNITSIZE;\r\n        vChunkCoords.x = (iY-8.5);\r\n    }\r\n\r\n    gl_Position = uPMatrix * uLookAtMat * worldPoint;\r\n}\r\n#endif //COMPILING_VS\r\n\r\n#ifdef COMPILING_FS\r\nprecision lowp float;\r\n\r\nvarying vec2 vChunkCoords;\r\n\r\nuniform int uNewFormula;\r\n\r\nuniform sampler2D uLayer0;\r\nuniform sampler2D uLayer1;\r\nuniform sampler2D uLayer2;\r\nuniform sampler2D uLayer3;\r\nuniform sampler2D uAlphaTexture;\r\n\r\n/* Bicubic interpolation implementation */\r\n/* Taken from http://www.codeproject.com/Articles/236394/Bi-Cubic-and-Bi-Linear-Interpolation-with-GLSL#Triangular */\r\n\r\nfloat Triangular( float f )\r\n{\r\n	f = f / 2.0;\r\n	if( f < 0.0 )\r\n	{\r\n		return ( f + 1.0 );\r\n	}\r\n	else\r\n	{\r\n		return ( 1.0 - f );\r\n	}\r\n	return 0.0;\r\n}\r\n\r\nfloat CatMullRom( float x )\r\n{\r\n    const float B = 0.0;\r\n    const float C = 0.5;\r\n    float f = x;\r\n    if( f < 0.0 )\r\n    {\r\n        f = -f;\r\n    }\r\n    if( f < 1.0 )\r\n    {\r\n        return ( ( 12.0 - 9.0 * B - 6.0 * C ) * ( f * f * f ) +\r\n            ( -18.0 + 12.0 * B + 6.0 * C ) * ( f * f ) +\r\n            ( 6.0 - 2.0 * B ) ) / 6.0;\r\n    }\r\n    else if( f >= 1.0 && f < 2.0 )\r\n    {\r\n        return ( ( -B - 6.0 * C ) * ( f * f * f )\r\n            + ( 6.0 * B + 30.0 * C ) * ( f *f ) +\r\n            ( - ( 12.0 * B ) - 48.0 * C  ) * f +\r\n            8.0 * B + 24.0 * C)/ 6.0;\r\n    }\r\n    else\r\n    {\r\n        return 0.0;\r\n    }\r\n}\r\nvec4 BiCubic( sampler2D textureSampler, vec2 TexCoord, float widthMinClamp, float widthMaxClamp)\r\n{\r\n    float fWidth = 256.0;\r\n    float fHeight = 64.0;\r\n\r\n    float texelSizeX = 1.0 / fWidth; //size of one texel\r\n    float texelSizeY = 1.0 / fHeight; //size of one texel\r\n    vec4 nSum = vec4( 0.0, 0.0, 0.0, 0.0 );\r\n    vec4 nDenom = vec4( 0.0, 0.0, 0.0, 0.0 );\r\n    float a = fract( TexCoord.x * fWidth ); // get the decimal part\r\n    float b = fract( TexCoord.y * fHeight ); // get the decimal part\r\n    for( int m = -1; m <=2; m++ )\r\n    {\r\n        for( int n =-1; n<= 2; n++)\r\n        {\r\n            vec2 coords = TexCoord + vec2( texelSizeX * float( m ), texelSizeY * float( n ));\r\n\r\n            float xCoord = coords.x;\r\n            xCoord = max(widthMinClamp, xCoord);\r\n            xCoord = min(widthMaxClamp, xCoord);\r\n            coords.x = xCoord;\r\n\r\n            vec4 vecData = texture2D( textureSampler, coords);\r\n            float f  = Triangular( float( m ) - a );\r\n            vec4 vecCooef1 = vec4( f,f,f,f );\r\n            float f1 = Triangular ( -( float( n ) - b ) );\r\n            vec4 vecCoeef2 = vec4( f1, f1, f1, f1 );\r\n            nSum = nSum + ( vecData * vecCoeef2 * vecCooef1  );\r\n            nDenom = nDenom + (( vecCoeef2 * vecCooef1 ));\r\n        }\r\n    }\r\n    return nSum / nDenom;\r\n}\r\n/********************************/\r\n\r\nfloat filterFunc(float x) {\r\n  //x = ceil(x * 16.0)/16.0;\r\n\r\n  /*const float multiplier = 1.0;\r\n  const float additive =  0.0;\r\n  const float maxThreshold = 0.0;\r\n  const float minThreshold = 1.0;\r\n\r\n\r\n  x = x * multiplier + additive;\r\n  x = max(x, maxThreshold);\r\n  x = min(x, minThreshold);\r\n  return x;*/\r\n    return x;\r\n}\r\n\r\nvec3 mixTextures(vec3 tex0, vec3 tex1, float alpha) {\r\n    return  (alpha*(tex1.rgb-tex0.rgb)+tex0.rgb);\r\n}\r\n\r\nvoid main() {\r\n    vec2 vTexCoord = vChunkCoords;\r\n    const float threshold = 1.5;\r\n\r\n    vec2 a4Coords = vec2(3.0/4.0+ ((vChunkCoords.x/8.0) ) /4.0, vChunkCoords.y/8.0 );\r\n    vec2 a3Coords = vec2(2.0/4.0+ ((vChunkCoords.x/8.0) ) /4.0, vChunkCoords.y/8.0 );\r\n    vec2 a2Coords = vec2(1.0/4.0+ ((vChunkCoords.x/8.0) ) /4.0, vChunkCoords.y/8.0 );\r\n\r\n    vec3 tex4 = texture2D(uLayer3, vTexCoord).rgb;\r\n    float a4 = BiCubic(uAlphaTexture, a4Coords, 3.0/4.0, 3.999/4.0).a;\r\n    a4 = filterFunc(a4);\r\n\r\n    vec3 tex3 = texture2D(uLayer2, vTexCoord).rgb;\r\n    float a3 = BiCubic(uAlphaTexture, a3Coords, 2.0/4.0, 2.999/4.0).a;\r\n    a3 = filterFunc(a3);\r\n\r\n    vec3 tex2 = texture2D(uLayer1, vTexCoord).rgb;\r\n    float a2 = BiCubic(uAlphaTexture, a2Coords, 1.0/4.0, 1.999/4.0).a;\r\n    a2 = filterFunc(a2);\r\n\r\n    vec3 tex1 = texture2D(uLayer0, vTexCoord).rgb;\r\n    //vec4 a1 = texture2D(uTexture, vTexCoord).rgba;\r\n\r\n    //Mix formula for 4 texture mixing\r\n    vec4 finalColor;\r\n    if (uNewFormula >= 1) {\r\n        finalColor = vec4(tex1 * (1.0 - (a2 + a3 + a4)) + tex2 * a2 + tex3 * a3 + tex4* a4, 1);\r\n    } else {\r\n        finalColor = vec4(mixTextures(mixTextures(mixTextures(tex1,tex2,a2),tex3, a3), tex4, a4), 1);\r\n        //finalColor = vec4(a4 * tex4 - (a4  - 1.0) * ( (a3 - 1.0)*( tex1 * (a2 - 1.0) - a2*tex2) + a3*tex3), 1);\r\n    }\r\n\r\n    finalColor.a = 1.0;\r\n    gl_FragColor = finalColor;\r\n}\r\n\r\n#endif //COMPILING_FS'),a.put("glsl/drawBBShader.glsl","#ifdef COMPILING_VS\r\n/* vertex shader code */\r\nattribute vec3 aPosition;\r\n\r\nuniform vec3 uBBScale;\r\nuniform vec3 uBBCenter;\r\n\r\nuniform mat4 uLookAtMat;\r\nuniform mat4 uPMatrix;\r\nuniform mat4 uPlacementMat;\r\n\r\nvoid main() {\r\n    vec4 worldPoint = vec4(\r\n        aPosition.x*uBBScale.x + uBBCenter.x,\r\n        aPosition.y*uBBScale.y + uBBCenter.y,\r\n        aPosition.z*uBBScale.z + uBBCenter.z,\r\n    1);\r\n\r\n    gl_Position = uPMatrix * uLookAtMat * uPlacementMat * worldPoint;\r\n}\r\n#endif //COMPILING_VS\r\n\r\n#ifdef COMPILING_FS\r\nprecision lowp float;\r\n\r\nuniform vec3 uColor;\r\n\r\nvoid main() {\r\n    vec4 finalColor = vec4(uColor, 1.0);\r\n\r\n    finalColor.a = 1.0; //do I really need it now?\r\n    gl_FragColor = finalColor;\r\n}\r\n\r\n#endif //COMPILING_FS\r\n"),a.put("glsl/drawDepthShader.glsl","//Taken from http://media.tojicode.com/webgl-samples/depth-texture.html\r\n\r\n#ifdef COMPILING_VS\r\nattribute vec2 position;\r\nattribute vec2 texture;\r\nvarying vec2 texCoord;\r\n\r\nuniform float uWidth;\r\nuniform float uHeight;\r\nuniform float uX;\r\nuniform float uY;\r\n\r\n\r\nvoid main(void) {\r\n    texCoord = texture;\r\n\r\n    //gl_Position = vec4(position, 0.0, 1.0);\r\n          gl_Position = vec4(\r\n                (((position.x + 1.0)/2.0) * uWidth + uX)*2.0 - 1.0,\r\n                (((position.y + 1.0)/2.0) * uHeight + uY)*2.0 - 1.0,\r\n                0.0,\r\n                1.0)  ;\r\n}\r\n#endif //COMPILING_VS\r\n\r\n#ifdef COMPILING_FS\r\n\r\nprecision mediump float;\r\nuniform sampler2D diffuse;\r\nvarying vec2 texCoord;\r\n\r\nvoid main(void) {\r\n\r\n    float f = 1000.0; //far plane\r\n    float n = 1.0; //near plane\r\n    float z = (2.0 * n) / (f + n - texture2D( diffuse, texCoord ).x * (f - n));\r\n\r\n\r\n    //vec4 color = texture2D(diffuse, texCoord);\r\n    gl_FragColor = vec4(z,z,z, 255);\r\n}\r\n\r\n#endif //COMPILING_FS"),a.put("glsl/drawPortalShader.glsl","#ifdef COMPILING_VS\r\n/* vertex shader code */\r\nattribute vec3 aPosition;\r\n\r\nuniform mat4 uLookAtMat;\r\nuniform mat4 uPMatrix;\r\nuniform mat4 uPlacementMat;\r\n\r\nvoid main() {\r\n    vec4 worldPoint = vec4(aPosition.xyz, 1);\r\n\r\n    gl_Position = uPMatrix * uLookAtMat * uPlacementMat * worldPoint;\r\n}\r\n#endif //COMPILING_VS\r\n\r\n#ifdef COMPILING_FS\r\nprecision lowp float;\r\n\r\nuniform vec4 uColor;\r\n\r\nvoid main() {\r\n    vec4 finalColor = uColor ;\r\n\r\n    gl_FragColor = finalColor;\r\n}\r\n\r\n#endif //COMPILING_FS\r\n"),a.put("glsl/m2Shader.glsl","//https://www.khronos.org/registry/webgl/extensions/WEBGL_draw_buffers/\r\n//For drawbuffers in glsl of webgl you need to use GL_EXT_draw_buffers instead of WEBGL_draw_buffers\r\n\r\n#ifdef ENABLE_DEFERRED\r\n#ifdef GL_EXT_draw_buffers\r\n    #extension GL_EXT_draw_buffers: require\r\n    #extension OES_texture_float_linear : enable\r\n    #define drawBuffersIsSupported 1\r\n#endif\r\n#endif\r\n\r\n#ifdef COMPILING_VS\r\n/* vertex shader code */\r\nattribute vec3 aPosition;\r\nattribute vec3 aNormal;\r\nattribute vec4 bones;\r\nattribute vec4 boneWeights;\r\nattribute vec2 aTexCoord;\r\nattribute vec2 aTexCoord2;\r\n\r\nattribute vec4 aColor;\r\n\r\nuniform mat4 uLookAtMat;\r\nuniform mat4 uPMatrix;\r\nuniform int isBillboard;\r\nuniform mat4 uBoneMatrixes[59]; //Max 59 for ANGLE implementation and max 100 bones in Wotlk client\r\n\r\n#ifdef INSTANCED\r\nattribute mat4 uPlacementMat;\r\n#else\r\nuniform mat4 uPlacementMat;\r\n#endif\r\n\r\nvarying vec2 vTexCoord;\r\nvarying vec2 vTexCoord2;\r\nvarying vec4 vColor;\r\n\r\n#ifdef drawBuffersIsSupported\r\nvarying vec3 vNormal;\r\nvarying vec3 vPosition;\r\nvarying float fs_Depth;\r\n#endif\r\n\r\n\r\nmat3 inverse(mat3 m) {\r\n    float a00 = m[0][0], a01 = m[0][1], a02 = m[0][2];\r\n    float a10 = m[1][0], a11 = m[1][1], a12 = m[1][2];\r\n    float a20 = m[2][0], a21 = m[2][1], a22 = m[2][2];\r\n\r\n    float b01 =  a22 * a11 - a12 * a21;\r\n    float b11 = -a22 * a10 + a12 * a20;\r\n    float b21 =  a21 * a10 - a11 * a20;\r\n\r\n    float det = a00 * b01 + a01 * b11 + a02 * b21;\r\n\r\n    return mat3(b01, (-a22 * a01 + a02 * a21), (a12 * a01 - a02 * a11),\r\n                b11, (a22 * a00 - a02 * a20), (-a12 * a00 + a02 * a10),\r\n                b21, (-a21 * a00 + a01 * a20), (a11 * a00 - a01 * a10)) / det;\r\n}\r\n\r\nvoid main() {\r\n    vec4 modelPoint = vec4(0,0,0,0);\r\n    vec4 aPositionVec4 = vec4(aPosition, 1);\r\n\r\n    modelPoint += (boneWeights.x ) * (uBoneMatrixes[int(bones.x)] * aPositionVec4);\r\n    modelPoint += (boneWeights.y ) * (uBoneMatrixes[int(bones.y)] * aPositionVec4);\r\n    modelPoint += (boneWeights.z ) * (uBoneMatrixes[int(bones.z)] * aPositionVec4);\r\n    modelPoint += (boneWeights.w ) * (uBoneMatrixes[int(bones.w)] * aPositionVec4);\r\n\r\n    vec4 cameraPoint = uLookAtMat * uPlacementMat * vec4(modelPoint.xyz, 1);\r\n\r\n    vTexCoord = aTexCoord;\r\n    vTexCoord2 = aTexCoord2;\r\n    vColor = aColor;\r\n\r\n#ifndef drawBuffersIsSupported\r\n    gl_Position = uPMatrix * cameraPoint;\r\n#else\r\n    gl_Position = uPMatrix * cameraPoint;\r\n    fs_Depth = gl_Position.z / gl_Position.w;\r\n\r\n    vNormal = normalize((uPlacementMat * vec4(aNormal, 0)).xyz);\r\n    vPosition = cameraPoint.xyz;\r\n#endif //drawBuffersIsSupported\r\n\r\n}\r\n#endif //COMPILING_VS\r\n\r\n#ifdef COMPILING_FS\r\n\r\nprecision lowp float;\r\nvarying vec3 vNormal;\r\nvarying vec2 vTexCoord;\r\nvarying vec2 vTexCoord2;\r\nvarying vec4 vColor;\r\nvarying vec3 vPosition;\r\n\r\n//uniform vec4  uGlobalLighting;\r\nuniform float uAlphaTest;\r\nuniform sampler2D uTexture;\r\nuniform sampler2D uTexture2;\r\n\r\nuniform mat4 uTextMat1;\r\nuniform mat4 uTextMat2;\r\n\r\n#ifdef drawBuffersIsSupported\r\nvarying float fs_Depth;\r\n#endif\r\n\r\nvoid main() {\r\n    /* Animation support */\r\n    vec2 texCoord =  (uTextMat1 * vec4(vTexCoord, 0, 1)).xy;\r\n    vec2 texCoord2 = (uTextMat2 * vec4(vTexCoord2, 0, 1)).xy;\r\n\r\n    /* Get color from texture */\r\n    vec4 tex = texture2D(uTexture, texCoord).rgba;\r\n    vec4 tex2 = texture2D(uTexture2, texCoord2).rgba;\r\n\r\n    vec4 finalColor = vec4(\r\n        (tex.r * vColor.b) ,\r\n        (tex.g * vColor.g) ,\r\n        (tex.b * vColor.r) ,\r\n        tex.a * vColor.a);\r\n\r\n    finalColor = finalColor * tex2;\r\n\r\n    if(finalColor.a < uAlphaTest)\r\n        discard;\r\n\r\n    //Apply global lighting\r\n/*\r\n    finalColor = vec4(\r\n        (finalColor.r + uGlobalLighting.r) ,\r\n        (finalColor.g + uGlobalLighting.g) ,\r\n        (finalColor.b + uGlobalLighting.b) ,\r\n        finalColor.a);\r\n  */\r\n    //finalColor.a = 1.0; //do I really need it now?\r\n\r\n#ifndef drawBuffersIsSupported\r\n    //Forward rendering without lights\r\n    gl_FragColor = finalColor;\r\n#else\r\n    //Deferred rendering\r\n    //gl_FragColor = finalColor;\r\n    gl_FragData[0] = vec4(vec3(fs_Depth), 1.0);\r\n    gl_FragData[1] = vec4(vPosition.xyz,0);\r\n    gl_FragData[2] = vec4(vNormal.xyz,0);\r\n    gl_FragData[3] = finalColor;\r\n#endif //drawBuffersIsSupported\r\n}\r\n\r\n#endif //COMPILING_FS\r\n"),a.put("glsl/readDepthBuffer.glsl","#ifdef COMPILING_VS\r\nattribute vec2 position;\r\nattribute vec2 texture;\r\nvarying vec2 v_texcoord;\r\n\r\nvoid main() {\r\n    v_texcoord = texture;\r\n    gl_Position = vec4(position, 0.0, 1.0);\r\n}\r\n\r\n#endif //COMPILING_VS\r\n\r\n#ifdef COMPILING_FS\r\nprecision mediump float;\r\nvarying vec2 v_texcoord;\r\nuniform sampler2D u_sampler;\r\n\r\nvoid main() {\r\n    float depth = texture2D(u_sampler, v_texcoord).x;\r\n    float depth65535 = depth * 65535.0;\r\n    float depth_high = floor(depth65535/256.0) / 255.0;\r\n    float depth_low = mod(depth65535, 256.0) / 255.0;\r\n\r\n    vec4 color = vec4(depth_high, depth_low, 0 ,0);\r\n\r\n    gl_FragColor = color;\r\n}\r\n\r\n#endif //COMPILING_FS"),a.put("glsl/renderFrameBufferShader.glsl","#ifdef ENABLE_DEFERRED\r\n    #extension OES_texture_float_linear : enable\r\n#endif\r\n\r\n#ifdef COMPILING_VS\r\nattribute vec4 a_position;\r\nvarying vec2 v_texcoord;\r\n\r\nvoid main() {\r\n      gl_Position = a_position;\r\n      v_texcoord = a_position.xy * 0.5 + 0.5;\r\n}\r\n#endif //COMPILING_VS\r\n\r\n#ifdef COMPILING_FS\r\n\r\nprecision mediump float;\r\nvarying vec2 v_texcoord;\r\nuniform sampler2D u_sampler;\r\nvoid main() {\r\n    gl_FragColor = vec4(texture2D(u_sampler, v_texcoord).rgb, 0);\r\n}\r\n\r\n#endif //COMPILING_FS\r\n\r\n\r\n#ifdef deffered_light\r\nprecision highp float;\r\n\r\n#define DISPLAY_DEPTH 0\r\n#define DISPLAY_NORMAL 1\r\n#define DISPLAY_POSITION 2\r\n#define DISPLAY_COLOR 3\r\n#define DISPLAY_TOTAL 4\r\n#define DISPLAY_LIGHTS 5\r\n#define DISPLAY_NONTILE_LIGHTS 6\r\n#define DISPLAY_INK 7\r\n#define DISPLAY_DEBUGTILE 8\r\n#define MAXLIGHTNUM 1000\r\n\r\nuniform sampler2D u_Depthtex;\r\nuniform sampler2D u_Normaltex;\r\nuniform sampler2D u_Positiontex;\r\nuniform sampler2D u_Colortex;\r\n//for light\r\nuniform sampler2D u_LightGridtex;\r\nuniform sampler2D u_LightIndextex;\r\nuniform sampler2D u_LightPositiontex;\r\nuniform sampler2D u_LightColorRadiustex;\r\nuniform int u_LightNum;\r\nuniform int u_DisplayType;\r\n//uniform float u_Far;\r\n//uniform float u_Near;\r\n//uniform float u_Width;\r\n//uniform float u_Height;\r\nuniform int u_MaxTileLightNum;\r\nuniform int u_TileSize;\r\n//uniform Light u_Lights[LIGHTNUM];\r\nuniform int u_LightIndexImageSize;\r\nuniform float u_FloatLightIndexSize;\r\nuniform float u_WidthTile;\r\nuniform float u_HeightTile;\r\nvarying vec2 fs_Texcoord;\r\nfloat linearizeDepth(float exp_depth, float near, float far) {\r\n    return  (2.0 * near) / (far + near -  exp_depth * (far - near));\r\n}\r\nvoid main(void)\r\n{\r\n    vec3 normal = texture2D(u_Normaltex, fs_Texcoord).xyz;\r\n    vec3 position = texture2D(u_Positiontex, fs_Texcoord).xyz;\r\n    vec3 color = texture2D(u_Colortex, fs_Texcoord).xyz;\r\n    //vec3 depth = texture2D(u_Depthtex, fs_Texcoord).xyz;\r\n    //float exp_depth = texture2D(u_Depthtex, fs_Texcoord).r;\r\n    //float lin_depth = linearizeDepth(exp_depth,u_Near,u_Far);\r\n    //get the grid data index\r\n    vec2 gridIndex = vec2(((fs_Texcoord.x*u_Width) / float(u_TileSize)) / (u_WidthTile), ((fs_Texcoord.y*u_Height) / float(u_TileSize)) / (u_HeightTile));\r\n    //x for offset, y for count\r\n    vec3 gridInfo = texture2D(u_LightGridtex, gridIndex).xyz;\r\n    int offset = int(gridInfo.x);\r\n    int count = int(gridInfo.y);\r\n    int offset2 = int(gridInfo.z);\r\n    vec3 lightColor = vec3(0.0);\r\n    int lightCount = 0;\r\n    if(count > 0){\r\n        for(int i = 0; i < MAXLIGHTNUM; i++){\r\n            if(i < count){\r\n                int lightId;\r\n                //float temp = (mod(float(offset+i), u_FloatLightIndexSize));\r\n                float temp = float(offset + i);\r\n                int addNext = 0;\r\n\r\n                if(temp >= u_FloatLightIndexSize){\r\n                    temp -= u_FloatLightIndexSize;\r\n                    addNext++;\r\n                }\r\n\r\n                //precision problem\r\n                if(temp == u_FloatLightIndexSize)\r\n                   temp = 0.0;\r\n                float lightSize =  u_FloatLightIndexSize-1.0;\r\n                vec2 dataIndex = vec2(\r\n                    temp / lightSize,\r\n                    //floor(float((offset2+i) / (u_LightIndexImageSize))) / (lightSize)\r\n                    float(offset2 + addNext) / lightSize\r\n                    );\r\n\r\n                //vec2 dataIndex = vec2(float(offset+i) / float(u_LightIndexImageSize-1), 1.0);\r\n                lightId = int((texture2D(u_LightIndextex, dataIndex).x));\r\n                vec3 lightPos = texture2D(u_LightPositiontex, vec2(float(lightId)/float(u_LightNum-1))).xyz;\r\n                vec4 lightColorRadius = texture2D(u_LightColorRadiustex, vec2(float(lightId)/float(u_LightNum-1))).xyzw;\r\n                if(distance(lightPos, position) < lightColorRadius.w){\r\n                    //float distoL = distance(lightPos, position);\r\n                    //distoL = max(lightColorRadius.w - distoL, 0.0);\r\n                    float diffuse = abs(dot(normal, normalize(lightPos - position)));\r\n                    //max(dot(normal, normalize(lightPos - position)),0.0);\r\n                    // if(diffuse == 0.0)\r\n                    //     diffuse = dot(-normal, normalize(lightPos - position));\r\n                    float dist = distance(lightPos, position);\r\n                    float lightR = lightColorRadius.w;\r\n                    float attenuation = dist/(1.0 - (dist/lightR) * (dist/lightR));\r\n                    attenuation = attenuation / lightR + 1.0;\r\n                    attenuation = 1.0 / (attenuation * attenuation);\r\n\r\n                    lightColor += diffuse * lightColorRadius.xyz * attenuation* color;// * ((lightColorRadius.w - distance(lightPos, position)) /     lightColorRadius.w);\r\n\r\n                    //lightColor += lightColorRadius.xyz;\r\n                    //if(distoL > 0.0)\r\n                    lightCount ++;\r\n                }\r\n            }\r\n            else\r\n                break;\r\n        }\r\n        lightColor = mix(vec3(0.0), vec3(1.0), lightColor);\r\n        lightColor = clamp(lightColor, vec3(0.0), vec3(1.0));\r\n    }\r\n    //gl_FragData[0] = vec4(vec3(float(count) / float(LIGHTNUM)),1.0);\r\n    gl_FragColor = vec4(lightColor * 0.7, 1.0) + vec4(color * 0.3,1.0);\r\n}\r\n#endif")}]),function(a,b,c){var d=angular.module("main.app",["main.services.config","main.services.dbc.map","main.services.map.adtLoader","main.services.map.wdtLoader","main.services.map.wmoLoader","main.services.map.blpLoader","main.services.map.mdxLoader","main.services.map.skinLoader","main.glsl.cache","main.directives.wowJsRender","main.directives.fileDownloader"]);d.controller("UrlChooserCtrl",["$scope","configService",function(a,b){a.isReadyForStart=!1,a.isReadyForDownload=!1,a.params={},a.params.urlForLoading=b.getUrlToLoadWoWFile(),a.params.zipFile=null,a.startApplication=function(){b.setUrlToLoadWoWFile(a.params.urlForLoading),a.params.zipUrl=b.getArchiveUrl(),a.params.downLoadProgress=0,a.isReadyForDownload="zip"==b.getFileReadMethod(),a.isReadyForStart="http"==b.getFileReadMethod()},a.$watch("params.zipFile",function(c){c&&(b.setArchiveFile(c),a.isReadyForDownload=!1,a.isReadyForStart=!0)})}]),d.config(["$provide","$httpProvider",function(a,b){a.factory("myHttpInterceptor",["$window","$q","$templateCache",function(a,b,c){return{request:function(a){if(a.url){var b=a.url.indexOf(".glsl"),d=b>-1;d?a.cache=c:a.params||(a.params={})}return a}}}]),b.interceptors.push("myHttpInterceptor")}]),d.run(["mapDBC","adtLoader","wdtLoader","wmoLoader","wmoGroupLoader","mdxLoader","skinLoader","blpLoader","$log",function(a,b,c,d,e,f,g,h,i){}])}(window,jQuery),function(a,b,c){var d=angular.module("main.directives.fileDownloader",["ui.bootstrap.progressbar","template/progressbar/progress.html","template/progressbar/progressbar.html"]);d.directive("fileDownloader",[function(){return{restrict:"E",scope:{url:"=",loadedFile:"=loadedFile",fileProgress:"="},link:function(a,b,c){function d(b){b.lengthComputable&&(a.fileProgress=b.loaded/b.total*100,a.$apply())}a.fileProgress=0;var e=new XMLHttpRequest;e.onprogress=d,e.responseType="arraybuffer",e.open("GET",a.url,!0),e.onreadystatechange=function(b){4==e.readyState&&(a.loadedFile=e.response,a.$apply())},e.send()}}}])}(window,jQuery),function(a,b,c){var d=angular.module("main.directives.wowJsRender",["js.wow.render.scene","main.services.config"]);d.directive("wowJsRender",["$log","$timeout","$interval","$window","scene","adtLoader","configService",function(a,b,d,e,f,g,h){return{restrict:"E",template:'<div class=""><canvas width = "1024" height = "768" ></canvas><div>camera = ( {{cameraVecs.cameraVec3[0]}}, {{cameraVecs.cameraVec3[1]}}, {{cameraVecs.cameraVec3[2]}} )</div><div>lookAt = ( {{cameraVecs.lookAtVec3[0]}}, {{cameraVecs.lookAtVec3[1]}}, {{cameraVecs.lookAtVec3[2]}} )</div><div>Group number = {{updateResult.interiorGroupNum}}</div><div>BSP Node Id = {{updateResult.nodeId}}</div><input type="checkbox" ng-model="drawM2" >Draw M2 objects</input></div>',link:function(a,b,d){var g=b.find("canvas")[0],i=new f(g),j=c;a.$watch("drawM2",function(a){h.setRenderM2(a)});var k=function(){var b=(new Date).getTime(),d=0;j!==c&&(d=b-j),j=b;var f=i.draw(d),g=f.cameraVecs,h=f.updateResult;a.cameraVecs=g,a.updateResult=h,e.requestAnimationFrame(k)};e.requestAnimationFrame(k),e.setInterval(function(){a.$digest()},200),i.loadWMOFile({fileName:"World/wmo/KhazModan/Cities/Ironforge/ironforge.wmo",uniqueId:0,pos:{x:17066.666666656,y:0,z:17066.666666656},rotation:{x:0,y:0,z:0},doodadSet:0})}}}])}(window,jQuery),function(a,b,c){var d=angular.module("main.services.chunkedLoader",["main.services.fileReadHelper","main.services.fileLoader"]);d.factory("chunkedLoader",["fileLoader","fileReadHelper","$q","$log",function(a,b,d,e){return function(d){return a(d).then(function(a){var d=b(a),e=null,f={getFileSize:function(){return d.getLength()},setSectionReaders:function(a){e=a},processChunkAtOffsWithSize:function(a,b,c){var d=this.loadChunkAtOffset(a,b);this.processChunk(d,c)},processChunkAtOffs:function(a,b){var c=this.loadChunkAtOffset(a);this.processChunk(c,b)},processChunk:function(a,b){var c=e.getHandler(a.chunkIdent);if(c&&0!==a.chunkLen)if("function"==typeof c)c(b,a,this);else for(var d=c[a.chunkIdent](b,a),f=this.loadChunkAtOffset(a.chunkOffset+d.offs);""!=f.chunkIdent;){var g=c.subChunks[f.chunkIdent];g&&g(b,f,this),f=this.loadChunkAtOffset(f.nextChunkOffset)}},processFile:function(a){for(var b=this.loadChunkAtOffset(0);""!=b.chunkIdent;)this.processChunk(b,a,e),b=this.loadChunkAtOffset(b.nextChunkOffset)},loadChunkAtOffset:function(e,f){var g={offs:e},h="",i=0,j=-1;g.offs+8<d.getLength()&&(h=d.reverseStr(d.readString(g,4)),i=d.readInt32(g),f!=c&&(i=f),j=g.offs);var k=null;i>0&&(k=b(a,g.offs,i));var l=Object.create(k,{chunkIdent:{value:h},chunkLen:{value:i},chunkOffset:{value:e},chunkDataOffset:{value:j},nextChunkOffset:{value:e+8+i,writable:!0}});return l}};return f},function(a){return a})}}])}(jQuery,window),function(a,b,c){var d=angular.module("main.services.config",[]);d.factory("configService",[function(){var a="/get/",b="zip",c="http://deamon87.github.io/WoWFiles/ironforge.zip",d=null,e=!0,f=localStorage.getItem("urlForLoading");return f&&(a=f),{getUrlToLoadWoWFile:function(){return a},setUrlToLoadWoWFile:function(b){a=b,localStorage.setItem("urlForLoading",b)},getFileReadMethod:function(){return b},getArchiveUrl:function(){return c},getArhiveFile:function(){return d},setArchiveFile:function(a){d=a},getRenderM2:function(){return e},setRenderM2:function(a){e=a}}}])}(jQuery,window),function(a,b,c){var d=angular.module("main.services.dbc.map",["main.services.dbcLoader"]);d.factory("mapDBC",["loadDBC","$q",function(a,b){var d;return function(){var e=b.defer();if(d===c){var f=a("DBFilesClient/Map.dbc");f.then(function(a){d={};for(var b=0;b<a.getRowCount();b++){var c={};c.id=a.readInt32(b,0),c.mapName=a.readText(b,1),c.wdtName=a.readText(b,5),d[c.id]=c}e.resolve(d)},function(a){e.reject()})}else e.resolve(d);return e.promise}}])}(window,jQuery),function(a,b,c){var d=angular.module("main.services.dbcLoader",["main.services.config"]);d.factory("loadDBC",["fileLoader","fileReadHelper","$q",function(a,b,c){return function(d){var e=c.defer(),f=20;return a(d).then(function(a){function c(a,b){var c=f+a*(4*j)+4*b;return{offs:c}}function d(a,b){var d=c(a,b),e=g.readUint32(d),f=m+e;return f}var g=b(a),h={offs:0},i=(g.readString(h,4),g.readInt32(h)),j=g.readInt32(h),k=g.readInt32(h),l=g.readInt32(h),m=f+i*(4*j),n={fileSize:a.byteLength,getRowCount:function(){return i},getColCount:function(){return j},getRowSize:function(){return k},readInt32:function(a,b){var d=c(a,b);return g.readInt32(d,!0)},readUInt32:function(a,b){var d=c(a,b);return g.readUint32(d,!0)},readText:function(a,b){var c=d(a,b);return g.readString(c,l)}};e.resolve(n)},function(){e.reject(null)}),e.promise}}])}(jQuery,window),function(a,b,c){var d=angular.module("main.services.fileLoader",["main.services.config"]);d.factory("fileLoader",["configService","fileReadHelper","$http","$q",function(a,b,c,d){function e(){var b=d.defer();i.push(b);var c=a.getArhiveFile();return zip.createReader(new zip.BlobReader(new Blob([c])),function(a){a.getEntries(function(a){for(var b=i.length,c=0;b>c;c++)i[c].resolve(a);i=[]})},function(a){for(var b=i.length,c=0;b>c;c++)i[c].reject(a);i=[]}),b.promise}function f(a){var b=d.defer();a=a.replace(/\u0000/g,"");var c=null;return h.every(function(b){return b.filename.trim().toLowerCase()==a.toLowerCase()?(c=b,!1):!0}),c?c.getData(new zip.BlobWriter,function(a){var c=new FileReader;c.onload=function(a){var c=a.target.result;b.resolve(c)},c.readAsArrayBuffer(a)}):b.reject(null),b.promise}function g(b){if(b[b.length-1]==String.fromCharCode(0)&&(b=b.substr(0,b.length-1)),b&&(b=b.toLowerCase()),"http"==a.getFileReadMethod()){var d=a.getUrlToLoadWoWFile()+b;return c.get(d,{responseType:"arraybuffer"}).then(function(a){return a.data},function(a){})}return"zip"==a.getFileReadMethod()?(b&&(b=b.replace(/\\/g,"/")),h?f(b).then(function(a){return a},function(a){return a}):e().then(function(a){return h=a,f(b)},function(a){}).then(function(a){return a},function(a){return a})):void 0}var h,i=[];return g}])}(window,jQuery),function(a,b,c){var d=angular.module("main.services.fileReadHelper",["main.services.config"]);d.factory("fileReadHelper",["$log",function(a){function b(a){var b,c="";for(b=a.length-1;b>=0;b--)c+=a.charAt(b);return c}var c=!0,d=new TextDecoder("utf-8");return function(a,e,f){var g;g=e&&f?new DataView(a,e,f):new DataView(a);var h;return h=e&&f?new Uint8Array(a,e,f):new Uint8Array(a),{getLength:function(){return h.length},readInt8:function(a){var b=g.getInt8(a.offs);return a.offs+=1,b},readInt16:function(a){var b=g.getInt16(a.offs,c);return a.offs+=2,b},readInt32:function(a){var b=g.getInt32(a.offs,c);return a.offs+=4,b},readUint8:function(a){var b=g.getUint8(a.offs);return a.offs+=1,b},readUint16:function(a){var b=g.getUint16(a.offs,c);return a.offs+=2,b},readUint32:function(a){var b=g.getUint32(a.offs,c);return a.offs+=4,b},readFloat32:function(a){var b=g.getFloat32(a.offs,c);return a.offs+=4,b},readFloat64:function(a){var b=g.getFloat64(a.offs,c);return a.offs+=8,b},readVector4f:function(a){var b={};return b.x=this.readFloat32(a),b.y=this.readFloat32(a),b.z=this.readFloat32(a),b.w=this.readFloat32(a),b},readVector3f:function(a){var b={};return b.x=this.readFloat32(a),b.y=this.readFloat32(a),b.z=this.readFloat32(a),b},readVector2f:function(a){var b={};return b.x=this.readFloat32(a),b.y=this.readFloat32(a),b},readQuaternion:function(a){var b={};return b.imag=this.readVector3f(a),b.real=this.readFloat32(a),b},readUint8Array:function(a,b){
for(var c=new Uint8Array(b),d=0;b>d;d++)c[d]=this.readUint8(a);return c},readInt8Array:function(a,b){for(var c=new Int8Array(b),d=0;b>d;d++)c[d]=this.readInt8(a);return c},readUint16Array:function(a,b){for(var c=[],d=0;b>d;d++)c[d]=this.readUint16(a);return c},readInt16Array:function(a,b){for(var c=[],d=0;b>d;d++)c[d]=this.readInt16(a);return c},readInt32Array:function(a,b){for(var c=[],d=0;b>d;d++)c[d]=this.readInt32(a);return c},readFloat32Array:function(a,b){for(var c=[],d=0;b>d;d++)c[d]=this.readFloat32(a);return c},readString:function(a,b){function c(a,b,c,d){for(var e=c;d>e;e++)if(a[e]==b)return e;return d}var e=a.offs,f=c(h,0,e,e+b),g=d.decode(h.subarray(e,f));return a.offs=f,g},readNZTString:function(a,b){var c=a.offs,e=c+b,f=d.decode(h.subarray(c,e));return a.offs=e,f},reverseStr:function(a){return b(a)}}}}])}(window,jQuery),function(a,b,c){var d=angular.module("main.services.linedFileLoader",["main.services.fileReadHelper"]);d.factory("linedFileLoader",["fileLoader","fileReadHelper","$q","$log",function(a,b,d,e){return function(d){return a(d).then(function(a){function f(){this.loadDataAtOffset=function(c,d){return b(a,c,d)},this.readType=function(a,b,d,f){var g,h=this,i=b.type;switch(i){case"int8":g=a.readInt8(d);break;case"int16":g=a.readInt16(d);break;case"int32":g=a.readInt32(d);break;case"uint8":g=a.readUint8(d);break;case"uint16":g=a.readUint16(d);break;case"uint32":g=a.readUint32(d);break;case"int32Array":g=a.readInt32Array(d,f);break;case"uint8Array":g=a.readUint8Array(d,f);break;case"uint16Array":g=a.readUint16Array(d,f);break;case"int16Array":g=a.readInt16Array(d,f);break;case"vector3f":g=a.readVector3f(d);break;case"float32":g=a.readFloat32(d);break;case"string":g=f!=c?a.readNZTString(d,f):a.readString(d,9999);break;case"ablock":g={},g.interpolation_type=a.readUint16(d),g.global_sequence=a.readUint16(d);var j=a.readInt32(d),k=a.readInt32(d);j=0>j?0:j,g.timestampsPerAnimation=[],g.timestampsPerAnimation.length=j;for(var l={offs:k},m=0;j>m;m++){g.timestampsPerAnimation[m]=[];var n=a.readUint32(l),o=a.readUint32(l),p={offs:o};g.timestampsPerAnimation[m].length=n;for(var q=0;n>q;q++)g.timestampsPerAnimation[m][q]=a.readUint32(p)}var r=a.readInt32(d),s=a.readInt32(d);r=0>=r?0:r,g.valuesPerAnimation=[],g.valuesPerAnimation.length=r;for(var t={offs:s},m=0;r>m;m++){g.valuesPerAnimation[m]=[];var u=a.readUint32(t),v=a.readUint32(t);g.valuesPerAnimation[m].length=u;for(var p={offs:v},q=0;u>q;q++)g.valuesPerAnimation[m][q]=h.readType(a,{type:b.valType,len:b.len},p,b.len)}break;case"layout":var w=b.layout,x={};if(!w instanceof Array)throw"layout is not array";for(var m=0;m<w.length;m++){var y=w[m].name;x[y]=this.parseSectionDefinition(x,w[m],a,d)}return x;default:e.info("Unknown type in layout. type = ",i)}return g},this.parseSectionDefinition=function(a,b,d,e){var f;f="string"==typeof b.offset?a[b.offset]:b.offset;var g=b.len;"string"==typeof b.len?g=a[g]:"function"==typeof b.len&&(g=b.len(a)),e&&f?e={offs:f}:f?e={offs:f}:e||(e={offs:0});var h,i=[],j=1,k=b.count!==c;k&&(j=a[b.count]);for(var l=0;j>l;l++)h=this.readType(d,b,e,g),i.push(h);var m;return m=k?i:i[0]}}if("object"!=typeof a||!(a instanceof ArrayBuffer))return void e.log("Failed to load file = "+d);var g=b(a);f.prototype=g;var h=new f;return h},function(a){return a})}}])}(window,jQuery),function(a,b,c){var d=angular.module("main.services.map.adtLoader",["main.services.linedFileLoader"]);d.factory("adtLoader",["chunkedLoader","fileReadHelper","$log","$q",function(a,b,c,d){return function(c){function e(){var a={MVER:function(a,b){if("MVER"!==b.chunkIdent)throw"Got bad group ADT file "+c;b.readInt32({offs:0})},MHDR:function(a,b,c){var d={offs:0},e=(b.readUint32(d),b.readUint32(d)),f=b.readUint32(d),g=b.readUint32(d),h=b.readUint32(d),i=b.readUint32(d),j=b.readUint32(d),k=b.readUint32(d),l=b.readUint32(d);b.readUint32(d),b.readUint32(d),b.readUint32(d),b.readUint32(d),b.readUint32(d),b.readUint32(d),b.readUint32(d);c.processChunkAtOffs(b.chunkDataOffset+e,a),c.processChunkAtOffs(b.chunkDataOffset+f,a),c.processChunkAtOffs(b.chunkDataOffset+g,a),c.processChunkAtOffs(b.chunkDataOffset+h,a),c.processChunkAtOffs(b.chunkDataOffset+i,a),c.processChunkAtOffs(b.chunkDataOffset+j,a),c.processChunkAtOffs(b.chunkDataOffset+k,a),c.processChunkAtOffs(b.chunkDataOffset+l,a),b.nextChunkOffset=c.getFileSize()},MCIN:function(a,b,c){for(var d={offs:0},e=[],f=0;256>f;f++){var g={};g.offsetMCNK=b.readUint32(d),g.size=b.readUint32(d),g.flags=b.readUint32(d),g.asyncId=b.readUint32(d);var h={};c.processChunkAtOffs(g.offsetMCNK,h),e.push(h)}a.mcnkObjs=e},MCNK:function(a,b,c){var d={offs:0};a.flags=b.readUint32(d),a.ix=b.readUint32(d),a.iy=b.readUint32(d),a.nLayers=b.readUint32(d),a.nDoodadRefs=b.readUint32(d);var e=b.readUint32(d),f=b.readUint32(d),g=b.readUint32(d),h=(b.readUint32(d),b.readUint32(d));a.sizeAlpha=b.readUint32(d);b.readUint32(d);a.sizeShadow=b.readUint32(d),a.areaid=b.readUint32(d),a.nMapObjRefs=b.readUint32(d),a.holes=b.readUint32(d),a.s1=b.readUint16(d),a.s2=b.readUint16(d),a.d1=b.readUint32(d),a.d2=b.readUint32(d),a.d3=b.readUint32(d),a.predTex=b.readUint32(d);b.readUint32(d),b.readUint32(d),b.readUint32(d),b.readUint32(d),b.readUint32(d);a.pos=b.readVector3f(d),a.textureId=b.readUint32(d),a.props=b.readUint32(d),a.effectId=b.readUint32(d),c.processChunkAtOffs(b.chunkOffset+e,a),c.processChunkAtOffs(b.chunkOffset+f,a),c.processChunkAtOffs(b.chunkOffset+g,a),c.processChunkAtOffsWithSize(b.chunkOffset+h,a.sizeAlpha,a)},MCVT:function(a,b,c){var d={offs:0},e=b.readFloat32Array(d,145);a.heights=e},MCNR:function(a,b,c){for(var d={offs:0},e=[],f=0;145>f;f++){var g=b.readInt8(d)/127,h=b.readInt8(d)/127,i=b.readInt8(d)/127;e.push(g),e.push(h),e.push(i)}a.normales=e},MCLY:function(a,b,c){for(var d={offs:0},e=b.chunkLen>>4,f=[],g=0;e>g;g++){var h={};h.textureID=b.readInt32(d),h.flags=b.readInt32(d),h.alphaMap=b.readInt32(d),h.detailTex=b.readInt32(d),f.push(h)}a.textureLayers=f},MCAL:function(a,b,c){var d={offs:0},e=b.readUint8Array(d,b.chunkLen);a.alphaArray=e},MTEX:function(a,b){for(var c={offs:0},d=[];c.offs<b.chunkLen;){var e=b.readString(c,b.chunkLen-c.offs);c.offs+=1,d.push(e)}a.mtex=d},MMDX:function(a,b){var c={offs:0},d=null;b.chunkLen>0&&(d=b.readUint8Array(c,b.chunkLen)),a.mmdx=d},MMID:function(a,b){var c={offs:0},d=null;b.chunkLen>0&&(d=b.readInt32Array(c,b.chunkLen>>2)),a.mmid=d},MWMO:function(a,b){var c={offs:0},d=null;b.chunkLen>0&&(d=b.readUint8Array(c,b.chunkLen)),a.mwmo=d},MWID:function(a,b){var c={offs:0},d=null;b.chunkLen>0&&(d=b.readInt32Array(c,b.chunkLen>>2)),a.mwid=d},MDDF:function(a,c){var d=[],e={offs:0},f=c.chunkLen/36;if(f>0)var g=b(a.mmdx.buffer);for(var h=0;f>h;h++){var i={};i.nameID=c.readInt32(e),i.uniqueId=c.readInt32(e),i.pos=c.readVector3f(e),i.rotation=c.readVector3f(e),i.scale=c.readInt32(e);var j=a.mmid[i.nameID];i.fileName=g.readString({offs:j},g.getLength()-j),d.push(i)}a.mddf=d},MODF:function(a,c){var d={offs:0},e=[],f=c.chunkLen/64;if(f>0)var g=b(a.mwmo.buffer);for(var h=0;f>h;h++){var i={};i.nameId=c.readInt32(d),i.uniqueId=c.readInt32(d),i.pos=c.readVector3f(d),i.rotation=c.readVector3f(d),i.bb1=c.readVector3f(d),i.bb2=c.readVector3f(d),i.doodadSet=c.readUint16(d),i.nameSet=c.readUint16(d),i.flags=c.readInt32(d);var j=a.mwid[i.nameId];i.fileName=g.readString({offs:j},g.getLength()-j),e.push(i)}a.wmoObjs=e}};this.getHandler=function(b){return a[b]}}function f(a){for(var b=0;b<a.mcnkObjs.length;b++){var c=a.mcnkObjs[b],d=a.mtex;if(c.textureLayers)for(var e=0;e<c.textureLayers.length;e++){var f=c.textureLayers[e].textureID,g=d[f];c.textureLayers[e].textureName=g}}}var g=d.defer(),h=a(c);return h.then(function(a){var b={};a.setSectionReaders(new e),a.processFile(b),f(b),console.log(b),g.resolve(b)},function(){g.reject()}),g.promise}}])}(window,jQuery),function(a,b,c){var d=angular.module("main.services.map.blpLoader",["main.services.linedFileLoader"]);d.factory("blpLoader",["linedFileLoader","$log","$q",function(a,b,c){var d={name:"header",type:"layout",layout:[{name:"type",type:"int32"},{name:"encoding",type:"uint8"},{name:"alphaDepth",type:"uint8"},{name:"alphaEncoding",type:"uint8"},{name:"hasMips",type:"uint8"},{name:"width",type:"int32"},{name:"height",type:"int32"},{name:"offsets",type:"int32Array",len:16},{name:"lengths",type:"int32Array",len:16},{name:"palette",type:"uint8Array",len:256}]};return function(c){var e=a(c),f=e.then(function(a){var c={offs:0},e=a.readNZTString(c,4);if("BLP2"!=e){var f,g="Unknown BLP file ident = "+e+", filepath = ";throw b.error(g),g}var h={header:{}},h=a.parseSectionDefinition(h,d,a,c);h.fileName=f;var i=h.width,j=h.height;if(1==h.type){if(2==h.encoding)switch(h.alphaDepth){case 0:h.textureFormat="S3TC_RGB_DXT1";break;case 1:h.textureFormat="S3TC_RGB_DXT1";break;case 4:h.textureFormat="S3TC_RGBA_DXT3";break;case 8:1==h.alphaEncoding?h.textureFormat="S3TC_RGBA_DXT3":h.textureFormat="S3TC_RGBA_DXT5";break;default:h.textureFormat="S3TC_RGBA_DXT3"}else 1==h.encoding&&(h.textureFormat="BGRA");for(var k=[],l=0;15>l&&(0!=h.lengths[l]&&0!=h.offsets[l]);l++){var m=a.readUint8Array({offs:h.offsets[l]},h.lengths[l]);k.push({texture:m,width:i,height:j}),j=Math.floor(j/2),i=Math.floor(i/2),j=0==j?1:j,i=0==i?1:i}}return h.mipmaps=k,h},function(a){return a});return f}}])}(window,jQuery),function(a,b,c){var d=angular.module("main.services.map.mdxLoader",["main.services.linedFileLoader"]);d.factory("mdxLoader",["linedFileLoader","$log","$q",function(a,b,d){var e={name:"header",type:"layout",layout:[{name:"MNameLen",type:"int32"},{name:"MNameOffs",type:"int32"},{name:"ModelType",type:"int32"},{name:"nGlobalSequences",type:"int32"},{name:"ofsGlobalSequences",type:"int32"},{name:"nAnimations",type:"int32"},{name:"ofsAnimations",type:"int32"},{name:"nC",type:"int32"},{name:"ofsC",type:"int32"},{name:"nBones",type:"int32"},{name:"ofsBones",type:"int32"},{name:"nF",type:"int32"},{name:"ofsF",type:"int32"},{name:"nVertexes",type:"int32"},{name:"ofsVertexes",type:"int32"},{name:"nViews",type:"int32"},{name:"nColors",type:"int32"},{name:"ofsColors",type:"int32"},{name:"nTextures",type:"int32"},{name:"ofsTextures",type:"int32"},{name:"nTransparency",type:"int32"},{name:"ofsTransparency",type:"int32"},{name:"nTexAnims",type:"int32"},{name:"ofsTexAnims",type:"int32"},{name:"nTexReplace",type:"int32"},{name:"ofsTexReplace",type:"int32"},{name:"nRenderFlags",type:"int32"},{name:"ofsRenderFlags",type:"int32"},{name:"nGroupBoneIDs",type:"int32"},{name:"ofsGroupBoneIDs",type:"int32"},{name:"nTexLookup",type:"int32"},{name:"ofsTexLookup",type:"int32"},{name:"nTexUnits",type:"int32"},{name:"ofsTexUnits",type:"int32"},{name:"nTransLookup",type:"int32"},{name:"ofsTransLookup",type:"int32"},{name:"nTexAnimLookup",type:"int32"},{name:"ofsTexAnimLookup",type:"int32"},{name:"BoundingCorner1",type:"vector3f"},{name:"BoundingCorner2",type:"vector3f"},{name:"BoundingRadius",type:"float32"},{name:"Corner1",type:"vector3f"},{name:"Corner2",type:"vector3f"},{name:"Radius",type:"float32"},{name:"nBoundingTriangles",type:"int32"},{name:"ofsBoundingTriangles",type:"int32"},{name:"nBoundingVertices",type:"int32"},{name:"ofsBoundingVertices",type:"int32"},{name:"nBoundingNormals",type:"int32"},{name:"ofsBoundingNormals",type:"int32"},{name:"nAttachments",type:"int32"},{name:"ofsAttachments",type:"int32"},{name:"nP",type:"int32"},{name:"ofsP",type:"int32"},{name:"nNumEvents",type:"int32"},{name:"ofsNumEvents",type:"int32"},{name:"nLights",type:"int32"},{name:"ofsLights",type:"int32"},{name:"nCameras",type:"int32"},{name:"ofsCameras",type:"int32"},{name:"nCameraLookup",type:"int32"},{name:"ofsCameraLookup",type:"int32"},{name:"nRibbonEmitters",type:"int32"},{name:"ofsRibbonEmitters",type:"int32"},{name:"nParticleEmitters",type:"int32"},{name:"ofsParticleEmitters",type:"int32"},{name:"vertexes",offset:"ofsVertexes",type:"uint8Array",len:function(a){return 48*a.nVertexes}},{name:"vertexesDebug",offset:"ofsVertexes",count:"nVertexes",type:"layout",layout:[{name:"pos",type:"vector3f"},{name:"bonesWeight",type:"uint8Array",len:4},{name:"bones",type:"uint8Array",len:4},{name:"normal",type:"vector3f"},{name:"textureX",type:"float32"},{name:"textureY",type:"float32"},{name:"unk1",type:"int32"},{name:"unk2",type:"int32"}]},{name:"textureDefinition",offset:"ofsTextures",count:"nTextures",type:"layout",layout:[{name:"texType",type:"uint32"},{name:"flags",type:"uint32"},{name:"filenameLen",type:"uint32"},{name:"ofsFilename",type:"uint32"},{name:"textureName",offset:"ofsFilename",len:"filenameLen",type:"string"}]},{name:"texLookup",offset:"ofsTexLookup",count:"nTexLookup",type:"uint16"},{name:"colors",offset:"ofsColors",count:"nColors",type:"layout",layout:[{name:"color",type:"ablock",valType:"vector3f"},{name:"alpha",type:"ablock",valType:"int16"}]},{name:"transparencies",offset:"ofsTransparency",count:"nTransparency",type:"layout",layout:[{name:"values",type:"ablock",valType:"int16"}]},{name:"bones",offset:"ofsBones",count:"nBones",type:"layout",layout:[{name:"key_bone_id",type:"int32"},{name:"flags",type:"uint32"},{name:"parent_bone",type:"int16"},{name:"submesh_id",type:"uint16"},{name:"unk1",type:"uint16"},{name:"unk2",type:"uint16"},{name:"translation",type:"ablock",valType:"vector3f"},{name:"rotation",type:"ablock",valType:"int16Array",len:4},{name:"scale",type:"ablock",valType:"vector3f"},{name:"pivot",type:"vector3f"}]},{name:"texAnimLookup",offset:"ofsTexAnimLookup",count:"nTexAnimLookup",type:"int16"},{name:"texAnims",offset:"ofsTexAnims",count:"nTexAnims",type:"layout",layout:[{name:"translation",type:"ablock",valType:"vector3f"},{name:"rotation",type:"ablock",valType:"int16Array",len:4},{name:"scale",type:"ablock",valType:"vector3f"}]},{name:"transLookup",offset:"ofsTransLookup",count:"nTransLookup",type:"int16"},{name:"texReplace",offset:"ofsTexReplace",count:"nTexReplace",type:"uint16"},{name:"textUnitLookup",offset:"ofsTexUnits",count:"nTexUnits",type:"uint16"},{name:"renderFlags",offset:"ofsRenderFlags",count:"nRenderFlags",type:"layout",layout:[{name:"flags",type:"uint16"},{name:"blend",type:"uint16"}]}]},f={264:e};return function(d){var e=a(d),g=e.then(function(a){var e={offs:0},g=a.readNZTString(e,4),h=a.readInt32(e);if("MD20"!=g){var i="Unknown MDX file ident = "+g+", filepath = "+d;throw b.error(i),i}var j=f[h];if(j==c){var i="Unknown MDX file version = "+h+", filepath = "+d;throw b.error(i),i}var k={};try{k=a.parseSectionDefinition(k,j,a,e)}catch(l){throw l}return k.fileName=d,k},function(a){return a});return g}}])}(window,jQuery),function(a,b,c){var d=angular.module("main.services.map.skinLoader",["main.services.linedFileLoader"]);d.factory("skinLoader",["linedFileLoader","$log","$q",function(a,b,c){var d={name:"header",type:"layout",layout:[{name:"nIndex",type:"int32"},{name:"ofsIndex",type:"int32"},{name:"nTris",type:"int32"},{name:"ofsTris",type:"int32"},{name:"nProps",type:"int32"},{name:"ofsProps",type:"int32"},{name:"nSub",type:"int32"},{name:"ofsSub",type:"int32"},{name:"nTex",type:"int32"},{name:"ofsTex",type:"int32"},{name:"LOD",type:"int32"},{name:"indexes",offset:"ofsIndex",len:"nIndex",type:"uint16Array"},{name:"triangles",offset:"ofsTris",len:"nTris",type:"uint16Array"},{name:"subMeshes",offset:"ofsSub",count:"nSub",type:"layout",layout:[{name:"meshID",type:"int32"},{name:"vStart",type:"uint16"},{name:"vCount",type:"uint16"},{name:"idxStart",type:"uint16"},{name:"idxCount",type:"uint16"},{name:"idxBone",type:"uint16"},{name:"OfsBoneList",type:"uint16"},{name:"unk1",type:"uint16"},{name:"rootBone",type:"uint16"},{name:"pos",type:"vector3f"},{name:"unkPos",type:"vector3f"},{name:"unkFloat",type:"float32"}]},{name:"texs",offset:"ofsTex",count:"nTex",type:"layout",layout:[{name:"flags",type:"uint16"},{name:"renderOrder",type:"int16"},{name:"submeshIndex",type:"uint16"},{name:"unk1",type:"uint16"},{name:"colorIndex",type:"int16"},{name:"renderFlagIndex",type:"uint16"},{name:"textureUnitNum",type:"uint16"},{name:"op_count",type:"uint16"},{name:"textureIndex",type:"uint16"},{name:"unk3",type:"uint16"},{name:"transpIndex",type:"uint16"},{name:"textureAnim",type:"uint16"}]}]};return function(e){var f=(c.defer(),a(e)),g=f.then(function(a){var c={offs:0},f=a.readNZTString(c,4);if("SKIN"!=f){var g="Unknown SKIN file ident = "+f+", filepath = "+e;throw b.error(g),g}var h={header:{}};return h.header=a.parseSectionDefinition(h,d,a,c),h.fileName=e,h},function(a){return a});return g}}])}(window,jQuery),function(a,b,c){var d=angular.module("main.services.map.wdtLoader",["main.services.chunkedLoader"]);d.factory("wdtLoader",["chunkedLoader","fileReadHelper","$q","$log",function(a,b,c,d){return function(e){var f=c.defer(),g=a(e);return g.then(function(a){var c=a.loadChunkAtOffset(0);if("MVER"!==c.chunkIdent)throw"Got bad WDT file "+e;c=a.loadChunkAtOffset(c.nextChunkOffset);for(var g={};""!=c.chunkIdent;){switch(c.chunkIdent){case"MAIN":for(var h={offs:0},i={},j=0;64>j;j++){for(var k={},l=0;64>l;l++)k[l]=c.readInt32(h),h.offs+=4;i[j]=k}g.tileTable=k;break;case"MPHD":var m={offs:0};g.flags=c.readUint8(m),g.isWMOMap=g.flags&!0;break;case"MWMO":var m={offs:0},n=null;c.chunkLen>0&&(n=c.readUint8Array(m,c.chunkLen)),g.mwmo=n;break;case"MODF":var m={offs:0},o={},p=b(g.mwmo.buffer);o.nameId=c.readInt32(m),o.uniqueId=c.readInt32(m),o.pos=c.readVector3f(m),o.rotation=c.readVector3f(m),o.unkVector1=c.readVector3f(m),o.unkVector2=c.readVector3f(m),o.doodadSet=c.readUint16(m),o.nameSet=c.readUint16(m),o.flags=c.readInt32(m);var q=o.nameId;o.fileName=p.readString({offs:q},p.getLength()-q),g.modfChunk=o;break;default:d.info("Unknown Chunk. Ident = "+c.chunkIdent+", file = "+e)}c=a.loadChunkAtOffset(c.nextChunkOffset)}f.resolve(g)},function(){f.reject()}),f.promise}}])}(jQuery,window),function(a,b,c){var d=angular.module("main.services.map.wmoLoader",["main.services.chunkedLoader","main.services.fileReadHelper"]);d.factory("wmoGroupLoader",["chunkedLoader","fileReadHelper","$q","$log",function(a,b,d,e){return function(b,e){function f(){var a={MVER:function(c,d){if("MVER"!==d.chunkIdent)throw"Got bad group WMO file "+b;var e=d.readInt32({offs:0});17==e&&(a=g)}};this.getHandler=function(b){return a[b]}}var g=(d.defer(),{MOGP:{MOGP:function(a,b){var c={offs:0},d={};return d.GroupName=b.readInt32(c),d.dGroupName=b.readInt32(c),d.Flags=b.readUint32(c),d.BoundBoxCorner1=b.readVector3f(c),d.BoundBoxCorner2=b.readVector3f(c),d.moprIndex=b.readInt16(c),d.numItems=b.readInt16(c),d.numBatchesA=b.readInt16(c),d.numBatchesB=b.readInt16(c),d.numBatchesC=b.readInt16(c),d.Indeces=b.readUint8Array(c,4),d.Unk1=b.readInt32(c),d.groupID=b.readInt32(c),d.Unk2=b.readInt32(c),d.Unk3=b.readInt32(c),c.offs+=10,a.mogp=d,c},subChunks:{MOPY:function(a,b){b.length/2},MOVI:function(a,b){var c=b.chunkLen/2;a.indicies=b.readUint16Array({offs:0},c)},MOVT:function(a,b){if(e)a.verticles=b.readFloat32Array({offs:0},b.chunkLen/4);else{var c=b.chunkLen/12;a.verticles=b.readVector3f({offs:0},c)}},MONR:function(a,b){var c=b.chunkLen/12;e?a.normals=b.readFloat32Array({offs:0},b.chunkLen/4):a.normals=b.readVector3f({offs:0},c)},MOTV:function(a,b){var d,f=b.chunkLen/8;d=e?b.readFloat32Array({offs:0},b.chunkLen/4):b.readVector2f({offs:0},f),a.textCoords==c?a.textCoords=d:a.textCoords2=d},MOCV:function(a,b){var d=(b.chunkLen/4,b.readUint8Array({offs:0},b.chunkLen));a.colorVerticles==c?a.colorVerticles=d:a.colorVerticles2=d},MODR:function(a,b){var c={offs:0},d=b.chunkLen/2,e=b.readUint16Array(c,d);a.doodadRefs=e},MOBA:function(a,b){for(var c={offs:0},d=b.chunkLen/24,e=[],f=0;f<Math.floor(d);f++){var g={};g.unk=b.readUint8Array(c,12),g.startIndex=b.readUint32(c),g.count=b.readUint16(c),g.minIndex=b.readInt16(c),g.maxIndex=b.readInt16(c),g.flags=b.readInt8(c),g.tex=b.readUint8(c),e.push(g)}a.renderBatches=e},MOBN:function(a,b){for(var c={offs:0},d=b.chunkLen/16,e=new Array(d),f=0;d>f;f++){var g={};g.planeType=b.readUint16(c),g.children1=b.readInt16(c),g.children2=b.readInt16(c),g.numFaces=b.readUint16(c),g.firstFace=b.readUint32(c),g.fDist=b.readFloat32(c),e[f]=g}a.nodes=e},MOBR:function(a,b){var c={offs:0},d=b.chunkLen/2;a.mobr=b.readUint16Array(c,d)}}}}),h=a(b),i=h.then(function(a){var b={colorVerticles2:[],textCoords2:[]};return a.setSectionReaders(new f),a.processFile(b),b},function(a){return a});return i}}]),d.factory("wmoLoader",["chunkedLoader","fileReadHelper","$q","$log",function(a,b,c,d){return function(c){function d(){var a={MVER:function(b,d){if("MVER"!==d.chunkIdent)throw"Got bad WMO file "+c;var f=d.readInt32({offs:0});17==f&&(a=e)}};this.getHandler=function(b){return a[b]}}var e={MOHD:function(a,b){var c={offs:0};a.nTextures=b.readInt32(c),a.nGroups=b.readInt32(c),a.nPortals=b.readInt32(c),a.nLights=b.readInt32(c),a.nModels=b.readInt32(c),a.nDoodads=b.readInt32(c),a.nDoodadSets=b.readInt32(c),a.ambColor=b.readInt32(c),a.unk1=b.readInt32(c),a.BoundBoxCorner1=b.readVector3f(c),a.BoundBoxCorner2=b.readVector3f(c),a.WMOId=b.readInt32(c)},MOGI:function(a,b){for(var c={offs:0},d=[],e=0;e<a.nGroups;e++){var f={};f.flags=b.readUint32(c),f.bb1=b.readVector3f(c),f.bb2=b.readVector3f(c),f.nameoffset=b.readInt32(c),d.push(f)}a.groupInfos=d},MOPV:function(a,b){var c=b.chunkLen/4;a.portalVerticles=b.readFloat32Array({offs:0},c)},MOPT:function(a,b){for(var c={offs:0},d=b.chunkLen/20,e=new Array(d),f=0;d>f;f++){var g={};g.base_index=b.readUint16(c),g.index_count=b.readUint16(c),g.plane=b.readVector4f(c),e[f]=g}a.portalInfos=e},MOPR:function(a,b){for(var c={offs:0},d=b.chunkLen/8,e=new Array(d),f=0;d>f;f++){var g={};g.portal_index=b.readUint16(c),g.group_index=b.readUint16(c),g.side=b.readInt16(c),g.unk=b.readInt16(c),e[f]=g}a.portalRelations=e},MOLT:function(a,b){for(var c={offs:0},d=(b.chunkLen/a.nLights,[]),e=0;e<a.nLights;e++){var f={};f.lightType=b.readUint8(c),f.type=b.readUint8(c),f.useAtten=b.readUint8(c),f.pad=b.readUint8(c),f.color=b.readUint32(c),f.position=b.readVector3f(c),f.intensity=b.readFloat32(c),f.attenStart=b.readFloat32(c),f.attenEnd=b.readFloat32(c),f.unk1=b.readFloat32(c),f.unk2=b.readFloat32(c),f.unk3=b.readFloat32(c),f.unk4=b.readFloat32(c),d.push(f)}a.lights=d},MOMT:function(a,c){for(var d={offs:0},e=[],f=a.motx,g=0;g<a.nTextures;g++){var h={};h.flags1=c.readUint32(d),h.shader=c.readUint32(d),h.blendMode=c.readUint32(d),h.namestart1=c.readInt32(d),h.color1=c.readUint32(d),h.flags_1=c.readInt32(d),h.namestart2=c.readInt32(d),h.color2=c.readUint32(d),h.flags_2=c.readInt32(d),h.color_3=c.readUint32(d),h.unk=c.readInt32(d),h.dx=c.readInt32Array(d,5),h.textureName1=b(f.buffer).readString({offs:h.namestart1},f.length),h.textureName2=b(f.buffer).readString({offs:h.namestart2},f.length),e.push(h)}a.momt=e},MOTX:function(a,b){var c={offs:0},d=b.readUint8Array(c,b.chunkLen);a.motx=d},MODN:function(a,b){var c={offs:0},d=b.readUint8Array(c,b.chunkLen);a.modn=d},MODS:function(a,b){for(var c={offs:0},d=[],e=0;e<a.nDoodadSets;e++){var f={};f.name=b.readNZTString(c,20),f.index=b.readInt32(c),f.number=b.readInt32(c),f.unused=b.readInt32(c),d.push(f)}a.mods=d},MODD:function(a,c){for(var d={offs:0},e=a.modn,f=c.chunkLen/40,g=new Array(f),h=0;f>h;h++){var i={};i.nameIndex=c.readInt32(d),i.modelName=b(e.buffer).readString({offs:i.nameIndex},e.length-i.nameIndex),i.pos=c.readVector3f(d),i.rotation=c.readQuaternion(d),i.scale=c.readFloat32(d),i.color=c.readUint32(d),g[h]=i}a.modd=g}},f=a(c),g=f.then(function(a){var b={};return a.setSectionReaders(new d),a.processFile(b),b},function(){});return g}}])}(window,jQuery),function(a,b,c){var d=angular.module("main.world.worldMap",[]);d.factory("worldMap",[function(){return{setMap:function(a){}}}])}(jQuery,window),function(a,b,c){var d=angular.module("js.wow.render.cacheTemplate",[]);d.factory("cacheTemplate",["$q","$timeout",function(a,b){function d(d,e){function f(a){for(var b=l[a],d=0;d<b.length;d++){var e=j(a);b[d].resolve(e)}l[a]=c}function g(a,b){for(var d=l[a],e=0;e<d.length;e++)d[e].reject(b);l[a]=c}function h(a){b(function(){d(a).then(function(b){var c=e(b);i(a,c),f(a)},function(b){g(a)})},1)}function i(a,b){var c={obj:b,counter:1};k[a]=c}function j(a){var b=k[a];return b===c?c:(b.counter+=1,b.obj)}var k={},l={};this.get=function(b){var d=a.defer(),e=j(b);if(e)return d.resolve(e),d.promise;var f=l[b];return f===c&&(f=[],h(b)),f.push(d),l[b]=f,d.promise},this.remove=function(a){var b=k[a];b&&(b.counter-=1,b.counter<=0&&(k[a]=null,b.obj.destroy()))}}return function(a,b){return new d(a,b)}}])}(window,jQuery);var firstPersonCamera=angular.module("js.wow.render.camera.firstPersonCamera",[]);firstPersonCamera.factory("firstPersonCamera",["$log",function(a){return function(a,b){function c(a){var b=String.fromCharCode(a.keyCode||a.charCode);switch(b){case"W":m=1;break;case"S":m=-1;break;case"A":n=-1;break;case"D":n=1;break;case"Q":o=1;break;case"K":p=!p;break;case"E":o=-1}}function d(a){var b=String.fromCharCode(a.keyCode||a.charCode);switch(b){case"W":m=0;break;case"S":m=0;break;case"A":n=0;break;case"D":n=0;break;case"Q":o=0;break;case"E":o=0}}function e(a){0===a.button&&(q=1,r=a.pageX,s=a.pageY)}function f(a){q=1,r=a.pageX,s=a.pageY}function g(a){var b=a.touches[0].pageX,c=a.touches[0].pageY;1===q&&(t+=(b-r)/4,u+=(c-s)/4,-89>u?u=-89:u>89&&(u=89),r=b,s=c)}function h(a){0===a.button&&(q=0)}function i(a){1===q&&(t+=(a.pageX-r)/4,u+=(a.pageY-s)/4,-89>u?u=-89:u>89&&(u=89),r=a.pageX,s=a.pageY)}function j(a){q=0}function k(a){return a*(Math.PI/180)}var l=[0,0,0],m=0,n=0,o=0,p=!1,q=0,r=0,s=0,t=0,u=0;a.addEventListener("mousemove",i,!1),a.addEventListener("touchmove",g,!1),a.addEventListener("mousedown",e,!1),a.addEventListener("touchstart",f,!1),a.addEventListener("mouseup",h,!1),a.addEventListener("touchend",h,!1),a.addEventListener("mouseout",j,!1);var v;return b.addEventListener("mousedown",function(a){v=a.target},!1),b.addEventListener("keydown",function(b){v==a&&c(b)},!1),b.addEventListener("keyup",function(b){v==a&&d(b)},!1),{tick:function(a){var b=[1,0,0],c=.02,d=a;b=vec3.rotateY(b,b,[0,0,0],k(u)),b=vec3.rotateZ(b,b,[0,0,0],k(-t));var e=[];if(0!==n){var f=[];vec3.rotateZ(f,b,[0,0,0],k(-90)),f[2]=0,vec3.normalize(f,f),vec3.scale(f,f,d*c*n),vec3.add(l,l,f)}if(0!==m){var g=[];vec3.copy(g,b),vec3.scale(g,g,d*c*m),vec3.add(l,l,g)}return 0!==o&&(l[2]=l[2]+d*c*o),vec3.add(e,l,b),{lookAtVec3:e,cameraVec3:l,staticCamera:p}},setCameraPos:function(a,b,c){l=[a,b,c]}}}}]);var adtGeomCache=angular.module("js.wow.render.geometry.adtGeomCache",["main.services.map.adtLoader","js.wow.render.cacheTemplate"]);adtGeomCache.factory("adtGeomCache",["adtLoader","cacheTemplate","$q",function(a,b,c){function d(a,b){for(var c=[],d=256,e=0;e<a.mcnkObjs.length;e++){var f=a.mcnkObjs[e],g=f.alphaArray,h=f.textureLayers,i=new Array(16384);if(c.push(i),h)for(var j=0;j<h.length;j++){var k=h[j].alphaMap,l=64*j,m=0,n=0;if((512&h[j].flags)>0)for(;4096>n;){var o=128&g[k],p=127&g[k];k++;for(var q=0;p>q&&4096!=n;q++)i[l++]=g[k],m++,n++,m>=64&&(l=l+d-64,m=0,n++),o||k++;o&&k++}else if((4&b.flags)>0||(128&b.flags)>0)for(var r=0;64>r;r++)for(var s=0;64>s;s++)i[l]=g[k],l+=1,m+=1,n+=1,k++,m>=64&&(l=l+d-64,m=0);else for(var r=0;64>r;r++)for(var s=0;32>s;s++)i[l]=17*((240&g[k])>>4),i[l+1]=17*(15&g[k]),l+=2,m+=2,n+=2,k++,m>=64&&(l=l+d-64,m=0)}}return c}function e(a,b){this.sceneApi=a,this.gl=a.getGlContext(),this.wdtFile=b,this.combinedVBO=null,this.textureArray=new Array(255);for(var c=0;256>c;c++)this.textureArray[c]=[]}function f(c){var d=this,f=b(function(b){return a(b)},function(a){var b=new e(c,c.getCurrentWdt());return b.assign(a),b.createTriangleStrip(),b.createVBO(),b.loadTextures(),b});d.loadAdt=function(a){return f.get(a)},d.unLoadAdt=function(a){f.remove(a)}}return e.prototype={assign:function(a){this.adtFile=a},loadTextures:function(){for(var a=this.gl,b=this.adtFile.mcnkObjs,c=0;c<b.length;c++){var e=b[c];if(e.textureLayers&&e.textureLayers.length>0)for(var f=0;f<e.textureLayers.length;f++)this.loadTexture(c,f,e.textureLayers[f].textureName)}for(var g=(b.length,4),h=64,i=g*h,j=h,k=d(this.adtFile,this.wdtFile),l=[],c=0;c<b.length;c++){var m=a.createTexture();a.bindTexture(a.TEXTURE_2D,m),a.texImage2D(a.TEXTURE_2D,0,a.ALPHA,i,j,0,a.ALPHA,a.UNSIGNED_BYTE,new Uint8Array(k[c])),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),a.generateMipmap(a.TEXTURE_2D),a.bindTexture(a.TEXTURE_2D,null),l.push(m)}this.alphaTextures=l},loadTexture:function(a,b,c){var d=this;this.sceneApi.resources.loadTexture(c).then(function(c){d.textureArray[a][b]=c},function(){})},createTriangleStrip:function(){function a(a,b,c){var d=[4369,8738,17476,34952],e=[15,240,3840,61440];return 0!=(a&d[b]&e[c])}function b(a,b){var c=9*(b+1>>>1)+8*(b>>>1)+a;return c}for(var c=this.adtFile.mcnkObjs,d=[],e=[],f=0;f<c.length;f++){var g=c[f],h=g.holes;e.push(d.length);for(var i=!0,j=0;4>j;j++)for(var k=0;4>k;k++)if(!a(h,j,k))for(var l=2*j,m=4*k,n=0;2>n;n++){i?i=!1:d.push(b(l,m+2*n));for(var o=0;3>o;o++)d.push(b(l+o,m+2*n)),d.push(b(l+o,m+2*n+2));d.push(b(l+2,m+2*n+2))}}e.push(d.length);var p={strips:d,stripOffsets:e};this.triangleStrip=p},createVBO:function(){var a=this.gl,b=(this.adtFile,[]);this.indexOffset=b.length;for(var c=0;145>c;c++)b.push(c);this.heightOffset=b.length;for(var d=this.adtFile.mcnkObjs,c=0;c<d.length;c++)for(var e=0;145>e;e++)b.push(d[c].heights[e]);this.combinedVbo=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,this.combinedVbo),a.bufferData(a.ARRAY_BUFFER,new Float32Array(b),a.STATIC_DRAW),this.stripVBO=a.createBuffer(),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.stripVBO),a.bufferData(a.ELEMENT_ARRAY_BUFFER,new Int16Array(this.triangleStrip.strips),a.STATIC_DRAW)},draw:function(){var a=this.gl,b=this.triangleStrip.stripOffsets,c=this.sceneApi.shaders.getShaderUniforms(),d=this.sceneApi.shaders.getShaderAttributes();a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.stripVBO),a.bindBuffer(a.ARRAY_BUFFER,this.combinedVbo),a.vertexAttribPointer(d.aIndex,1,a.FLOAT,!1,0,4*this.indexOffset);for(var e=this.adtFile.mcnkObjs,f=0;256>f;f++){var g=e[f];if(a.vertexAttribPointer(d.aHeight,1,a.FLOAT,!1,0,4*(this.heightOffset+145*f)),a.uniform3f(c.uPos,g.pos.x,g.pos.y,g.pos.z),this.textureArray[f]&&this.textureArray[f][0]){a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,this.textureArray[f][0].texture),a.activeTexture(a.TEXTURE1),a.bindTexture(a.TEXTURE_2D,this.alphaTextures[f]);for(var h=1;h<this.textureArray[f].length;h++)a.activeTexture(a.TEXTURE1+h),this.textureArray[f][h]&&this.textureArray[f][h].texture?a.bindTexture(a.TEXTURE_2D,this.textureArray[f][h].texture):a.bindTexture(a.TEXTURE_2D,null);var i=0==f?0:b[f+1]-b[f];a.drawElements(a.TRIANGLE_STRIP,i,a.UNSIGNED_SHORT,2*b[f])}}}},f}]);var m2GeomCache=angular.module("js.wow.render.geometry.m2GeomCache",["main.services.map.mdxLoader","js.wow.render.cacheTemplate"]);m2GeomCache.factory("m2GeomCache",["mdxLoader","cacheTemplate","$q",function(a,b,c){function d(a){this.sceneApi=a,this.gl=a.getGlContext()}function e(c){var e=this,f=b(function(b){return a(b)},function(a){var b=new d(c);return b.assign(a),b.createVBO(),b.loadTextures(),b});e.loadM2=function(a){return f.get(a)},e.unLoadM2=function(a){f.remove(a)}}return d.prototype={sceneApi:null,gl:null,combinedVBO:null,textureArray:[],assign:function(a){this.m2File=a},loadTextures:function(){for(var a=this.m2File.textureDefinition,b=0;b<a.length;b++)this.loadTexture(b,a[b].textureName)},loadTexture:function(a,b){var c=this;this.sceneApi.resources.loadTexture(b).then(function(b){c.textureArray[a]=b},function(){})},createVBO:function(){var a=this.gl,b=this.m2File;this.vertexVBO=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,this.vertexVBO),a.bufferData(a.ARRAY_BUFFER,b.vertexes,a.STATIC_DRAW)},setupPlacementAttribute:function(a){var b=this.gl,c=this.sceneApi.shaders.getShaderAttributes();b.bindBuffer(b.ARRAY_BUFFER,a),b.vertexAttribPointer(c.uPlacementMat+0,4,b.FLOAT,!1,64,0),b.vertexAttribPointer(c.uPlacementMat+1,4,b.FLOAT,!1,64,16),b.vertexAttribPointer(c.uPlacementMat+2,4,b.FLOAT,!1,64,32),b.vertexAttribPointer(c.uPlacementMat+3,4,b.FLOAT,!1,64,48);
},setupAttributes:function(a){var b=this.gl,c=this.sceneApi.shaders.getShaderAttributes();b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,a.indexVBO),b.bindBuffer(b.ARRAY_BUFFER,this.vertexVBO),b.vertexAttribPointer(c.aPosition,3,b.FLOAT,!1,48,0),b.vertexAttribPointer(c.boneWeights,4,b.UNSIGNED_BYTE,!0,48,12),b.vertexAttribPointer(c.bones,4,b.UNSIGNED_BYTE,!1,48,16),c.aNormal&&b.vertexAttribPointer(c.aNormal,3,b.FLOAT,!1,48,20),b.vertexAttribPointer(c.aTexCoord,2,b.FLOAT,!1,48,32),b.vertexAttribPointer(c.aTexCoord2,2,b.FLOAT,!1,48,40)},setupUniforms:function(a,b){var c=this.gl,d=this.sceneApi.shaders.getShaderUniforms();a&&c.uniformMatrix4fv(d.uPlacementMat,!1,a),b&&c.uniformMatrix4fv(d.uBoneMatrixes,!1,b)},draw:function(a,b,c,d,e,f,g,h){var i=this.gl,j=(this.m2File,this.sceneApi.shaders.getShaderUniforms());this.sceneApi.shaders.getShaderAttributes();if(this.setupUniforms(c),this.setupAttributes(a),b)for(var k=0;k<b.length;k++)this.drawMesh(k,b[k],a,e,f);i.uniform1f(j.uAlphaTest,-1)},drawMesh:function(a,b,c,d,e,f,g,h,i){var j=this.gl,k=this.m2File,l=this.sceneApi.extensions.getInstancingExt(),m=this.sceneApi.getBlackPixelTexture(),n=c.skinFile.header,o=this.sceneApi.shaders.getShaderUniforms(),p=this.sceneApi.shaders.getShaderAttributes();if(j.uniformMatrix4fv(o.uTextMat1,!1,g),j.uniformMatrix4fv(o.uTextMat2,!1,h),b.isRendered&&b.texUnit1Texture){var q=n.texs[b.texUnit1TexIndex].colorIndex,r=[e[0],e[1],e[2],e[3]];if(q>=0&&d){var s=d[q];r=[r[0]*s[0],r[1]*s[1],r[2]*s[2],r[3]*s[3]]}var t=1,u=n.texs[b.texUnit1TexIndex].transpIndex;if(u>=0&&f&&(t=f[u]),r[3]=r[3]*t,0==t)return;j.vertexAttrib4f(p.aColor,r[0],r[1],r[2],r[3]),j.depthMask(!0);var v=n.texs[b.texUnit1TexIndex].renderFlagIndex,w=k.renderFlags[v];switch(w.blend){case 0:j.disable(j.BLEND),j.uniform1f(o.uAlphaTest,-1);break;case 1:j.disable(j.BLEND),j.uniform1f(o.uAlphaTest,.903921569);break;case 2:j.uniform1f(o.uAlphaTest,-1),j.enable(j.BLEND),j.blendFunc(j.SRC_ALPHA,j.ONE_MINUS_SRC_ALPHA);break;case 3:j.uniform1f(o.uAlphaTest,-1),j.enable(j.BLEND),j.blendFunc(j.SRC_COLOR,j.ONE);break;case 4:j.uniform1f(o.uAlphaTest,.00392157),j.enable(j.BLEND),j.blendFunc(j.SRC_ALPHA,j.ONE);break;default:j.uniform1f(o.uAlphaTest,-1),j.enable(j.BLEND),j.blendFunc(j.DST_COLOR,j.SRC_COLOR)}(8&w.flags)>0,(4&w.flags)>0?j.disable(j.CULL_FACE):j.enable(j.CULL_FACE),(16&w.flags)>0?j.depthMask(!1):j.depthMask(!0),j.activeTexture(j.TEXTURE0),j.bindTexture(j.TEXTURE_2D,b.texUnit1Texture.texture),null!=b.texUnit2Texture?(j.activeTexture(j.TEXTURE1),j.bindTexture(j.TEXTURE_2D,b.texUnit2Texture.texture)):(j.activeTexture(j.TEXTURE1),j.bindTexture(j.TEXTURE_2D,m)),void 0==i?j.drawElements(j.TRIANGLES,n.subMeshes[a].idxCount,j.UNSIGNED_SHORT,2*n.subMeshes[a].idxStart):l.drawElementsInstancedANGLE(j.TRIANGLES,n.subMeshes[a].idxCount,j.UNSIGNED_SHORT,2*n.subMeshes[a].idxStart,i),null!=b.texUnit2Texture&&(j.activeTexture(j.TEXTURE1),j.bindTexture(j.TEXTURE_2D,null),j.activeTexture(j.TEXTURE0)),j.depthMask(!0)}}},e}]);var m2GeomCache=angular.module("js.wow.render.geometry.skinGeomCache",["main.services.map.skinLoader","js.wow.render.cacheTemplate"]);m2GeomCache.factory("skinGeomCache",["skinLoader","cacheTemplate","$q",function(a,b,c){function d(a){this.gl=a.getGlContext(),this.indexVBO=null,this.assign=function(a){this.skinFile=a},this.createVBO=function(){var a=this.gl,b=(this.skinFile,[]),c=this.skinFile.header;b.length=c.triangles.length;for(var d=0;d<b.length;d++)b[d]=c.indexes[c.triangles[d]];this.indexVBO=a.createBuffer(),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.indexVBO),a.bufferData(a.ELEMENT_ARRAY_BUFFER,new Int16Array(b),a.STATIC_DRAW)}}function e(c){var e=this,f=b(function(b){return a(b,!0)},function(a){var b=new d(c);return b.assign(a),b.createVBO(),b});e.loadSkin=function(a){return f.get(a)},e.unLoadSkin=function(a){f.remove(a)}}return e}]),function(a,b,c){function d(a,b){this.gl=b.getGlContext(),this.sceneApi=b,this.combinedVBO=null,this.indexVBO=null,this.wmoGroupFile=a,this.textureArray=[],this.loadTextures=function(a){this.momt=a,this.textureArray.length=this.wmoGroupFile.renderBatches.length;for(var b=0;b<this.wmoGroupFile.renderBatches.length;b++){var c=this.wmoGroupFile.renderBatches[b].tex;this.loadTexture(b,0,a[c].textureName1),this.loadTexture(b,1,a[c].textureName2)}},this.loadTexture=function(a,c,d){var e=this;d&&b.resources.loadTexture(d).then(function(b){e.textureArray[a]||(e.textureArray[a]=[]),e.textureArray[a][c]=b},function(){})},this.createVBO=function(){var a=this.gl,b=this.wmoGroupFile,c=function(a,b,c,d,e,f){var g=4*a.length+4*b.length+4*c.length;d&&(g+=4*d.length),e&&(g+=4*e.length),f&&(g+=4*f.length);var h=0,i=new Uint8Array(g);return i.set(new Uint8Array(new Float32Array(a).buffer),0),h+=4*a.length,i.set(new Uint8Array(new Float32Array(b).buffer),h),h+=4*b.length,i.set(new Uint8Array(new Float32Array(c).buffer),h),h+=4*c.length,d&&(i.set(new Uint8Array(new Float32Array(d).buffer),h),h+=4*d.length),e&&e.buffer&&(i.set(new Uint8Array(e.buffer),h),h+=4*e.length),f&&f.buffer&&(i.set(new Uint8Array(f.buffer),h),h+=4*f.length),i},d=c(b.verticles,b.normals,b.textCoords,b.textCoords2,b.colorVerticles,b.colorVerticles2);if(this.combinedVBO=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,this.combinedVBO),a.bufferData(a.ARRAY_BUFFER,d,a.STATIC_DRAW),this.positionOffset=0,this.normalOffset=this.positionOffset+b.verticles.length,this.textOffset=this.normalOffset+b.normals.length,this.textOffset2=this.textOffset+b.textCoords.length,this.colorOffset=this.textOffset2+b.textCoords2.length,this.colorOffset2=this.colorOffset+(b.colorVerticles&&b.colorVerticles.length>0)?b.colorVerticles.length/4:0,this.indexVBO=a.createBuffer(),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.indexVBO),a.bufferData(a.ELEMENT_ARRAY_BUFFER,new Int16Array(b.indicies),a.STATIC_DRAW),b.mobr){this.mobrVBO=a.createBuffer(),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.mobrVBO);for(var e=new Array(3*b.mobr.length),f=0;f<b.mobr.length;f++)e[3*f+0]=b.indicies[3*b.mobr[f]+0],e[3*f+1]=b.indicies[3*b.mobr[f]+1],e[3*f+2]=b.indicies[3*b.mobr[f]+2];a.bufferData(a.ELEMENT_ARRAY_BUFFER,new Int16Array(e),a.STATIC_DRAW),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,null)}},this.draw=function(a){var b=this.gl,d=this.sceneApi.shaders.getShaderUniforms(),e=this.sceneApi.shaders.getShaderAttributes(),f=this.sceneApi.getBlackPixelTexture(),g=this.wmoGroupFile,h=(8192&g.mogp.Flags)>0;b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,this.indexVBO),b.bindBuffer(b.ARRAY_BUFFER,this.combinedVBO),b.enableVertexAttribArray(e.aPosition),b.vertexAttribPointer(e.aPosition,3,b.FLOAT,!1,0,0),e.aNormal!==c&&b.vertexAttribPointer(e.aNormal,3,b.FLOAT,!1,0,4*this.normalOffset),b.vertexAttribPointer(e.aTexCoord,2,b.FLOAT,!1,0,4*this.textOffset),e.aTexCoord2&&(g.textCoords2&&g.textCoords2.length>0?(b.enableVertexAttribArray(e.aTexCoord2),b.vertexAttribPointer(e.aTexCoord2,2,b.FLOAT,!1,0,4*this.textOffset2)):(b.disableVertexAttribArray(e.aTexCoord2),b.vertexAttrib2f(e.aTexCoord2,1,1))),e.aColor&&(h&&g.colorVerticles&&g.colorVerticles.length>1?(b.enableVertexAttribArray(e.aColor),b.vertexAttribPointer(e.aColor,4,b.UNSIGNED_BYTE,!0,0,4*this.colorOffset)):(b.disableVertexAttribArray(e.aColor),b.vertexAttrib4f(e.aColor,1,1,1,1))),e.aColor2&&(h&&g.colorVerticles2&&g.colorVerticles2.length>0?(b.enableVertexAttribArray(e.aColor2),b.vertexAttribPointer(e.aColor2,4,b.UNSIGNED_BYTE,!0,0,4*this.colorOffset2)):(b.disableVertexAttribArray(e.aColor2),b.vertexAttrib4f(e.aColor2,1,1,1,1))),b.activeTexture(b.TEXTURE0),b.uniform1f(d.uAlphaTest,-1);for(var i=0;i<g.renderBatches.length;i++){var j=g.renderBatches[i],k=j.tex;if(0!=this.momt[k].blendMode){var l=.878431;(128&this.momt[k].flags1)>0,(1&this.momt[k].flags1)>0&&(l=.1),b.uniform1f(d.uAlphaTest,l)}else b.uniform1f(d.uAlphaTest,-1);(4&this.momt[k].flags1)>0?b.disable(b.CULL_FACE):b.enable(b.CULL_FACE);var m=this.textureArray[i];if(b.activeTexture(b.TEXTURE0),m&&m[0]&&b.bindTexture(b.TEXTURE_2D,m[0].texture),m&&m[1]?(b.activeTexture(b.TEXTURE1),b.bindTexture(b.TEXTURE_2D,m[1].texture)):(b.activeTexture(b.TEXTURE1),b.bindTexture(b.TEXTURE_2D,f)),a){var n=j.startIndex/3,o=j.count/3,p=n+o,q=this.wmoGroupFile.mobr.slice(a.firstFace,a.firstFace+a.numFaces-1);q=q.sort(function(a,b){return b>a?-1:1});for(var r=0;p>n;){for(;q[r]<n;)r++;for(;n==q[r];)n++,r++;o=p-n,n<q[r]&&n+o>q[r]&&(o=q[r]-n),b.drawElements(b.TRIANGLES,3*o,b.UNSIGNED_SHORT,3*n*2),n+=o}}else b.drawElements(b.TRIANGLES,j.count,b.UNSIGNED_SHORT,2*j.startIndex);m&&m[1]&&(b.activeTexture(b.TEXTURE1),b.bindTexture(b.TEXTURE_2D,null),b.activeTexture(b.TEXTURE0))}b.uniform1f(d.uAlphaTest,-1)},this.destroy=function(){var a=this.gl;this.texture&&a.deleteTexture(this.texture),this.texture=null}}var e=angular.module("js.wow.render.geometry.wmoGeomCache",["main.services.map.wmoLoader","js.wow.render.cacheTemplate"]);e.factory("wmoGeomCache",["wmoGroupLoader","cacheTemplate","$q",function(a,b,c){function e(c){var e=this,f=b(function(b){return a(b,!0)},function(a){var b=new d(a,c);return b.createVBO(),b});e.loadWmoGeom=function(a){return f.get(a)},e.unLoadWmoGeom=function(a){f.remove(a)}}return e}])}(window,jQuery),function(a,b,c){var d=angular.module("js.wow.render.geometry.wmoMainCache",["main.services.map.wmoLoader","js.wow.render.cacheTemplate"]);d.factory("wmoMainCache",["wmoLoader","cacheTemplate","$q",function(a,b,c){function d(c){var d=this,e=b(function(b){return a(b)},function(a){return a});d.loadWmoMain=function(a){return e.get(a)},d.unLoadWmoMain=function(a){e.remove(a)}}return d}])}(window,jQuery),function(a,b,c){var d=angular.module("js.wow.render.scene.graph",["js.wow.math.mathHelper"]);d.factory("graphManager",["$q","configService","adtObjectFactory","adtM2ObjectFactory","wmoM2ObjectFactory","wmoObjectFactory","mathHelper",function(a,b,c,d,e,f,g){function h(a){this.sceneApi=a,this.mdxObjectList=[],this.sceneObjNumMap={},this.lastUpdatedNumber=0}function i(a){this.sceneApi=a,this.m2Objects=[],this.instanceList={},this.wmoObjects=[],this.adtObjects=[],this.skyDom=null,this.currentTime=0,this.lastTimeSort=0,this.globalM2Counter=0}return h.prototype={addMDXObject:function(a){this.sceneObjNumMap[a.sceneNumber]||(this.sceneObjNumMap[a.sceneNumber]=a,this.mdxObjectList.push(a))},updatePlacementVBO:function(){var a=this.sceneApi.getGlContext(),b=this.permanentBuffer;b&&b.length==16*this.mdxObjectList.length||(b=new Float32Array(16*this.mdxObjectList.length),this.permanentBuffer=b);var c=this.placementVBO;c||(c=a.createBuffer());for(var d=0;d<this.mdxObjectList.length;d++){var e=this.mdxObjectList[d],f=e.placementMatrix;b.set(f,16*d)}a.bindBuffer(a.ARRAY_BUFFER,c),a.bufferData(a.ARRAY_BUFFER,b,a.DYNAMIC_DRAW),this.placementVBO=c,this.lastUpdatedNumber=this.mdxObjectList.length},drawInstancedNonTransparentMeshes:function(){this.mdxObjectList[0]&&this.mdxObjectList[0].drawInstancedNonTransparentMeshes(this.lastUpdatedNumber,this.placementVBO,this.dinamycParams)},drawInstancedTransparentMeshes:function(){this.mdxObjectList[0]&&this.mdxObjectList[0].drawInstancedTransparentMeshes(this.lastUpdatedNumber,this.placementVBO,this.dinamycParams)}},i.prototype={addAdtM2Object:function(a){var b=new d(this.sceneApi);return b.load(a,!1),b.sceneNumber=this.globalM2Counter++,this.m2Objects.push(b),b},addWmoM2Object:function(a,b,c){var d=new e(this.sceneApi),f=d.load(a,b,c);return d.sceneNumber=this.globalM2Counter++,this.m2Objects.push(d),f.then(function(){return d},function(){})},addWmoObject:function(a){var b=new f(this.sceneApi);return b.load(a),this.wmoObjects.push(b),b},addADTObject:function(a){var b=new c(this.sceneApi);b.load(a),this.adtObjects.push(b)},addM2ObjectToInstanceManager:function(a,b){var c=a.getFileNameIdent(),d=this.instanceList[c];d||(d=new h(this.sceneApi),this.instanceList[c]=d),d.addMDXObject(a,b),a.instanceManager=d},setCameraPos:function(a){this.position=a},setLookAtMat:function(a){this.lookAtMat=a},collectMeshes:function(){for(var a=[],b=0;b<this.m2Objects.length;b++){var c=this.m2Objects[b].getMeshesToRender();a=a.concat(c)}var d=a.filter(function(a){return a&&!a.isTransparent}),e=a.filter(function(a){return a&&a.isTransparent});d.sort(function(a,b){return a.m2Object==b.m2Object?0:1}),d.sort(function(a,b){return a.m2Object==b.m2Object&&a.skin==b.skin?0:1}),d.sort(function(a,b){return a.m2Object==b.m2Object&&a.skin==b.skin&&a.meshIndex==b.meshIndex?0:b.meshIndex-a.meshIndex}),e.sort(function(a,b){}),this.nonTransparentM=d,this.transparentM=e},checkCulling:function(a,b){for(var c=0;c<this.m2Objects.length;c++)this.m2Objects[c].setIsRendered(!0);if(this.currentInteriorGroup>=0){for(var c=0;c<this.m2Objects.length;c++)this.m2Objects[c].setIsRendered(!1);for(var d=0;d<this.wmoObjects.length;d++)this.wmoObjects[d].resetDrawnForAllGroups(!1);this.checkNormalFrustumCulling(a,b)}else this.checkNormalFrustumCulling(a,b)},checkNormalFrustumCulling:function(a,b){var c=mat4.create();mat4.multiply(c,a,b);for(var d=g.getFrustumClipsFromMatrix(c),e=0;e<this.wmoObjects.length;e++)this.wmoObjects[e].resetDrawnForAllGroups(!0),this.wmoObjects[e].checkFrustumCulling(this.position,a,b,d),this.wmoObjects[e].setIsRenderedForDoodads();for(var f=0;f<this.m2Objects.length;f++)this.m2Objects[f].getIsRendered()&&this.m2Objects[f].checkFrustumCulling(this.position,d);for(var f=0;f<this.m2Objects.length;f++){var h=this.m2Objects[f];h.getIsRendered()&&h.setIsRendered(100*h.getDiameter()>h.getCurrentDistance())}},checkAgainstDepthBuffer:function(a,b,c,d,e){function f(a,b){var e=b*d+a,f=1-c[e];return f}function g(a,b){var c=a*i+b,d=k[c];return d}function h(a,b,c,d,e){if(0>e)return!1;a=(a+1)/2,b=(b+1)/2,c=(c+1)/2,d=(d+1)/2,a=Math.floor(a*i),b=Math.floor(b*i),c=Math.floor(c*j),d=Math.floor(d*j);for(var f=!1,h=a;b>=h;h++)for(var k=c;d>=k;k++)if(g(h,k)<e)return f=!0,!0;return!1}for(var i=Math.floor(d/8),j=Math.floor(e/8),k=new Float32Array(i*j),l=0;i>l;l++)for(var m=8*l,n=Math.min(8*(l+1),d),o=0;j>o;o++){for(var p=1,q=8*o,r=Math.min(8*(o+1),e),s=m;n>s;s++)for(var t=q;r>t;t++)p=Math.min(f(s,t),p);k[l*i+o]=p}for(var u=0;u<this.m2Objects.length;u++)this.m2Objects[u].getIsRendered()&&this.m2Objects[u].checkAgainstDepthBuffer(a,b,h)},update:function(a){var c;if(b.getRenderM2())for(c=0;c<this.m2Objects.length;c++)this.m2Objects[c].update(a,this.position);for(c=0;c<this.wmoObjects.length;c++)this.wmoObjects[c].update(a);if(this.currentTime+a-this.lastTimeSort>500){for(var d=this,e=0;e<this.m2Objects.length;e++)this.m2Objects[e].calcDistance(d.position);this.m2Objects.sort(function(a,b){return b.getCurrentDistance()-a.getCurrentDistance()>0?1:-1})}if(this.currentTime+a-this.lastTimeSort>1e3)for(var f in this.instanceList){var g=this.instanceList[f];g.updatePlacementVBO()}this.currentInteriorGroup=-1,this.currentWMO=null;for(var h=-1,i=-1,c=0;c<this.wmoObjects.length;c++){var j=this.wmoObjects[c].isInsideInterior(this.position);if(i=j.groupId,i>=0){this.currentWMO=this.wmoObjects[c],this.currentInteriorGroup=i,h=j.nodeId;break}}return this.currentTime=this.currentTime+a,{interiorGroupNum:i,nodeId:h}},draw:function(){this.sceneApi.shaders.activateAdtShader();for(var a=0;a<this.adtObjects.length;a++)this.adtObjects[a].draw();this.sceneApi.shaders.activateDrawPortalShader();for(var a=0;a<this.wmoObjects.length;a++)this.wmoObjects[a].drawBspVerticles();this.sceneApi.shaders.activateWMOShader();for(var a=0;a<this.wmoObjects.length;a++)this.wmoObjects[a].draw();if(this.sceneApi.shaders.deactivateWMOShader(),this.skyDom&&this.skyDom.draw(),b.getRenderM2()){this.sceneApi.shaders.activateM2Shader();for(var a=0;a<this.m2Objects.length;a++)this.m2Objects[a].instanceManager||this.m2Objects[a].getIsRendered()&&this.m2Objects[a].drawNonTransparentMeshes();this.sceneApi.shaders.deactivateM2Shader()}this.sceneApi.shaders.activateDrawPortalShader();for(var a=0;a<this.wmoObjects.length;a++)this.wmoObjects[a].drawPortals();if(b.getRenderM2()){this.sceneApi.shaders.activateM2Shader();for(var a=0;a<this.m2Objects.length;a++)this.m2Objects[a].instanceManager||this.m2Objects[a].getIsRendered()&&this.m2Objects[a].drawTransparentMeshes();this.sceneApi.shaders.deactivateM2Shader()}if(this.sceneApi.shaders.activateBoundingBoxShader(),b.getRenderM2())for(var a=0;a<this.m2Objects.length;a++)this.m2Objects[a].getIsRendered()&&this.m2Objects[a].drawBB();for(var a=0;a<this.wmoObjects.length;a++)this.wmoObjects[a].drawBB()}},i}])}(window,jQuery),MathHelper.prototype={getFrustumClipsFromMatrix:function(a){var b=new Array(6);b[0]=vec4.fromValues(a[3]-a[0],a[7]-a[4],a[11]-a[8],a[15]-a[12]),b[1]=vec4.fromValues(a[3]+a[0],a[7]+a[4],a[11]+a[8],a[15]+a[12]),b[2]=vec4.fromValues(a[3]+a[1],a[7]+a[5],a[11]+a[9],a[15]+a[13]),b[3]=vec4.fromValues(a[3]-a[1],a[7]-a[5],a[11]-a[9],a[15]-a[13]),b[4]=vec4.fromValues(a[3]-a[2],a[7]-a[6],a[11]-a[10],a[15]-a[14]),b[5]=vec4.fromValues(a[3]+a[2],a[7]+a[6],a[11]+a[10],a[15]+a[14]);for(var c=0;6>c;c++){var d=1/vec3.length(b[c]);vec4.scale(b[c],b[c],d)}return b},checkFrustum:function(a,b){for(var c=0;6>c;c++){var d=0;if(d+=vec4.dot(a[c],vec4.fromValues(b[0][0],b[0][1],b[0][2],1))<0?1:0,d+=vec4.dot(a[c],vec4.fromValues(b[1][0],b[0][1],b[0][2],1))<0?1:0,d+=vec4.dot(a[c],vec4.fromValues(b[0][0],b[1][1],b[0][2],1))<0?1:0,d+=vec4.dot(a[c],vec4.fromValues(b[1][0],b[1][1],b[0][2],1))<0?1:0,d+=vec4.dot(a[c],vec4.fromValues(b[0][0],b[0][1],b[1][2],1))<0?1:0,d+=vec4.dot(a[c],vec4.fromValues(b[1][0],b[0][1],b[1][2],1))<0?1:0,d+=vec4.dot(a[c],vec4.fromValues(b[0][0],b[1][1],b[1][2],1))<0?1:0,d+=vec4.dot(a[c],vec4.fromValues(b[1][0],b[1][1],b[1][2],1))<0?1:0,8==d)return!1}return!0},transformAABBWithMat4:function(a,b){var c=vec4.create(),d=vec4.create();vec4.scale(c,vec4.fromValues(a[0],a[1],a[2],a[3]),b[0][0]),vec4.scale(d,vec4.fromValues(a[0],a[1],a[2],a[3]),b[1][0]);var e=vec4.create(),f=vec4.create();vec4.scale(e,vec4.fromValues(a[4],a[5],a[6],a[7]),b[0][1]),vec4.scale(f,vec4.fromValues(a[4],a[5],a[6],a[7]),b[1][1]);var g=vec4.create(),h=vec4.create();vec4.scale(g,vec4.fromValues(a[8],a[9],a[10],a[11]),b[0][2]),vec4.scale(h,vec4.fromValues(a[8],a[9],a[10],a[11]),b[1][2]);var i=vec4.create(),j=vec4.create(),k=vec4.create(),l=vec4.create(),m=vec4.create(),n=vec4.create();vec3.min(i,c,d),vec3.max(l,c,d),vec3.min(j,e,f),vec3.max(m,e,f),vec3.min(k,g,h),vec3.max(n,g,h);var o=vec4.fromValues(a[12],a[13],a[14],0),p=vec4.create(),q=vec4.create();return vec4.add(p,i,j),vec4.add(p,p,k),vec4.add(p,p,o),vec4.add(q,l,m),vec4.add(q,q,n),vec4.add(q,q,o),[p,q]}};var cacheTemplate=angular.module("js.wow.math.mathHelper",[]);cacheTemplate.service("mathHelper",MathHelper),function(a,b,c){var d=angular.module("js.wow.render.mdxObject",["js.wow.math.mathHelper"]);d.factory("mdxObject",["$q","$timeout","$log","mathHelper",function(a,b,d,e){function f(a){this.sceneApi=a,this.currentAnimation=0,this.currentTime=0,this.isAnimated=!1}return f.prototype={sceneApi:null,subMeshColors:null,load:function(b,c,e){var f=this,g=b.split(".")[0],h=g+".m2",i=g+"00.skin",j=this.sceneApi.resources.loadM2Geom(h),k=this.sceneApi.resources.loadSkinGeom(i);return this.fileIdent=h+" "+i,a.all([j,k]).then(function(a){var c=a[0],g=a[1];if(f.m2Geom=c,f.skinGeom=g,c){f.sceneApi.getGlContext();f.makeSubmeshArray(c,g,e)}else d.log("m2 file failed to load : "+b)})},makeSubmeshArray:function(a,b,c){var e=this,f=new Array(15);if(c)c.forEach(function(a,b){f[b]={submeshIndex:0}});else{f.length=b.skinFile.header.subMeshes.length;for(var g=0;g<f.length;g++)f[g]={isRendered:!1,isTransparent:!1,textureTexUnit1:null,textureTexUnit2:null,textureTexUnit3:null};for(var g=0;g<b.skinFile.header.texs.length;g++){var h=b.skinFile.header.texs[g],i=a.m2File.texLookup[h.textureIndex],j=a.m2File.textureDefinition[i],k=a.m2File.textUnitLookup[h.textureUnitNum],l=h.op_count,m=h.renderFlagIndex,n=a.m2File.renderFlags[m].blend>=2,o=f[h.submeshIndex];if(o.isRendered=!0,o.isTransparent=n,0==k){if(o.texUnit1TexIndex=g,o.textureUnit1TexName=j.textureName,l>1){var p=a.m2File.texLookup[h.textureIndex+1],q=a.m2File.textureDefinition[p];o.texUnit2TexIndex=g,o.textureUnit2TexName=q.textureName}if(l>2){var r=a.m2File.texLookup[h.textureIndex+2],s=a.m2File.textureDefinition[r];o.texUnit2TexIndex=g,o.textureUnit2TexName=s.textureName}}else if(1==k){if(o.texUnit2TexIndex=g,o.textureUnit2TexName=j.textureName,l>1){d.log("textureUnit = 1 and op_count > 1 "+this.fileIdent);var r=a.m2File.texLookup[h.textureIndex+1],s=a.m2File.textureDefinition[r];o.textureUnit3TexName=s.textureName}}else 2==k&&(d.log("textureUnit = 2 "+this.fileIdent),o.texUnit3TexIndex=g,o.textureUnit3TexName=j.textureName)}for(var g=0;g<f.length;g++){var o=f[g];o.textureUnit1TexName&&!function(a){e.sceneApi.resources.loadTexture(a.textureUnit1TexName).then(function(b){a.texUnit1Texture=b},function(){})}(o),o.textureUnit2TexName&&!function(a){e.sceneApi.resources.loadTexture(a.textureUnit2TexName).then(function(b){a.texUnit2Texture=b},function(){})}(o),o.textureUnit3TexName&&!function(a){e.sceneApi.resources.loadTexture(a.textureUnit3TexName).then(function(b){a.texUnit3Texture=b},function(){})}(o)}}this.submeshArray=f},checkFrustumCulling:function(a,b,c){if(a[0]>c[0][0]&&a[0]<c[1][0]&&a[1]>c[0][1]&&a[1]<c[1][1]&&a[2]>c[0][2]&&a[2]<c[1][2])return!0;var d=e.checkFrustum(b,c);return d},checkAgainstDepthBuffer:function(a,b,c,d){var e=this.getBoundingBox();if(!e)return!1;var f=mat4.create();mat4.multiply(f,a,b),mat4.multiply(f,f,c);var g=e.ab,h=e.cd,i=vec4.fromValues(g.x,g.y,g.z,1),j=vec4.fromValues(h.x,h.y,h.z,1);vec4.transformMat4(i,i,f),vec4.transformMat4(j,j,f),vec4.scale(i,i,1/i[3]),vec4.scale(j,j,1/j[3]);var k=Math.max(0,Math.min(i[2],j[2])),l=Math.min(i[0],j[0]);l=Math.max(l,-1);var m=Math.max(i[0],j[0]);m=Math.min(m,1);var n=Math.min(i[1],j[1]);n=Math.max(n,-1);var o=Math.max(i[1],j[1]);return o=Math.min(o,1),d(l,m,n,o,k)},createVAO:function(a,b,c){var d=a.getExtension("OES_vertex_array_object");if(d){var e=d.createVertexArrayOES();d.bindVertexArrayOES(e),b.setupAttributes(a,c),d.bindVertexArrayOES(null)}return{vao:e,ext:d}},getSubMeshColor:function(a){var b=this.m2Geom.m2File.colors,c=this.currentAnimation;if(b.length>0){var d=this.subMeshColors;d||(d=new Array(b.length));for(var e=0;e<b.length;e++){var f=this.getTimedValue(0,a,b[e].color.interpolation_type,b[e].color.timestampsPerAnimation[c],b[e].color.valuesPerAnimation[c]),g=this.getTimedValue(2,a,b[e].alpha.interpolation_type,b[e].alpha.timestampsPerAnimation[c],b[e].alpha.valuesPerAnimation[c]);d[e]=[f[0],f[1],f[2],g[0]]}return d}return null},getTransperencies:function(a){var b=this.m2Geom.m2File.transparencies,c=this.currentAnimation;if(b.length>0){var d=this.transperencies;d||(d=new Array(b.length));for(var e=0;e<b.length;e++){var f=this.getTimedValue(2,a,b[e].values.interpolation_type,b[e].values.timestampsPerAnimation[c],b[e].values.valuesPerAnimation[c]);d[e]=f[0]}return d}return null},getMeshesToRender:function(){var a=[];if(this.submeshArray)for(var b=0;b<this.submeshArray.length;b++)if(this.submeshArray[b].isRendered&&this.submeshArray[b].texUnit1TexIndex!==c){var d=this.skinGeom.skinFile.header.texs[this.submeshArray[b].texUnit1TexIndex].colorIndex,e=this.skinGeom.skinFile.header.texs[this.submeshArray[b].texUnit1TexIndex].renderFlagIndex,f=this.m2Geom.m2File.renderFlags[e].blend>0,g=d>-1&&this.subMeshColors?this.subMeshColors[d]:null,h={m2Object:this,skin:this.skinGeom,meshIndex:b,color:g,transparency:0,isTransparent:f,animationMatrix:null};a.push(h)}return a},getBoundingBox:function(){return this.m2Geom?{ab:this.m2Geom.m2File.BoundingCorner1,cd:this.m2Geom.m2File.BoundingCorner2}:null},update:function(a,b,c){if(this.m2Geom){var d=this.getSubMeshColor(this.currentTime+a);this.subMeshColors=d;var e=this.getTransperencies(this.currentTime+a);this.transperencies=e,this.calcBones(this.currentAnimation,this.currentTime+a,b,c),this.calcAnimMatrixes(this.currentTime+a),this.currentTime+=a}},interpolateValues:function(a,b,c,d,e,f){if(b>=1){var g=vec4.create();vec4.subtract(g,f,e),vec4.scale(g,g,(a-c)/(d-c));var h=vec4.create();return vec4.add(h,e,g),h}},getTimedValue:function(a,b,c,d,e){function f(a){return(0>a?a+32768:a-32767)/32767}function g(a,b){return 0==b?[a.x,a.y,a.z,0]:1==b?[f(a[0]),f(a[1]),f(a[2]),f(a[3])]:2==b?[a/32767,a/32767,a/32767,a/32767]:void 0}var h,i=d.length;if(i>1&&c>0){for(var j=d[i-1],k=b%j,l=0;i>l;l++)if(d[l]>k){var m=e[l-1],n=e[l],o=d[l-1],p=d[l];m=g(m,a),n=g(n,a),h=this.interpolateValues(k,c,o,p,m,n),1==a&&vec4.normalize(h,h);break}}else h=g(e[0],a);return h},calcAnimMatrixes:function(a){if(!this.textAnimMatrix){for(var b=new Array(this.m2Geom.m2File.texAnims.length),c=0;c<b.length;c++)b[c]=mat4.create();this.textAnimMatrix=b}for(var d=this.currentAnimation,c=0;c<this.m2Geom.m2File.texAnims.length;c++){var e=this.m2Geom.m2File.texAnims[c],f=mat4.identity(this.textAnimMatrix[c]);if(e.translation.valuesPerAnimation.length>0&&e.translation.valuesPerAnimation[d].length>0){var g=this.getTimedValue(0,a,e.translation.interpolation_type,e.translation.timestampsPerAnimation[d],e.translation.valuesPerAnimation[d]);g&&(g=mat4.translate(f,f,[g[0],g[1],g[2],0]))}if(e.rotation.valuesPerAnimation.length>0&&e.rotation.valuesPerAnimation[d].length>0){var h=this.getTimedValue(1,a,e.rotation.interpolation_type,e.rotation.timestampsPerAnimation[d],e.rotation.valuesPerAnimation[d]);if(h){var i=mat4.create();mat4.fromQuat(i,h),mat4.multiply(f,f,i)}}if(e.scale.valuesPerAnimation.length>0&&e.scale.valuesPerAnimation[d].length>0){var j=this.getTimedValue(0,a,e.scale.interpolation_type,e.scale.timestampsPerAnimation[d],e.scale.valuesPerAnimation[d]);mat4.scale(f,f,[j[0],j[1],j[2]])}this.textAnimMatrix[c]=f}},calcBoneMatrix:function(a,b,c,d,e,f){if(!b.isCalculated){var g=this.m2Geom.m2File.bones[a],h=g.parent_bone,i=mat4.create();if(i=mat4.identity(i),h>=0&&(this.calcBoneMatrix(h,this.bones[h],c,d,e,f),mat4.multiply(i,i,this.bones[h].tranformMat)),mat4.translate(i,i,[g.pivot.x,g.pivot.y,g.pivot.z,0]),g.translation.valuesPerAnimation.length>0&&g.translation.valuesPerAnimation[c].length>0){var j=this.getTimedValue(0,d,g.translation.interpolation_type,g.translation.timestampsPerAnimation[c],g.translation.valuesPerAnimation[c]);j&&(j=mat4.translate(i,i,[j[0],j[1],j[2],0]),this.isAnimated=!0)}if((8&g.flags)>0){var k=vec3.create(),l=vec4.create();vec4.copy(l,e),vec4.transformMat4(l,l,f),h>=0&&vec4.transformMat4(l,l,this.bones[h].inverTransforMat),vec4.subtract(l,l,[g.pivot.x,g.pivot.y,g.pivot.z,0]),vec3.normalize(k,l);var m=vec3.create();vec3.cross(m,[0,0,1],k),vec3.normalize(m,m);var n=vec3.create();vec3.cross(n,k,m),vec3.normalize(n,n),mat4.multiply(i,i,[k[0],k[1],k[2],0,m[0],m[1],m[2],0,n[0],n[1],n[2],0,0,0,0,1]),this.isAnimated=!0}else if(g.rotation.valuesPerAnimation.length>0&&g.rotation.valuesPerAnimation[c].length>0){var o=this.getTimedValue(1,d,g.rotation.interpolation_type,g.rotation.timestampsPerAnimation[c],g.rotation.valuesPerAnimation[c]);if(o){var p=mat4.create();mat4.fromQuat(p,o),mat4.multiply(i,i,p),this.isAnimated=!0}}if(g.scale.valuesPerAnimation.length>0&&g.scale.valuesPerAnimation[c].length>0){var q=this.getTimedValue(0,d,g.scale.interpolation_type,g.scale.timestampsPerAnimation[c],g.scale.valuesPerAnimation[c]);mat4.scale(i,i,[q[0],q[1],q[2]]),this.isAnimated=!0}mat4.translate(i,i,[-g.pivot.x,-g.pivot.y,-g.pivot.z,0]);var r=mat4.create();mat4.invert(r,i),b.tranformMat=i,b.inverTransforMat=r}},combineBoneMatrixes:function(){for(var a=new Float32Array(16*this.bones.length),b=0;b<this.bones.length;b++)a.set(this.bones[b].tranformMat,16*b);return a},calcBones:function(a,b,c,d){if(!this.m2Geom)return null;var e=this.m2Geom.m2File;if(!this.bones){this.bones=new Array(e.nBones);for(var f=0;f<e.nBones;f++)this.bones[f]||(this.bones[f]={}),this.bones[f].isCalculated=!1}if(!this.boneMatrix||this.isAnimated)for(var f=0;f<e.nBones;f++)this.calcBoneMatrix(f,this.bones[f],a,b,c,d);this.boneMatrix=this.combineBoneMatrixes()},drawInstancedNonTransparentMeshes:function(a,b,c){if(this.m2Geom){this.m2Geom.setupAttributes(this.skinGeom);var d=this.boneMatrix;this.m2Geom.setupUniforms(null,d),this.m2Geom.setupPlacementAttribute(b);var e=[255&c,c>>8&255,c>>16&255,c>>24&255];e[0]/=255,e[1]/=255,e[2]/=255,e[3]/=255;for(var f=0;f<this.submeshArray.length;f++){var g=this.submeshArray[f];g.isTransparent||this.m2Geom.drawMesh(f,g,this.skinGeom,this.subMeshColors,e,this.transperencies,textureMatrix,a)}}},drawInstancedTransparentMeshes:function(a,b,c){if(this.m2Geom){var d=mat4.create();mat4.identity(d),this.m2Geom.setupAttributes(this.skinGeom);var e=this.boneMatrix;this.m2Geom.setupUniforms(null,e),this.m2Geom.setupPlacementAttribute(b);var f=[255&c,c>>8&255,c>>16&255,c>>24&255];f[0]/=255,f[1]/=255,f[2]/=255,f[3]/=255;for(var g=0;g<this.submeshArray.length;g++){var h=this.submeshArray[g];if(h.isTransparent){var i,j=this.skinGeom.skinFile.header;if(h.texUnit1TexIndex>=0&&j.texs[h.texUnit1TexIndex]){var k=j.texs[h.texUnit1TexIndex].textureAnim,l=this.m2Geom.m2File.texAnimLookup[k];i=l>=0?this.textAnimMatrix[l]:d}this.m2Geom.drawMesh(g,h,this.skinGeom,this.subMeshColors,f,this.transperencies,i,a)}}}},drawNonTransparentMeshes:function(a,b){if(this.m2Geom&&this.skinGeom){var d=mat4.create();mat4.identity(d),this.m2Geom.setupAttributes(this.skinGeom);var e=this.boneMatrix;this.m2Geom.setupUniforms(a,e);var f=[255&b,b>>8&255,b>>16&255,b>>24&255];f[0]/=255,f[1]/=255,f[2]/=255,f[3]/=255;for(var g=0;g<this.submeshArray.length;g++){var h=this.submeshArray[g];if(!h.isTransparent){var i=d,j=d,k=this.skinGeom.skinFile.header;if(h.texUnit1TexIndex>=0&&k.texs[h.texUnit1TexIndex]){var l=k.texs[h.texUnit1TexIndex].textureAnim,m=this.m2Geom.m2File.texAnimLookup[l];if(m!==c&&m>=0&&(i=this.textAnimMatrix[m]),h.texUnit2TexIndex>=0){var m=this.m2Geom.m2File.texAnimLookup[l+1];m!==c&&m>=0&&(j=this.textAnimMatrix[m])}}this.m2Geom.drawMesh(g,h,this.skinGeom,this.subMeshColors,f,this.transperencies,i,j)}}}},drawTransparentMeshes:function(a,b){if(this.m2Geom&&this.skinGeom){var d=mat4.create();mat4.identity(d),this.m2Geom.setupAttributes(this.skinGeom);var e=this.boneMatrix;this.m2Geom.setupUniforms(a,e);var f=[255&b,b>>8&255,b>>16&255,b>>24&255];f[0]/=255,f[1]/=255,f[2]/=255,f[3]/=255;for(var g=0;g<this.submeshArray.length;g++){var h=this.submeshArray[g];if(h.isTransparent){var i=d,j=d,k=this.skinGeom.skinFile.header;if(h.texUnit1TexIndex>=0&&k.texs[h.texUnit1TexIndex]){var l=k.texs[h.texUnit1TexIndex].textureAnim,m=this.m2Geom.m2File.texAnimLookup[l];if(m!==c&&m>=0&&(i=this.textAnimMatrix[m]),h.texUnit2TexIndex>=0){var m=this.m2Geom.m2File.texAnimLookup[l+1];m!==c&&m>=0&&(j=this.textAnimMatrix[m])}}this.m2Geom.drawMesh(g,h,this.skinGeom,this.subMeshColors,f,this.transperencies,i,j)}}}},draw:function(a,b){var c=[255&b,b>>8&255,b>>16&255,b>>24&255];c[0]/=255,c[1]/=255,c[2]/=255,c[3]/=255,this.m2Geom&&this.skinGeom&&this.m2Geom.draw(this.skinGeom,this.submeshArray,a,c,this.subMeshColors,this.transperencies,this.vao,this.vaoExt)}},f}])}(window,jQuery),function(a,b,c){var d=angular.module("js.wow.render.adtM2ObjectFactory",["js.wow.render.mdxObject"]);d.factory("adtM2ObjectFactory",["mdxObject","$q","$timeout","mathHelper",function(a,b,c,d){function e(b){var c=this;c.sceneApi=b,c.mdxObject=new a(b),c.currentDistance=0,c.isRendered=!0}return e.prototype={getFileNameIdent:function(){return this.mdxObject.fileIdent},getMeshesToRender:function(){return this.mdxObject?this.mdxObject.getMeshesToRender():null},drawBB:function(){var a=this.sceneApi.getGlContext(),b=this.sceneApi.shaders.getShaderUniforms(),c=this.mdxObject.getBoundingBox();if(c){var d=c.ab,e=c.cd,f=[(d.x+e.x)/2,(d.y+e.y)/2,(d.z+e.z)/2],g=[e.x-f[0],e.y-f[1],e.z-f[2]];a.uniform3fv(b.uBBScale,new Float32Array(g)),a.uniform3fv(b.uBBCenter,new Float32Array(f)),a.uniform3fv(b.uColor,new Float32Array([.819607843,.058,.058])),a.uniformMatrix4fv(b.uPlacementMat,!1,this.placementMatrix),a.drawElements(a.LINES,48,a.UNSIGNED_SHORT,0)}},drawTransparentMeshes:function(){this.mdxObject.drawTransparentMeshes(this.placementMatrix,4294967295)},drawNonTransparentMeshes:function(){this.mdxObject.drawNonTransparentMeshes(this.placementMatrix,4294967295)},draw:function(){this.mdxObject.draw(this.placementMatrix,4294967295);
},drawInstancedNonTransparentMeshes:function(a,b){this.mdxObject.drawInstancedNonTransparentMeshes(a,b,4294967295)},drawInstancedTransparentMeshes:function(a,b){this.mdxObject.drawInstancedTransparentMeshes(a,b,4294967295)},checkFrustumCulling:function(a,b){var c=this.aabb&&this.mdxObject.checkFrustumCulling(a,b,this.aabb);this.setIsRendered(this.getIsRendered()&&c)},checkAgainstDepthBuffer:function(a,b,c){this.setIsRendered(this.getIsRendered()&&this.mdxObject.checkAgainstDepthBuffer(a,b,this.placementMatrix,c))},update:function(a,b){if(!this.aabb){var c=this.mdxObject.getBoundingBox();if(c){var e=vec4.fromValues(c.ab.x,c.ab.y,c.ab.z,1),f=vec4.fromValues(c.cd.x,c.cd.y,c.cd.z,1),g=d.transformAABBWithMat4(this.placementMatrix,[e,f]);this.diameter=vec3.distance(g[0],g[1]),this.aabb=g}}this.getIsRendered()&&this.mdxObject.update(a,b,this.placementInvertMatrix)},createPlacementMatrix:function(a){var b=533.333333333,c=32*b-a.pos.x,d=a.pos.y,e=32*b-a.pos.z,f=mat4.create();mat4.identity(f),mat4.rotateX(f,f,glMatrix.toRadian(90)),mat4.rotateY(f,f,glMatrix.toRadian(90)),mat4.translate(f,f,[c,d,e]),mat4.rotateY(f,f,glMatrix.toRadian(a.rotation.y-270)),mat4.rotateZ(f,f,glMatrix.toRadian(-a.rotation.x)),mat4.rotateX(f,f,glMatrix.toRadian(a.rotation.z-90)),mat4.scale(f,f,[a.scale/1024,a.scale/1024,a.scale/1024]);var g=mat4.create();mat4.invert(g,f),this.placementInvertMatrix=g,this.placementMatrix=f},calcOwnPosition:function(){var a=vec4.fromValues(0,0,0,1);vec4.transformMat4(a,a,this.placementMatrix),this.position=a},calcDistance:function(a){function b(a,b){var c=Math.max(a[0][0]-b[0],0,b[0]-a[1][0]),d=Math.max(a[0][1]-b[1],0,b[1]-a[1][1]),e=Math.max(a[0][2]-b[2],0,b[2]-a[1][2]);return Math.sqrt(c*c+d*d+e*e)}this.aabb&&(this.currentDistance=b(this.aabb,a))},getCurrentDistance:function(){return this.currentDistance},getDiameter:function(){return this.diameter},setIsRendered:function(a){this.isRendered=a},getIsRendered:function(){return this.isRendered},load:function(a){var b=this;return b.mddf=a,b.createPlacementMatrix(a),b.calcOwnPosition(),b.mdxObject.load(a.fileName,0)}},e}])}(window,jQuery),function(a,b,c){var d=angular.module("js.wow.render.adtObjectFactory",["js.wow.render.adtM2ObjectFactory"]);d.factory("adtObjectFactory",["$q","adtM2ObjectFactory",function(a,b){function c(a,b){this.sceneApi=a,this.m2Array=[]}return c.prototype={loadM2s:function(){var a=this.adtGeom.adtFile.mddf;if(a){this.m2Array=[];for(var b=0;b<a.length;b++){var c=a[b];this.sceneApi.objects.loadAdtM2Obj(c)}}},loadM2:function(a,c){var d=this;d.m2Array[a]=new b(d.sceneApi),d.m2Array[a].load(c,!1)},loadWmos:function(){var a=this,b=this.adtGeom.adtFile.wmoObjs;b&&(this.wmoArray=[],b.forEach(function(b){a.sceneApi.objects.loadAdtWmo(b)}))},load:function(a){var b=this,c=this.sceneApi.resources.loadAdtGeom(a);c.then(function(a){b.adtGeom=a,b.loadM2s(),b.loadWmos()})},draw:function(a){this.adtGeom&&this.adtGeom.draw()}},c}])}(window,jQuery),function(a,b,c){var d=angular.module("js.wow.render.wmoM2ObjectFactory",["js.wow.render.mdxObject"]);d.factory("wmoM2ObjectFactory",["mdxObject","$q","$timeout","mathHelper",function(a,b,c,d){function e(b){var c=this;c.sceneApi=b,c.mdxObject=new a(b),c.currentDistance=0,c.isRendered=!0,c.useLocalLighting=!0}return e.prototype={sceneApi:null,mdxObject:null,getFileNameIdent:function(){return this.mdxObject.fileIdent},getMeshesToRender:function(){return this.mdxObject?this.mdxObject.getMeshesToRender():null},checkFrustumCulling:function(a,b){var c=this.aabb&&this.mdxObject.checkFrustumCulling(a,b,this.aabb);this.setIsRendered(this.getIsRendered()&&c)},checkAgainstDepthBuffer:function(a,b,c){this.setIsRendered(this.getIsRendered()&&this.mdxObject.checkAgainstDepthBuffer(a,b,this.placementMatrix,c))},updateAABB:function(){var a=this.mdxObject.getBoundingBox();if(a){var b=vec4.fromValues(a.ab.x,a.ab.y,a.ab.z,1),c=vec4.fromValues(a.cd.x,a.cd.y,a.cd.z,1),e=d.transformAABBWithMat4(this.placementMatrix,[b,c]);this.diameter=vec3.distance(e[0],e[1]),this.aabb=e}},update:function(a,b){this.getIsRendered()&&this.mdxObject.update(a,b,this.placementInvertMatrix)},drawTransparentMeshes:function(){var a=this.useLocalLighting?this.diffuseColor:4294967295;this.mdxObject.drawTransparentMeshes(this.placementMatrix,a)},drawNonTransparentMeshes:function(){var a=this.useLocalLighting?this.diffuseColor:4294967295;this.mdxObject.drawNonTransparentMeshes(this.placementMatrix,a)},draw:function(){var a=this.useLocalLighting?this.diffuseColor:4294967295;this.mdxObject.draw(this.placementMatrix,a)},drawInstancedNonTransparentMeshes:function(a,b){var c=this.useLocalLighting?this.diffuseColor:4294967295;this.mdxObject.drawInstancedNonTransparentMeshes(a,b,c)},drawInstancedTransparentMeshes:function(a,b){var c=this.useLocalLighting?this.diffuseColor:4294967295;this.mdxObject.drawInstancedTransparentMeshes(a,b,c)},drawBB:function(){var a=this.sceneApi.getGlContext(),b=this.sceneApi.shaders.getShaderUniforms(),c=this.mdxObject.getBoundingBox();if(c){var d=c.ab,e=c.cd,f=[(d.x+e.x)/2,(d.y+e.y)/2,(d.z+e.z)/2],g=[e.x-f[0],e.y-f[1],e.z-f[2]];a.uniform3fv(b.uBBScale,new Float32Array(g)),a.uniform3fv(b.uBBCenter,new Float32Array(f)),a.uniform3fv(b.uColor,new Float32Array([.819607843,.058,.058])),a.uniformMatrix4fv(b.uPlacementMat,!1,this.placementMatrix),a.drawElements(a.LINES,48,a.UNSIGNED_SHORT,0)}},createPlacementMatrix:function(a,b){var c=mat4.create();mat4.identity(c),mat4.multiply(c,c,b),mat4.translate(c,c,[a.pos.x,a.pos.y,a.pos.z]);var d=mat4.create();mat4.fromQuat(d,[a.rotation.imag.x,a.rotation.imag.y,a.rotation.imag.z,a.rotation.real]),mat4.multiply(c,c,d),mat4.scale(c,c,[a.scale,a.scale,a.scale]);var e=mat4.create();mat4.invert(e,c),this.placementInvertMatrix=e,this.placementMatrix=c},calcOwnPosition:function(){var a=vec4.fromValues(0,0,0,1);vec4.transformMat4(a,a,this.placementMatrix),this.position=a},calcDistance:function(a){function b(a,b){var c=Math.max(a[0][0]-b[0],0,b[0]-a[1][0]),d=Math.max(a[0][1]-b[1],0,b[1]-a[1][1]),e=Math.max(a[0][2]-b[2],0,b[2]-a[1][2]);return Math.sqrt(c*c+d*d+e*e)}this.aabb&&(this.currentDistance=b(this.aabb,a))},setUseLocalLighting:function(a){this.useLocalLighting=a},getCurrentDistance:function(){return this.currentDistance},getDiameter:function(){return this.diameter},setIsRendered:function(a){this.isRendered=a},getIsRendered:function(){return this.isRendered},load:function(a,b,c){var d=this;return d.doodad=a,d.diffuseColor=a.color,d.createPlacementMatrix(a,b),d.calcOwnPosition(),d.mdxObject.load(a.modelName,0).then(function(){d.updateAABB()},function(){})}},e}])}(window,jQuery),function(a,b,c){var d=angular.module("js.wow.render.wmoObjectFactory",["js.wow.render.wmoM2ObjectFactory"]);d.factory("wmoObjectFactory",["$q","$timeout","wmoM2ObjectFactory","mathHelper",function(a,b,d,e){function f(a){var b=this;b.sceneApi=a,b.wmoGroupArray=[],b.doodadsArray=[],b.drawGroup=[],b.drawDoodads=[]}return f.prototype={getFileNameIdent:function(){return this.fileName},loadGeom:function(a,b){var c=this;return c.sceneApi.resources.loadWmoGeom(b).then(function(b){c.wmoGroupArray[a]=b,b.loadTextures(c.wmoObj.momt)},function(){})},checkIfUseLocalLighting:function(a){for(var b=null,c=0;c<this.wmoObj.nGroups;c++){var d=this.wmoObj.groupInfos[c],e=d.bb1,f=d.bb2;e.x<=a.x&&a.x<=f.x&&e.y<=a.y&&a.y<=f.y&&e.z<=a.z&&a.z<=f.z&&(b=d)}return b&&(8192&b.flags)>0?!0:!1},createWorldGroupBB:function(){for(var a=new Array(this.wmoGroupArray.length),b=new Array(this.wmoGroupArray.length),c=0;c<this.wmoGroupArray.length;c++){var d=this.wmoObj.groupInfos[c],f=d.bb1,g=d.bb2,h=vec4.fromValues(f.x,f.y,f.z,1),i=vec4.fromValues(g.x,g.y,g.z,1),j=e.transformAABBWithMat4(this.placementMatrix,[h,i]);a[c]=j,b[c]=j.slice(0)}this.worldGroupBorders=a,this.volumeWorldGroupBorders=b},updateWorldGroupBBWithM2:function(){var a=this.currentDoodadSet;if(a)for(var b=0;b<this.wmoGroupArray.length;b++)if(this.wmoGroupArray[b]){var c=this.wmoGroupArray[b].wmoGroupFile.doodadRefs,d=this.worldGroupBorders[b];if(c)for(var e=0;e<c.length;e++){var f=c[e];if(!(f-a.index<0||f>a.index+a.number-1)){var g=this.doodadsArray[f-a.index];(8&this.wmoObj.groupInfos[b].flags)>0&&g.setUseLocalLighting(!1),d[0]=vec3.fromValues(Math.min(g.aabb[0][0],d[0][0]),Math.min(g.aabb[0][1],d[0][1]),Math.min(g.aabb[0][2],d[0][2])),d[1]=vec3.fromValues(Math.max(g.aabb[1][0],d[1][0]),Math.max(g.aabb[1][1],d[1][1]),Math.max(g.aabb[1][2],d[1][2]))}}}},createPlacementMatrix:function(a){var b=533.333333333,c=32*b-a.pos.x,d=a.pos.y,e=32*b-a.pos.z,f=mat4.create();mat4.identity(f),mat4.rotateX(f,f,glMatrix.toRadian(90)),mat4.rotateY(f,f,glMatrix.toRadian(90)),mat4.translate(f,f,[c,d,e]),mat4.rotateY(f,f,glMatrix.toRadian(a.rotation.y-270)),mat4.rotateZ(f,f,glMatrix.toRadian(-a.rotation.x)),mat4.rotateX(f,f,glMatrix.toRadian(a.rotation.z-90));var g=mat4.create();mat4.invert(g,f),this.placementInvertMatrix=g,this.placementMatrix=f},loadDoodads:function(b){var c=this;if(c.wmoObj.modd){c.currentDoodadSet=c.wmoObj.mods[b];var d=c.wmoObj.mods[b],e=c.wmoObj.modd,f=new Array(d.number);this.doodadsArray=new Array(d.number);for(var g=0;g<d.number;g++){var h=e[d.index+g];f[g]=this.loadDoodad(g,h)}return a.all(f).then(function(a){for(var b=0;b<c.doodadsArray.length;b++)c.doodadsArray[b]=a[b]},function(){})}},loadDoodad:function(a,b){var c=this,d=c.sceneApi.objects.loadWmoM2Obj(b,c.placementMatrix,!1);return d},load:function(b){var c=a.defer(),d=this,e=b.fileName,f=b.doodadSet;this.fileName=e,d.createPlacementMatrix(b);var g=d.sceneApi.resources.loadWmoMain(e);return g.then(function(b){d.wmoObj=b,d.wmoGroupArray=new Array(b.nGroups),d.createPortalsVBO();for(var g=new Array(b.nGroups),h=e.substr(0,e.lastIndexOf(".")),i=0;i<b.nGroups;i++){for(var j=i.toString();3!=j.length;)j="0"+j;g[i]=d.loadGeom(i,h+"_"+j+".wmo")}var k=d.loadDoodads(f);d.createWorldGroupBB(),a.all(g.concat([k])).then(function(){d.updateWorldGroupBBWithM2()},function(){}),c.resolve(d)},function(){}),c.promise},drawBB:function(){var a=this.sceneApi.getGlContext(),b=this.sceneApi.shaders.getShaderUniforms(),d=mat4.create();mat4.identity(d),a.uniformMatrix4fv(b.uPlacementMat,!1,new Float32Array(d));for(var e=0;e<this.wmoGroupArray.length;e++)if(this.wmoGroupArray[e]&&this.wmoGroupArray[e].wmoGroupFile&&(this.drawGroup[e]||this.drawGroup[e]===c)){var f=this.volumeWorldGroupBorders[e][0],g=this.volumeWorldGroupBorders[e][1],h=[(f[0]+g[0])/2,(f[1]+g[1])/2,(f[2]+g[2])/2],i=[g[0]-h[0],g[1]-h[1],g[2]-h[2]];a.uniform3fv(b.uBBScale,new Float32Array(i)),a.uniform3fv(b.uBBCenter,new Float32Array(h)),a.uniform3fv(b.uColor,new Float32Array([.058,.058,.819607843])),a.drawElements(a.LINES,48,a.UNSIGNED_SHORT,0)}},setDoodadGroupDrawing:function(a,b){var c=(this.wmoObj.groupInfos[a],this.currentDoodadSet);if(c&&this.wmoGroupArray[a]){var d=this.wmoGroupArray[a].wmoGroupFile.doodadRefs;if(d)for(var e=0;e<d.length;e++){var f=d[e];if(!(f-c.index<0||f>c.index+c.number-1)){var g=this.doodadsArray[f-c.index];g&&g.setIsRendered(b)}}}},isInsideInterior:function(a){if(!this.wmoGroupArray||0==this.wmoGroupArray.length)return-1;var b=vec4.create();vec4.transformMat4(b,a,this.placementInvertMatrix);var c=b[0]>this.wmoObj.BoundBoxCorner1.x&&b[0]<this.wmoObj.BoundBoxCorner2.x&&b[1]>this.wmoObj.BoundBoxCorner1.y&&b[1]<this.wmoObj.BoundBoxCorner2.y&&b[2]>this.wmoObj.BoundBoxCorner1.z&&b[2]<this.wmoObj.BoundBoxCorner2.z;if(!c)return-1;for(var d=0,e=0,f=-1,g=0;g<this.wmoGroupArray.length;g++)if(this.wmoGroupArray[g]){var h=this.volumeWorldGroupBorders[g],i=this.wmoObj.groupInfos[g];if(0!=(8192&i.flags)){e++;var j=a[0]>h[0][0]&&a[0]<h[1][0]&&a[1]>h[0][1]&&a[1]<h[1][1]&&a[2]>h[0][2]&&a[2]<h[1][2];if(j){d++,f=g;for(var k=!0,l=this.wmoGroupArray[g].wmoGroupFile.mogp.moprIndex,m=this.wmoGroupArray[g].wmoGroupFile.mogp.numItems,n=l;l+m>n;n++){var o=this.wmoObj.portalRelations[n],p=this.wmoObj.portalInfos[o.portal_index],q=p.plane,r=vec4.dot(vec4.fromValues(q.x,q.y,q.z,q.w),b),s=o.side<0?0>r:r>0;k=k&&s}if(k){for(var t=0,u=this.wmoGroupArray[g].wmoGroupFile.nodes;t>=0&&0==(4&u[t].planeType);){0==u[t].planeType?t=b[0]<u[t].fDist?u[t].children1:u[t].children2:1==u[t].planeType?t=b[1]<u[t].fDist?u[t].children1:u[t].children2:2==u[t].planeType&&(t=b[2]<u[t].fDist?u[t].children1:u[t].children2)}return this.currentNodeId=t,this.currentGroupId=g,{groupId:g,nodeId:t}}}}}return 1==d&&e>1?f:(this.currentNodeId=-1,this.currentGroupId=-1,{groupId:-1,nodeId:-1})},resetDrawnForAllGroups:function(a){for(var b=0;b<this.wmoGroupArray.length;b++){var c=this.wmoObj.groupInfos[b];0!=(8192&c.flags)&&a?this.drawGroup[b]=!0:this.drawGroup[b]=a}},setIsRenderedForDoodads:function(){for(var a=0;a<this.wmoGroupArray.length;a++)this.drawDoodads[a]&&this.setDoodadGroupDrawing(a,this.drawDoodads[a])},checkFrustumCulling:function(a,b,c,d){if(this.worldGroupBorders){for(var f=0;f<this.doodadsArray.length;f++)this.doodadsArray[f]&&this.doodadsArray[f].setIsRendered(!1);for(var f=0;f<this.wmoGroupArray.length;f++)if(this.drawGroup[f]){var g=this.worldGroupBorders[f],h=a[0]>g[0][0]&&a[0]<g[1][0]&&a[1]>g[0][1]&&a[1]<g[1][1]&&a[2]>g[0][2]&&a[2]<g[1][2],i=h||e.checkFrustum(d,g),g=this.volumeWorldGroupBorders[f],h=a[0]>g[0][0]&&a[0]<g[1][0]&&a[1]>g[0][1]&&a[1]<g[1][1]&&a[2]>g[0][2]&&a[2]<g[1][2],j=h||e.checkFrustum(d,g);this.drawGroup[f]=j,this.drawDoodads[f]=i}}},update:function(){},draw:function(){var a=this.sceneApi.getGlContext(),b=this.sceneApi.shaders.getShaderUniforms();this.placementMatrix&&a.uniformMatrix4fv(b.uPlacementMat,!1,this.placementMatrix);for(var d=0;d<this.wmoGroupArray.length;d++)if(this.wmoGroupArray[d]){if(!this.drawGroup[d]&&this.drawGroup[d]!==c)continue;var e=this.currentGroupId==d?this.wmoGroupArray[d].wmoGroupFile.nodes[this.currentNodeId]:null;this.wmoGroupArray[d].draw(e)}},createPortalsVBO:function(){var a=this.sceneApi.getGlContext();if(0!=this.wmoObj.nPortals){this.vertexVBO=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,this.vertexVBO),a.bufferData(a.ARRAY_BUFFER,new Float32Array(this.wmoObj.portalVerticles),a.STATIC_DRAW),a.bindBuffer(a.ARRAY_BUFFER,null);for(var b=[],c=0;c<this.wmoObj.portalInfos.length;c++)for(var d=this.wmoObj.portalInfos[c],e=d.base_index,f=0;f<d.index_count-2;f++)b.push(e+0),b.push(e+f+1),b.push(e+f+2);this.indexVBO=a.createBuffer(),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.indexVBO),a.bufferData(a.ELEMENT_ARRAY_BUFFER,new Int16Array(b),a.STATIC_DRAW),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,null)}},drawPortals:function(){if(this.wmoObj&&0!=this.wmoObj.nPortals){var a=this.sceneApi.getGlContext(),b=this.sceneApi.shaders.getShaderUniforms(),c=this.sceneApi.shaders.getShaderAttributes();a.bindBuffer(a.ARRAY_BUFFER,this.vertexVBO),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.indexVBO),a.enable(a.BLEND),a.blendFunc(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA),a.vertexAttribPointer(c.aPosition,3,a.FLOAT,!1,0,0),this.placementMatrix&&a.uniformMatrix4fv(b.uPlacementMat,!1,this.placementMatrix),a.disable(a.CULL_FACE),a.depthMask(!1);for(var d=0,e=0;e<this.wmoObj.portalInfos.length;e++){var f=this.wmoObj.portalInfos[e];f.isFalse?a.uniform4fv(b.uColor,new Float32Array([.819607843,.058,.058,.3])):a.uniform4fv(b.uColor,new Float32Array([.058,.058,.819607843,.3])),a.drawElements(a.TRIANGLES,6,a.UNSIGNED_SHORT,2*d),d+=3*(f.index_count-2)}a.depthMask(!0),a.disable(a.BLEND)}},drawBspVerticles:function(){if(this.wmoObj){var a=this.sceneApi.getGlContext(),b=this.sceneApi.shaders.getShaderUniforms(),c=this.sceneApi.shaders.getShaderAttributes();if(this.currentGroupId>=0&&this.wmoGroupArray[this.currentGroupId]){var d=this.wmoGroupArray[this.currentGroupId].wmoGroupFile.nodes[this.currentNodeId];a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.wmoGroupArray[this.currentGroupId].mobrVBO),a.bindBuffer(a.ARRAY_BUFFER,this.wmoGroupArray[this.currentGroupId].combinedVBO),a.vertexAttribPointer(c.aPosition,3,a.FLOAT,!1,0,0),a.uniform4fv(b.uColor,new Float32Array([.819607843,.819607843,.058,0])),d&&a.drawElements(a.TRIANGLES,3*d.numFaces,a.UNSIGNED_SHORT,3*d.firstFace*2)}}}},f}])}(window,jQuery),function(a,b,c){var d=angular.module("js.wow.render.scene",["js.wow.render.geometry.wmoGeomCache","js.wow.render.geometry.wmoMainCache","js.wow.render.geometry.m2GeomCache","js.wow.render.geometry.skinGeomCache","js.wow.render.geometry.adtGeomCache","js.wow.render.wmoObjectFactory","js.wow.render.adtObjectFactory","js.wow.render.texture.textureCache","js.wow.render.camera.firstPersonCamera","js.wow.render.scene.graph"]);d.factory("scene",["$q","$timeout","$http","graphManager","wdtLoader","adtM2ObjectFactory","adtObjectFactory","wmoObjectFactory","wmoMainCache","wmoGeomCache","textureWoWCache","m2GeomCache","skinGeomCache","adtGeomCache","firstPersonCamera",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o){function p(a){var b=new Stats;b.setMode(1),b.domElement.style.position="absolute",b.domElement.style.left="0px",b.domElement.style.top="0px",document.body.appendChild(b.domElement),this.stats=b;var c=this;c.enableDeferred=!0,c.sceneObjectList=[],c.sceneAdts=[],c.initGlContext(a),c.initArrayInstancedExt(),c.initDepthTextureExt(),c.enableDeferred&&c.initDeferredRendering(),c.initRenderBuffers(),c.initAnisotropicExt(),c.initCompressedTextureS3tcExt(),c.initShaders().then(function(){c.isShadersLoaded=!0},function(){}),c.initSceneApi(),c.initSceneGraph(),c.createBlackPixelTexture(),c.initBoxVBO(),c.initCaches(),c.initCamera(a,document)}return p.prototype={instancing_ext:null,compileShader:function(a,b){var c=this.gl;this.enableDeferred&&(a="#define ENABLE_DEFERRED 1\r\n"+a,b="#define ENABLE_DEFERRED 1\r\n"+b);var d=c.createShader(c.VERTEX_SHADER);c.shaderSource(d,"#define COMPILING_VS 1\r\n "+a),c.compileShader(d);var e=c.getShaderParameter(d,c.COMPILE_STATUS);if(!e)throw"could not compile shader:"+c.getShaderInfoLog(d);var f=c.createShader(c.FRAGMENT_SHADER);c.shaderSource(f,"#define COMPILING_FS 1\r\n "+b),c.compileShader(f);var e=c.getShaderParameter(f,c.COMPILE_STATUS);if(!e)throw"could not compile shader:"+c.getShaderInfoLog(f);var g=c.createProgram();c.attachShader(g,d),c.attachShader(g,f),c.linkProgram(g);var e=c.getProgramParameter(g,c.LINK_STATUS);if(!e)throw"program filed to link:"+c.getProgramInfoLog(g);var h={};h.program=g;for(var i={},j=c.getProgramParameter(g,c.ACTIVE_ATTRIBUTES),k=0;j>k;++k){var l=c.getActiveAttrib(g,k);if(!l)break;var m=c.getAttribLocation(g,l.name);i[l.name]=m}h.shaderAttributes=i;for(var n={},o=c.getProgramParameter(g,c.ACTIVE_UNIFORMS),k=0;o>k;++k){var p=c.getActiveUniform(g,k);if(!p)break;var q=p.name;"[0]"===q.substr(-3)&&(q=q.substr(0,q.length-3));var r=c.getUniformLocation(g,q);n[q]=r}return h.shaderUniforms=n,h},createBlackPixelTexture:function(){var a=this.gl,b=a.createTexture();a.bindTexture(a.TEXTURE_2D,b),a.texImage2D(a.TEXTURE_2D,0,a.RGBA,1,1,0,a.RGBA,a.UNSIGNED_BYTE,new Uint8Array([255,255,255,255])),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.REPEAT),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.REPEAT),a.generateMipmap(a.TEXTURE_2D),a.bindTexture(a.TEXTURE_2D,null),this.blackPixelTexture=b},initGlContext:function(a){function b(a,b,c){throw WebGLDebugUtils.glEnumToString(a)+" was caused by call to: "+b}try{var c=a.getContext("webgl",{premultipliedAlpha:!1,alpha:!1})||a.getContext("experimental-webgl",{premultipliedAlpha:!1});c=WebGLDebugUtils.makeDebugContext(c,b)}catch(d){}c||(alert("Unable to initialize WebGL. Your browser may not support it."),c=null),this.gl=c,this.canvas=a},initArrayInstancedExt:function(){var a=this.gl,b=a.getExtension("ANGLE_instanced_arrays");b&&(this.instancing_ext=b)},initAnisotropicExt:function(){var a=this.gl,b=a.getExtension("EXT_texture_filter_anisotropic");b&&(this.anisotropic_ext=b)},initCompressedTextureS3tcExt:function(){var a=this.gl,b=a.getExtension("WEBGL_compressed_texture_s3tc")||a.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||a.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");b&&(this.comp_tex_ext=b)},initDepthTextureExt:function(){var a=this.gl,b=a.getExtension("WEBGL_depth_texture");b&&(this.depth_texture_ext=b)},initDeferredRendering:function(){var a=this.gl,b=a.getExtension("WEBGL_draw_buffers");b?this.wdb_ext=b:this.enableDeferred=!1},initShaders:function(){var b=this,d=null,e=[];return d=c.get("glsl/renderFrameBufferShader.glsl").then(function(a){var c=a.data,d=b.compileShader(c,c);b.renderFrameShader=d},function(){throw"could not load shader"}),e.push(d),d=c.get("glsl/drawDepthShader.glsl").then(function(a){var c=a.data,d=b.compileShader(c,c);b.drawDepthBuffer=d},function(){throw"could not load shader"}),e.push(d),d=c.get("glsl/readDepthBuffer.glsl").then(function(a){var c=a.data,d=b.compileShader(c,c);b.readDepthBuffer=d},function(){throw"could not load shader"}),e.push(d),d=c.get("glsl/WmoShader.glsl").then(function(a){var c=a.data,d=b.compileShader(c,c);b.wmoShader=d;var e=b.compileShader("#define INSTANCED 1\r\n "+c,"#define INSTANCED 1\r\n "+c);b.wmoInstancingShader=e},function(){throw"could not load shader"}),e.push(d),d=c.get("glsl/m2Shader.glsl").then(function(a){var c=a.data,d=b.compileShader(c,c);b.m2Shader=d;var e=b.compileShader("#define INSTANCED 1\r\n "+c,"#define INSTANCED 1\r\n "+c);b.m2InstancingShader=e},function(){throw"could not load shader"}),e.push(d),d=c.get("glsl/drawBBShader.glsl").then(function(a){var c=a.data,d=b.compileShader(c,c);b.bbShader=d},function(){throw"could not load shader"}),e.push(d),d=c.get("glsl/adtShader.glsl").then(function(a){var c=a.data,d=b.compileShader(c,c);b.adtShader=d},function(){throw"could not load shader"}),e.push(d),d=c.get("glsl/drawPortalShader.glsl").then(function(a){var c=a.data,d=b.compileShader(c,c);b.drawPortalShader=d},function(){throw"could not load shader"}),e.push(d),a.all(e)},initCaches:function(){this.wmoGeomCache=new j(this.sceneApi),this.wmoMainCache=new i(this.sceneApi),this.textureCache=new k(this.sceneApi),this.m2GeomCache=new l(this.sceneApi),this.skinGeomCache=new m(this.sceneApi),this.adtGeomCache=new n(this.sceneApi)},initDrawBuffers:function(a){var b=this.gl,c=this.wdb_ext;this.texture_floatExt=b.getExtension("OES_texture_float"),this.texture_floatLinExt=b.getExtension("OES_texture_float_linear");var d=b.createTexture(),e=b.createTexture(),f=b.createTexture(),g=b.createTexture();b.bindTexture(b.TEXTURE_2D,d),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.CLAMP_TO_EDGE),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.CLAMP_TO_EDGE),b.texImage2D(b.TEXTURE_2D,0,b.RGBA,this.canvas.width,this.canvas.height,0,b.RGBA,b.FLOAT,null),b.bindTexture(b.TEXTURE_2D,e),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.CLAMP_TO_EDGE),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.CLAMP_TO_EDGE),b.texImage2D(b.TEXTURE_2D,0,b.RGBA,this.canvas.width,this.canvas.height,0,b.RGBA,b.FLOAT,null),b.bindTexture(b.TEXTURE_2D,f),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.CLAMP_TO_EDGE),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.CLAMP_TO_EDGE),b.texImage2D(b.TEXTURE_2D,0,b.RGBA,this.canvas.width,this.canvas.height,0,b.RGBA,b.FLOAT,null),b.bindTexture(b.TEXTURE_2D,g),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.CLAMP_TO_EDGE),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.CLAMP_TO_EDGE),b.texImage2D(b.TEXTURE_2D,0,b.RGBA,this.canvas.width,this.canvas.height,0,b.RGBA,b.FLOAT,null),b.bindFramebuffer(b.FRAMEBUFFER,a);var h=[];h[0]=c.COLOR_ATTACHMENT0_WEBGL,h[1]=c.COLOR_ATTACHMENT1_WEBGL,h[2]=c.COLOR_ATTACHMENT2_WEBGL,h[3]=c.COLOR_ATTACHMENT3_WEBGL,c.drawBuffersWEBGL(h),b.framebufferTexture2D(b.FRAMEBUFFER,h[0],b.TEXTURE_2D,g,0),b.framebufferTexture2D(b.FRAMEBUFFER,h[1],b.TEXTURE_2D,d,0),b.framebufferTexture2D(b.FRAMEBUFFER,h[2],b.TEXTURE_2D,e,0),b.framebufferTexture2D(b.FRAMEBUFFER,h[3],b.TEXTURE_2D,f,0),this.depthRGBTexture=g,this.normalTexture=d,this.positionTexture=e,this.colorTexture=f},initRenderBuffers:function(){var a=this.gl;if(this.depth_texture_ext){var b=a.createTexture();a.bindTexture(a.TEXTURE_2D,b),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),a.texImage2D(a.TEXTURE_2D,0,a.RGBA,this.canvas.width,this.canvas.height,0,a.RGBA,a.UNSIGNED_BYTE,null);var c=a.createTexture();a.bindTexture(a.TEXTURE_2D,c),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),a.texImage2D(a.TEXTURE_2D,0,a.DEPTH_COMPONENT,this.canvas.width,this.canvas.height,0,a.DEPTH_COMPONENT,a.UNSIGNED_INT,null);var d=a.createFramebuffer();this.enableDeferred&&this.initDrawBuffers(d),a.bindFramebuffer(a.FRAMEBUFFER,d),this.enableDeferred||a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,b,0),a.framebufferTexture2D(a.FRAMEBUFFER,a.DEPTH_ATTACHMENT,a.TEXTURE_2D,c,0),this.frameBuffer=d,this.frameBufferColorTexture=b,this.frameBufferDepthTexture=c;var e=[1,1,-1,1,-1,-1,1,1,-1,-1,1,-1],f=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,f),a.bufferData(a.ARRAY_BUFFER,new Float32Array(e),a.STATIC_DRAW),this.vertBuffer=f}},initSceneGraph:function(){this.graphManager=new d(this.sceneApi)},initSceneApi:function(){var a=this;this.sceneApi={getGlContext:function(){return a.gl},getCurrentWdt:function(){return a.currentWdt},getBlackPixelTexture:function(){return a.blackPixelTexture},extensions:{getInstancingExt:function(){return a.instancing_ext},getAnisotropicExt:function(){return a.anisotropic_ext},getComprTextExt:function(){return a.comp_tex_ext}},shaders:{activateBoundingBoxShader:function(){a.activateBoundingBoxShader()},deativateBoundingBoxShader:function(){a.deactivateBoundingBoxShader()},activateAdtShader:function(){a.activateAdtShader()},activateDrawPortalShader:function(){a.activateDrawPortalShader()},activateWMOShader:function(){a.activateWMOShader()},deactivateWMOShader:function(){a.deactivateWMOShader()},activateM2Shader:function(){a.activateM2Shader()},deactivateM2Shader:function(){a.deactivateM2Shader()},activateM2InstancingShader:function(){a.activateM2InstancingShader()},deactivateM2InstancingShader:function(){a.deactivateM2InstancingShader()},getShaderUniforms:function(){return a.currentShaderProgram.shaderUniforms},getShaderAttributes:function(){return a.currentShaderProgram.shaderAttributes}},objects:{loadAdtM2Obj:function(b){return a.graphManager.addAdtM2Object(b)},loadAdtWmo:function(b){return a.graphManager.addWmoObject(b)},loadWmoM2Obj:function(b,c,d){return a.graphManager.addWmoM2Object(b,c,d)},loadAdtChunk:function(b){return a.graphManager.addADTObject(b)}},resources:{loadTexture:function(b){return a.textureCache.loadTexture(b)},unLoadTexture:function(b){a.textureCache.unLoadTexture(b)},loadWmoMain:function(b){return a.wmoMainCache.loadWmoMain(b)},unloadWmoMain:function(b){a.wmoMainCache.unloadWmoMain(b)},loadWmoGeom:function(b){return a.wmoGeomCache.loadWmoGeom(b)},unloadWmoGeom:function(b){a.wmoGeomCache.unLoadWmoGeom(b)},loadM2Geom:function(b){return a.m2GeomCache.loadM2(b)},unloadM2Geom:function(b){a.m2GeomCache.unLoadM2(b)},loadSkinGeom:function(b){return a.skinGeomCache.loadSkin(b)},unloadSkinGeom:function(b){a.skinGeomCache.unLoadSkin(b)},loadAdtGeom:function(b){return a.adtGeomCache.loadAdt(b)},unloadAdtGeom:function(b){a.adtGeomCache.unLoadAdt(b)}}}},initCamera:function(a,b){this.camera=o(a,b)},initBoxVBO:function(){var a=this.gl,b=[-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,-1,1,1,1,1,1,1,1,-1,-1,1,-1],c=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,c),a.bufferData(a.ARRAY_BUFFER,new Float32Array(b),a.STATIC_DRAW),a.bindBuffer(a.ARRAY_BUFFER,null);var d=[0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,7,6,6,1,1,0,0,7,3,2,2,5,5,4,4,3,6,5,5,2,2,1,1,6,0,3,3,4,4,7,7,0],e=a.createBuffer();a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,e),a.bufferData(a.ELEMENT_ARRAY_BUFFER,new Int16Array(d),a.STATIC_DRAW),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,null),this.bbBoxVars={vbo_vertices:c,ibo_elements:e}},glClearScreen:function(a){a.clearDepth(1),a.enable(a.DEPTH_TEST),a.depthFunc(a.LESS),a.disable(a.BLEND),a.clearColor(.6,.95,1,1),a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT),a.disable(a.CULL_FACE)},activateRenderFrameShader:function(){if(this.currentShaderProgram=this.renderFrameShader,this.currentShaderProgram){var a=this.gl;a.useProgram(this.currentShaderProgram.program);this.sceneApi.shaders.getShaderAttributes();a.activeTexture(a.TEXTURE0)}},activateRenderDepthShader:function(){if(this.currentShaderProgram=this.drawDepthBuffer,this.currentShaderProgram){var a=this.gl;a.useProgram(this.currentShaderProgram.program);this.sceneApi.shaders.getShaderAttributes();a.activeTexture(a.TEXTURE0)}},activateReadDepthBuffer:function(){if(this.currentShaderProgram=this.readDepthBuffer,this.currentShaderProgram){var a=this.gl;a.useProgram(this.currentShaderProgram.program);this.sceneApi.shaders.getShaderAttributes();a.activeTexture(a.TEXTURE0),a.enableVertexAttribArray(this.currentShaderProgram.shaderAttributes.position),a.enableVertexAttribArray(this.currentShaderProgram.shaderAttributes.texture),a.uniform1i(this.currentShaderProgram.shaderUniforms.diffuse,0)}},activateAdtShader:function(){if(this.currentShaderProgram=this.adtShader,this.currentShaderProgram){var a=this.gl,b=(this.sceneApi.extensions.getInstancingExt(),this.sceneApi.shaders.getShaderAttributes());a.useProgram(this.currentShaderProgram.program),a.enableVertexAttribArray(b.aHeight),a.enableVertexAttribArray(b.aIndex),a.uniformMatrix4fv(this.currentShaderProgram.shaderUniforms.uLookAtMat,!1,this.lookAtMat4),a.uniformMatrix4fv(this.currentShaderProgram.shaderUniforms.uPMatrix,!1,this.perspectiveMatrix),this.currentWdt&&(4&this.currentWdt.flags)>0?a.uniform1i(this.currentShaderProgram.shaderUniforms.uNewFormula,1):a.uniform1i(this.currentShaderProgram.shaderUniforms.uNewFormula,0),a.uniform1i(this.currentShaderProgram.shaderUniforms.uLayer0,0),a.uniform1i(this.currentShaderProgram.shaderUniforms.uAlphaTexture,1),a.uniform1i(this.currentShaderProgram.shaderUniforms.uLayer1,2),a.uniform1i(this.currentShaderProgram.shaderUniforms.uLayer2,3),a.uniform1i(this.currentShaderProgram.shaderUniforms.uLayer3,4)}},activateWMOShader:function(){if(this.currentShaderProgram=this.wmoShader,this.currentShaderProgram){var a=this.gl;a.useProgram(this.currentShaderProgram.program);var b=this.sceneApi.shaders.getShaderAttributes();a.enableVertexAttribArray(b.aPosition),b.aNormal&&a.enableVertexAttribArray(b.aNormal),a.enableVertexAttribArray(b.aTexCoord),a.enableVertexAttribArray(b.aTexCoord2),a.enableVertexAttribArray(b.aColor),a.enableVertexAttribArray(b.aColor2),a.uniformMatrix4fv(this.currentShaderProgram.shaderUniforms.uLookAtMat,!1,this.lookAtMat4),a.uniformMatrix4fv(this.currentShaderProgram.shaderUniforms.uPMatrix,!1,this.perspectiveMatrix),a.uniform1i(this.currentShaderProgram.shaderUniforms.uTexture,0),a.uniform1i(this.currentShaderProgram.shaderUniforms.uTexture2,1),a.activeTexture(a.TEXTURE0)}},deactivateWMOShader:function(){var a=this.gl,b=(this.sceneApi.extensions.getInstancingExt(),this.sceneApi.shaders.getShaderAttributes());b.aNormal&&a.disableVertexAttribArray(b.aNormal),a.disableVertexAttribArray(b.aTexCoord),a.disableVertexAttribArray(b.aTexCoord2),a.disableVertexAttribArray(b.aColor),a.disableVertexAttribArray(b.aColor2)},activateM2Shader:function(){if(this.currentShaderProgram=this.m2Shader,this.currentShaderProgram){var a=this.gl;a.useProgram(this.currentShaderProgram.program);var b=this.sceneApi.shaders.getShaderAttributes();
a.enableVertexAttribArray(b.aPosition),b.aNormal&&a.enableVertexAttribArray(b.aNormal),a.enableVertexAttribArray(b.boneWeights),a.enableVertexAttribArray(b.bones),a.enableVertexAttribArray(b.aTexCoord),a.enableVertexAttribArray(b.aTexCoord2),a.disableVertexAttribArray(b.aColor),a.uniformMatrix4fv(this.currentShaderProgram.shaderUniforms.uLookAtMat,!1,this.lookAtMat4),a.uniformMatrix4fv(this.currentShaderProgram.shaderUniforms.uPMatrix,!1,this.perspectiveMatrix),a.uniform1i(this.currentShaderProgram.shaderUniforms.isBillboard,0),a.uniform1i(this.currentShaderProgram.shaderUniforms.uTexture,0),a.uniform1i(this.currentShaderProgram.shaderUniforms.uTexture2,1),a.activeTexture(a.TEXTURE0)}},deactivateM2Shader:function(){var a=this.gl,b=(this.sceneApi.extensions.getInstancingExt(),this.sceneApi.shaders.getShaderAttributes());b.aNormal&&a.disableVertexAttribArray(b.aNormal),a.disableVertexAttribArray(b.boneWeights),a.disableVertexAttribArray(b.bones),a.disableVertexAttribArray(b.aTexCoord),a.disableVertexAttribArray(b.aTexCoord2)},activateM2InstancingShader:function(){if(this.currentShaderProgram=this.m2InstancingShader,this.currentShaderProgram){var a=this.gl,b=this.sceneApi.extensions.getInstancingExt(),c=this.sceneApi.shaders.getShaderAttributes();a.useProgram(this.currentShaderProgram.program),a.uniformMatrix4fv(this.currentShaderProgram.shaderUniforms.uLookAtMat,!1,this.lookAtMat4),a.uniformMatrix4fv(this.currentShaderProgram.shaderUniforms.uPMatrix,!1,this.perspectiveMatrix),a.activeTexture(a.TEXTURE0),a.enableVertexAttribArray(c.aPosition),c.aNormal&&a.enableVertexAttribArray(c.aNormal),a.enableVertexAttribArray(c.boneWeights),a.enableVertexAttribArray(c.bones),a.enableVertexAttribArray(c.aTexCoord),a.enableVertexAttribArray(c.aTexCoord2),a.disableVertexAttribArray(c.aColor),a.enableVertexAttribArray(c.uPlacementMat+0),a.enableVertexAttribArray(c.uPlacementMat+1),a.enableVertexAttribArray(c.uPlacementMat+2),a.enableVertexAttribArray(c.uPlacementMat+3),null!=b&&(b.vertexAttribDivisorANGLE(c.uPlacementMat+0,1),b.vertexAttribDivisorANGLE(c.uPlacementMat+1,1),b.vertexAttribDivisorANGLE(c.uPlacementMat+2,1),b.vertexAttribDivisorANGLE(c.uPlacementMat+3,1))}},deactivateM2InstancingShader:function(){var a=this.gl,b=this.sceneApi.extensions.getInstancingExt(),c=this.sceneApi.shaders.getShaderAttributes();c.aNormal&&a.disableVertexAttribArray(c.aNormal),a.disableVertexAttribArray(c.boneWeights),a.disableVertexAttribArray(c.bones),a.disableVertexAttribArray(c.aTexCoord),a.disableVertexAttribArray(c.aTexCoord2),b&&(b.vertexAttribDivisorANGLE(c.uPlacementMat+0,0),b.vertexAttribDivisorANGLE(c.uPlacementMat+1,0),b.vertexAttribDivisorANGLE(c.uPlacementMat+2,0),b.vertexAttribDivisorANGLE(c.uPlacementMat+3,0)),a.disableVertexAttribArray(c.uPlacementMat+0),a.disableVertexAttribArray(c.uPlacementMat+1),a.disableVertexAttribArray(c.uPlacementMat+2),a.disableVertexAttribArray(c.uPlacementMat+3)},activateBoundingBoxShader:function(){if(this.currentShaderProgram=this.bbShader,this.currentShaderProgram){var a=this.gl;a.useProgram(this.currentShaderProgram.program),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.bbBoxVars.ibo_elements),a.bindBuffer(a.ARRAY_BUFFER,this.bbBoxVars.vbo_vertices),a.vertexAttribPointer(this.currentShaderProgram.shaderAttributes.aPosition,3,a.FLOAT,!1,0,0),a.uniformMatrix4fv(this.currentShaderProgram.shaderUniforms.uLookAtMat,!1,this.lookAtMat4),a.uniformMatrix4fv(this.currentShaderProgram.shaderUniforms.uPMatrix,!1,this.perspectiveMatrix)}},activateDrawPortalShader:function(){if(this.currentShaderProgram=this.drawPortalShader,this.currentShaderProgram){var a=this.gl;a.useProgram(this.currentShaderProgram.program),a.uniformMatrix4fv(this.currentShaderProgram.shaderUniforms.uLookAtMat,!1,this.lookAtMat4),a.uniformMatrix4fv(this.currentShaderProgram.shaderUniforms.uPMatrix,!1,this.perspectiveMatrix)}},drawTexturedQuad:function(a,b,c,d,e,f,g,h){if(!this.quadShader){var i=[-1,1,0,1,-1,-1,0,0,1,1,1,1,-1,-1,0,0,1,-1,1,0,1,1,1,1];this.quadVertBuffer=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,this.quadVertBuffer),a.bufferData(a.ARRAY_BUFFER,new Float32Array(i),a.STATIC_DRAW)}a.disable(a.DEPTH_TEST),a.bindBuffer(a.ARRAY_BUFFER,this.quadVertBuffer),a.vertexAttribPointer(this.drawDepthBuffer.shaderAttributes.position,2,a.FLOAT,!1,16,0),a.vertexAttribPointer(this.drawDepthBuffer.shaderAttributes.texture,2,a.FLOAT,!1,16,8),a.uniform1f(this.drawDepthBuffer.shaderUniforms.uWidth,e/g),a.uniform1f(this.drawDepthBuffer.shaderUniforms.uHeight,f/h),a.uniform1f(this.drawDepthBuffer.shaderUniforms.uX,c/g),a.uniform1f(this.drawDepthBuffer.shaderUniforms.uY,d/h),a.bindTexture(a.TEXTURE_2D,b),a.drawArrays(a.TRIANGLES,0,6),a.enable(a.DEPTH_TEST)},drawFrameBuffer:function(){var a=this.gl;this.enableDeferred?a.bindTexture(a.TEXTURE_2D,this.colorTexture):a.bindTexture(a.TEXTURE_2D,this.frameBufferColorTexture),a.bindBuffer(a.ARRAY_BUFFER,this.vertBuffer),a.vertexAttribPointer(0,2,a.FLOAT,!1,0,0),a.drawArrays(a.TRIANGLES,0,6)},draw:function(a){var b=this.gl;if(!this.depthBuffer){var c=new Uint8Array(this.canvas.width*this.canvas.height*4);this.depthBuffer=c}this.stats.begin(),b.bindFramebuffer(b.FRAMEBUFFER,this.frameBuffer);var d=this.camera.tick(a),e=[];mat4.lookAt(e,d.cameraVec3,d.lookAtVec3,[0,0,1]);var f=[];mat4.lookAt(f,[-1873.050857362244,5083.140737452966,574.1095576120073],[-1872.9643854413891,5083.406870660209,573.1495077576213],[0,0,1]);var g=[];if(mat4.perspective(g,45,this.canvas.width/this.canvas.height,1,1e3),this.graphManager.checkCulling(g,e),this.perspectiveMatrix&&this.lookAtMat4,this.perspectiveMatrix=g,d.staticCamera?this.lookAtMat4=f:this.lookAtMat4=e,this.isShadersLoaded){this.glClearScreen(b),b.activeTexture(b.TEXTURE0),this.graphManager.setCameraPos(vec4.fromValues(d.cameraVec3[0],d.cameraVec3[1],d.cameraVec3[2],1)),this.graphManager.setLookAtMat(e);var h=this.graphManager.update(a);return b.depthMask(!0),this.graphManager.draw(),b.bindFramebuffer(b.FRAMEBUFFER,null),this.glClearScreen(b),this.activateReadDepthBuffer(),b.disable(b.DEPTH_TEST),this.activateRenderFrameShader(),this.drawFrameBuffer(),this.activateRenderDepthShader(),this.drawTexturedQuad(b,this.frameBufferDepthTexture,.75*this.canvas.width,0,.25*this.canvas.width,.25*this.canvas.height,this.canvas.width,this.canvas.height),b.enable(b.DEPTH_TEST),this.stats.end(),{cameraVecs:d,updateResult:h}}},loadM2File:function(a){this.sceneApi.objects.loadAdtM2Obj(a)},loadWMOFile:function(a){this.sceneApi.objects.loadAdtWmo(a)},loadMap:function(a,b,c){var d=this,f="world/maps/"+a+"/"+a+".wdt";e(f).then(function(e){if(d.currentWdt=e,e.isWMOMap)d.sceneApi.objects.loadAdtWmo(e.modfChunk);else{var f="world/maps/"+a+"/"+a+"_"+b+"_"+c+".adt";d.graphManager.addADTObject(f)}},function(){})},setCameraPos:function(a,b,c){this.camera.setCameraPos(a,b,c)}},p}])}(window,jQuery),function(a,b,c){function d(a){this.sceneApi=a,this.texture=null,this.loadFromMipmaps=function(a,b){var d=this.sceneApi.getGlContext(),e=this.sceneApi.extensions.getAnisotropicExt(),f=this.sceneApi.extensions.getComprTextExt();this.texture=d.createTexture(),d.bindTexture(d.TEXTURE_2D,this.texture);var g=null;if(f)switch(b){case"S3TC_RGB_DXT1":g=f.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case"S3TC_RGBA_DXT1":g=f.COMPRESSED_RGBA_S3TC_DXT1_EXT;break;case"S3TC_RGBA_DXT3":g=f.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case"S3TC_RGBA_DXT5":g=f.COMPRESSED_RGBA_S3TC_DXT5_EXT}var h=!(f!=c&&f.COMPRESSED_RGB_S3TC_DXT1_EXT!=c&&f!=c&&f.COMPRESSED_RGBA_S3TC_DXT1_EXT!=c),i=!(f!=c&&f.COMPRESSED_RGBA_S3TC_DXT3_EXT!=c),j=!(f!=c&&f.COMPRESSED_RGBA_S3TC_DXT5_EXT!=c);h=h||("S3TC_RGB_DXT1"===b||"S3TC_RGBA_DXT1"===b)&&a[0].width!==a[0].height;switch(b){case"S3TC_RGB_DXT1":case"S3TC_RGBA_DXT1":for(var k=0;k<a.length;k++)if(h){var l=dxtLib.decodeDXT1toBitmap32(a[k].texture,a[k].width,a[k].height);d.texImage2D(d.TEXTURE_2D,k,d.RGBA,a[k].width,a[k].height,0,d.RGBA,d.UNSIGNED_BYTE,l.decData)}else d.compressedTexImage2D(d.TEXTURE_2D,k,g,a[k].width,a[k].height,0,a[k].texture);break;case"S3TC_RGBA_DXT3":for(var k=0;k<a.length;k++)if(i){var l=dxtLib.decodeDXT3toBitmap32(a[k].texture,a[k].width,a[k].height);d.texImage2D(d.TEXTURE_2D,k,d.RGBA,a[k].width,a[k].height,0,d.RGBA,d.UNSIGNED_BYTE,l.decData)}else d.compressedTexImage2D(d.TEXTURE_2D,k,g,a[k].width,a[k].height,0,a[k].texture);break;case"S3TC_RGBA_DXT5":for(var k=0;k<a.length;k++)if(j){var l=dxtLib.decodeDXT5toBitmap32(a[k].texture,a[k].width,a[k].height);d.texImage2D(d.TEXTURE_2D,k,d.RGBA,a[k].width,a[k].height,0,d.RGBA,d.UNSIGNED_BYTE,l.decData)}else d.compressedTexImage2D(d.TEXTURE_2D,k,g,a[k].width,a[k].height,0,a[k].texture);break;case"BGRA":for(var k=0;k<a.length;k++)d.texImage2D(d.TEXTURE_2D,0,d.RGBA,a[k].width,a[k].height,0,d.RGBA,d.UNSIGNED_BYTE,a[k].texture)}if(d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,d.LINEAR_MIPMAP_LINEAR),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,d.LINEAR),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,d.REPEAT),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,d.REPEAT),e){var m=d.getParameter(e.MAX_TEXTURE_MAX_ANISOTROPY_EXT);d.texParameterf(d.TEXTURE_2D,e.TEXTURE_MAX_ANISOTROPY_EXT,m)}d.bindTexture(d.TEXTURE_2D,null)},this.destroy=function(){var a=this.gl;this.texture&&a.deleteTexture(this.texture),this.texture=null}}var e=angular.module("js.wow.render.texture.textureCache",["main.services.map.blpLoader","js.wow.render.cacheTemplate"]);e.factory("textureWoWCache",["blpLoader","cacheTemplate","$q",function(a,b,c){function e(c){var e=this,f=b(function(b){return a(b)},function(a){var b=new d(c);return b.loadFromMipmaps(a.mipmaps,a.textureFormat),b.fileName=a.fileName,b});e.loadTexture=function(a){var b=a.toLowerCase();return f.get(b)},e.unLoadTexture=function(a){f.remove(a)}}return e}])}(window,jQuery);
//# sourceMappingURL=application.min.js.map